# ëª©ì°¨

<br>

- [ëª©ì°¨](#ëª©ì°¨)
- [ë“¤ì–´ê°€ë©°](#ë“¤ì–´ê°€ë©°)
- [0) í…ŒìŠ¤íŠ¸ í™˜ê²½](#0-í…ŒìŠ¤íŠ¸-í™˜ê²½)
- [1) N + 1 ë¬¸ì œë€?](#1-n--1-ë¬¸ì œë€)
- [2) N + 1 ë¬¸ì œ í•´ê²° ë°©ë²•](#2-n--1-ë¬¸ì œ-í•´ê²°-ë°©ë²•)
  - [2-1) Join Fetch](#2-1-join-fetch)
  - [2-2) @EntityGraph](#2-2-entitygraph)
- [3) ë°ì´í„° ë»¥íŠ€ê¸° ë¬¸ì œ](#3-ë°ì´í„°-ë»¥íŠ€ê¸°-ë¬¸ì œ)
- [4) ë°ì´í„° ë»¥íŠ€ê¸° ë¬¸ì œ í•´ê²° ë°©ë²•](#4-ë°ì´í„°-ë»¥íŠ€ê¸°-ë¬¸ì œ-í•´ê²°-ë°©ë²•)
  - [4-1) Set](#4-1-set)
  - [4-2) DISTINCT](#4-2-distinct)
  - [4-3) ë°ì´í„° ë»¥íŠ€ê¸° ë¬¸ì œëŠ” ì¼ëŒ€ë‹¤ ìƒí™©ì—ì„œë§Œ ë°œìƒí•œë‹¤](#4-3-ë°ì´í„°-ë»¥íŠ€ê¸°-ë¬¸ì œëŠ”-ì¼ëŒ€ë‹¤-ìƒí™©ì—ì„œë§Œ-ë°œìƒí•œë‹¤)
- [5) Join Fetch vs @EntityGraph](#5-join-fetch-vs-entitygraph)
- [ë²ˆì™¸ - ì—¬ëŸ¬ ë‹¨ê³„ë¡œ Fetch Joinì„ í•´ì•¼í•˜ëŠ” ê²½ìš°](#ë²ˆì™¸---ì—¬ëŸ¬-ë‹¨ê³„ë¡œ-fetch-joinì„-í•´ì•¼í•˜ëŠ”-ê²½ìš°)
  - [Fetch Join ë³„ì¹­ì„ ì´ìš©í•œ ì—¬ëŸ¬ë²ˆ ì‚¬ìš©](#fetch-join-ë³„ì¹­ì„-ì´ìš©í•œ-ì—¬ëŸ¬ë²ˆ-ì‚¬ìš©)
  - [batch_size](#batch_size)
- [ë§ˆì¹˜ë©°](#ë§ˆì¹˜ë©°)

<br>

# ë“¤ì–´ê°€ë©°
ê³„ì† ë¯¸ë£¨ë‹¤ ì´ì œì•¼ ì •ë¦¬í•˜ê²Œë˜ì—ˆë‹¤. 

ì´ë²ˆ ê¸€ì€ JPAë¥¼ ì‚¬ìš©í•˜ë‹¤ë³´ë©´ ê¼­ í•œë²ˆ ì¯¤ì€ ë§ˆì£¼í•˜ê²Œ ë˜ëŠ” N + 1 ë¬¸ì œì— ëŒ€í•´ ì‰½ê²Œ ì •ë¦¬í•œ ê¸€ì´ë‹¤. 

í•„ìê°€ ìƒê°í•˜ê¸°ì—” ì‰½ê²Œ ì„¤ëª…í•œ ê²ƒ ê°™ë‹¤.. :)

ê°œì¸ì ìœ¼ë¡œ ì§ì ‘ ì½”ë“œë¥¼ ë”°ë¼ ì‘ì„±í•˜ë©´ì„œ ì½ëŠ” ê²ƒì„ ì¶”ì²œí•œë‹¤. (N + 1ì€ ë”ë”ìš± ì§ì ‘ ì½”ë“œë¥¼ ì‘ì„±í•˜ì§€ ì•Šìœ¼ë©´ ì´í•´í•˜ê¸° ì–´ë µë‹¤ê³  ìƒê°ë“ ë‹¤.)

> ëª¨ë“  ì†ŒìŠ¤ ì½”ë“œëŠ” [ì—¬ê¸°](https://github.com/binghe819/learning-sandbox/tree/master/jpa-n-plus-1-basic)ë¥¼ ì°¸ê³ í•˜ë©´ ëœë‹¤.

<br>

# 0) í…ŒìŠ¤íŠ¸ í™˜ê²½
ì´ë²ˆ ê¸€ì€ í•™ìŠµ í…ŒìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ëœ ê¸€ì´ë‹¤.

ë³¸ê²©ì ìœ¼ë¡œ N + 1 ë¬¸ì œì— ëŒ€í•´ ë‹¤ë£¨ê¸° ì „ì— í•™ìŠµ í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ì„ ë§Œë“¤ì–´ë³¸ë‹¤.

<br>

**ì˜ì¡´ì„±**

* Spring Boot 2.6.1
* Spring Data JPA 2.6.1
* Lombok

<br>

**í…ŒìŠ¤íŠ¸ ë„ë©”ì¸ ì„¤ê³„**

í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©ë  ë„ë©”ì¸ì€ ì•„ë˜ì™€ ê°™ì´ ê°„ë‹¨íˆ ì„¤ê³„í–ˆë‹¤.

<p align="center"><img src="./image/domain_structure.png" width="500"> </p>

**ì½”ë“œë¡œ ìœ„ ì„¤ê³„ë¥¼ í‘œí˜„í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤. ëª¨ë“  ì—°ê´€ê´€ê³„ëŠ” LAZY Loadingë˜ë„ë¡ í•˜ì˜€ë‹¤.**

> ëª¨ë“  ì—°ê´€ê´€ê³„ëŠ” N : 1 ì–‘ë±¡í–¥ìœ¼ë¡œ ì„¤ì •.

<br>

> Post.java

```java
@NoArgsConstructor
@Getter
@Entity
public class Post {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String title;

    private String content;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User writer;

    @OneToMany(mappedBy = "post", fetch = FetchType.LAZY, cascade = CascadeType.PERSIST)
    private List<Comment> comments = new ArrayList<>();

    @Builder
    public Post(String title, String content, User writer, List<Comment> comments) {
        this.title = title;
        this.content = content;
        this.writer = writer;
        if (Objects.nonNull(comments)) {
            this.comments = comments;
        }
    }

    public void addComment(Comment comment) {
        this.comments.add(comment);
        comment.updatePost(this);
    }
}
```

<br>

> Comment.java

```java
@NoArgsConstructor
@Getter
@Entity
public class Comment {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String content;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id", nullable = false)
    private User writer;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "post_id", nullable = false)
    private Post post;

    @Builder
    public Comment(String content, User writer, Post post) {
        this.content = content;
        this.writer = writer;
        this.post = post;
    }

    public void updatePost(Post post) {
        this.post = post;
    }
}
```

<br>

> User.java

```java
@NoArgsConstructor
@Getter
@Entity
public class User {

    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    @OneToMany(mappedBy = "writer", fetch = FetchType.LAZY, cascade = CascadeType.PERSIST)
    private List<Post> posts = new ArrayList<>();

    @OneToMany(mappedBy = "writer", fetch = FetchType.LAZY, cascade = CascadeType.PERSIST)
    private List<Comment> comments = new ArrayList<>();

    @Builder
    public User(String name, List<Post> posts, List<Comment> comments) {
        this.name = name;
        if (Objects.nonNull(posts)) {
            this.posts = posts;
        }
        if (Objects.nonNull(comments)) {
            this.comments = comments;
        }
    }
}
```

ì•ìœ¼ë¡œì˜ ì˜ˆì‹œëŠ” ëª¨ë‘ ìœ„ ë„ë©”ì¸ì„ ì‚¬ìš©í•œë‹¤.

<br>

# 1) N + 1 ë¬¸ì œë€?
ëŒ€ë¶€ë¶„ì˜ JPAë¥¼ ì‚¬ìš©í•˜ëŠ” ê°œë°œìëŠ” `N + 1`ì´ë€ ë‹¨ì–´ë¥¼ í•œ ë²ˆì¯¤ì€ ì ‘í•œë‹¤.

ê°œë…ì€ ëˆ„êµ¬ë‚˜ ì•Œê¸° ë•Œë¬¸ì—, ì´ë²ˆ ê¸€ì—ì„  ì§ì ‘ ì˜ˆì‹œë¥¼ í†µí•´ `N + 1`ê°€ ë¬´ì—‡ì¸ì§€ ì•Œì•„ë³¸ë‹¤.

`Post 1 : N Comment`ì„ ì‚¬ìš©í•˜ì—¬ **ëª¨ë“  Postì˜ Comment ë‚´ìš©**ì„ ê°€ì ¸ì˜¤ëŠ” ì˜ˆì‹œë¥¼ ì‚¬ìš©í•œë‹¤.

<br>

> PostService.java

```java
@Slf4j
@Transactional(readOnly = true)
@Service
public class PostService {

    private PostRepository postRepository;

    public PostService(PostRepository postRepository) {
        this.postRepository = postRepository;
    }

    public List<String> findAllCommentContents() {
        return extractCommentContents(postRepository.findAll());
    }

    private List<String> extractCommentContents(List<Post> posts) {
        return posts.stream()
            .flatMap(post -> post.getComments().stream().map(Comment::getContent))
            .collect(Collectors.toList());
    }
}
```

<br>

í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

> PostServiceSingleCommmentTest.java

```java
@DisplayName("N + 1 í…ŒìŠ¤íŠ¸ - Postë‹¹ Comment í•˜ë‚˜ì”©")
@ActiveProfiles("test")
@DirtiesContext(classMode = ClassMode.BEFORE_EACH_TEST_METHOD)
@SpringBootTest(webEnvironment = WebEnvironment.NONE)
class PostServiceSingleCommentTest {

    @Autowired
    private PostService postService;

    @Autowired
    private PostRepository postRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private QueryCounter queryCounter;

    @BeforeEach
    void setUp() {
        User user = userRepository.save(User.builder().name("ë¹™í—ˆ").build());

        for (int i = 0; i < 10; i++) {
            Post post = Post.builder()
                .title("N + 1 ë¬¸ì œ" + i)
                .content("N + 1 ë¬¸ì œë¥¼ í•´ê²°í•´ë³´ì•„ìš”." + i)
                .writer(user)
                .build();

            post.addComment(Comment.builder().content("ë„ˆë¬´ ì¢‹ë„¤ìš” :)" + i).writer(user).build());
            postRepository.save(post);
        }
    }

    @DisplayName("ë¬¸ì œ í•´ê²° ì „ - ëª¨ë“  Postì˜ Commentsë¥¼ ì¡°íšŒí•˜ë©´ N + 1 ë¬¸ì œê°€ ë°œìƒí•œë‹¤.")
    @Test
    void findAllCommentContents() {
        queryCounter.startCount();

        List<String> allCommentContents = postService.findAllCommentContents();

        assertThat(allCommentContents).hasSize(10);

        assertThat(queryCounter.getCount().getValue()).isEqualTo(11); // N + 1
        printQueryCount();
    }
}
```

ìœ„ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì¿¼ë¦¬ê°€ 11ë²ˆ ë‚ ë¼ê°„ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

<p align="center"><img src="./image/n_plus_1_problem_execution.png" > </p>

ì´ëŠ” **Post ëª©ë¡ ì¡°íšŒ 1ë²ˆ + ì¡°íšŒëœ Postë§ˆë‹¤ì˜ Comment ì¡°íšŒ 1ë²ˆì”© (Në²ˆ) ë°œìƒí•´ì„œ N + 1 ë¬¸ì œê°€ ë°œìƒí•œ ê²ƒì´ë‹¤.**

ê·¸ë¦¼ì„ í†µí•´ ë” ì‰½ê²Œ ë³´ìë©´ ì•„ë˜ì™€ ê°™ë‹¤.

<p align="center"><img src="./image/n_plus_1_problem.png" width="500"> </p>

<br>

`11ë²ˆì´ë©´ ê´œì°®ì€ ê²ƒ ì•„ë‹Œê°€?`ë¼ê³  ìƒê°í•˜ì‹œëŠ” ë¶„ë“¤ì´ ìˆì„ ê²ƒ ê°™ë‹¤.

**í˜„ì¬ëŠ” Post 10ê°œ, ê° Post ë³„ë¡œ Comment 1ê°œì”© (ì´ 10ê°œ)ì´ë¯€ë¡œ 11ë²ˆ ë‚ ë¼ê°„ ê²ƒì´ë‹¤.**

**ë§Œì•½ Postê°€ 100ë§Œê°œë©´, í•˜ë‚˜ì˜ ì„œë¹„ìŠ¤ ë¡œì§ì´ í˜¸ì¶œë  ë•Œë§ˆë‹¤ ì¿¼ë¦¬ê°€ ì´ 1,000,001(1 + 100ë§Œ)ë²ˆ ë‚ ë¼ê°€ë¯€ë¡œ êµ‰ì¥íˆ ë¹„ìš©ì´ ì»¤ì§€ê²Œ ëœë‹¤.**

> ì‹¤ì œë¡œ ì„œë²„ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ì˜ ë¶€í•˜ëŠ” ëŒ€ë¶€ë¶„ DBì—ì„œ ë°œìƒí•œë‹¤. DBì˜ ë¶€í•˜ë¥¼ ì¤„ì´ëŠ” ê²ƒì€ êµ‰ì¥íˆ ì¤‘ìš”í•˜ë‹¤.

<details>
  <summary>ì¿¼ë¦¬ ì¹´ìš´íŒ…ê³¼ ê´€ë ¨í•´ì„œ ê¶ê¸ˆí•˜ì‹  ë¶„ì€ ì—¬ê¸°ë¥¼ ì°¸ê³ </summary>
  
  --- 
  
  ì¿¼ë¦¬ ì¹´ìš´íŒ…ì€ í•„ìê°€ ìºì‹± í…ŒìŠ¤íŠ¸ì™€ N + 1 í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ êµ¬í˜„í•œ ë‚´ìš©ì…ë‹ˆë‹¤.

  ìì„¸í•œ ë‚´ìš©ì€ [ì—¬ê¸°](https://github.com/binghe819/TIL/blob/master/Spring/%EA%B8%B0%ED%83%80/QueryCounter/%EB%8B%A4%EC%9D%B4%EB%82%B4%EB%AF%B9%20%ED%94%84%EB%A1%9D%EC%8B%9C%EB%A5%BC%20%EC%9D%B4%EC%9A%A9%ED%95%9C%20QueryCounter%20%EC%A0%81%EC%9A%A9%EA%B8%B0.md)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.

  > ê¼­ êµ¬í˜„í•˜ì‹¤ í•„ìš”ëŠ” ì—†ìŠµë‹ˆë‹¤. í•„ìëŠ” ì¿¼ë¦¬ íšŸìˆ˜ í…ŒìŠ¤íŠ¸ë¥¼ ìë™í™”í•˜ê¸° ìœ„í•´ì„œ êµ¬í˜„í•œ ê²ƒì…ë‹ˆë‹¤.
  
  --- 
</details>

<br>

# 2) N + 1 ë¬¸ì œ í•´ê²° ë°©ë²•
N + 1 ë¬¸ì œë¡œ ì¸í•´ í•˜ë‚˜ì˜ ì„œë¹„ìŠ¤ ë¡œì§ì„ ì‹¤í–‰í•˜ëŠ”ë° DBì— ë§ì€ ì¿¼ë¦¬ê°€ ë‚ ë¼ê°„ë‹¤. DBì˜ ë¶€í•˜ê°€ ì ì°¨ ì‹¬í•´ì§„ë‹¤.

ì´ë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì€ **ìµœëŒ€í•œ DBì— ì¿¼ë¦¬ë¥¼ ì ê²Œ ë‚ ë¦¬ëŠ” ê²ƒì´ë‹¤.**

ë³´í¸ì ìœ¼ë¡œ ë§ì´ ì‚¬ìš©ë˜ëŠ” í•´ê²° ë°©ë²•ì€ ë‘ ê°€ì§€ë‹¤.

1. Join Fetch
2. @EntityGraph

<br>

## 2-1) Join Fetch
ì²«ë²ˆì§¸ í•´ê²° ë°©ë²•ì€ ê°€ì¥ ë§ì´ ì‚¬ìš©ë˜ëŠ” `Join Fetch`ì´ë‹¤.

> ë³´í†µì€ `íŒ¨ì¹˜ ì¡°ì¸`ì´ë¼ê³  ë¶ˆë¦°ë‹¤.

<br>

> PostRepository.java

```java
public interface PostRepository extends JpaRepository<Post, Long> {

    @Query("select p from Post p join fetch p.comments")
    List<Post> findAllFetchJoin();
}
```

ìœ„ ë©”ì„œë“œë¥¼ í†µí•´ `Post` ëª©ë¡ì„ ê°€ì ¸ì˜¤ë©´ `Inner Join`ì„ í†µí•´ Commentë„ í•˜ë‚˜ì˜ ì¿¼ë¦¬ë¡œ ê°€ì ¸ì˜¨ë‹¤.

<p align="center"><img src="./image/fetch_join_single_comment.png" > </p>

<br>

## 2-2) @EntityGraph
ë‘ë²ˆì§¸ í•´ê²° ë°©ë²•ì€ `@EntityGraph` ì• ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì´ë‹¤.

> PostRepository.java

```java
public interface PostRepository extends JpaRepository<Post, Long> {

    @EntityGraph(attributePaths = "comments")
    @Query("select p from Post p")
    List<Post> findAllEntityGraph();
}
```

ìœ„ ë©”ì„œë“œë¥¼ í†µí•´ `Post` ëª©ë¡ì„ ê°€ì ¸ì˜¤ë©´ `Left Outer Join`ì„ í†µí•´ Commentë„ í•˜ë‚˜ì˜ ì¿¼ë¦¬ë¡œ ê°€ì ¸ì˜¨ë‹¤.

<p align="center"><img src="./image/entitygraph_single_comment.png" > </p>

<br>

# 3) ë°ì´í„° ë»¥íŠ€ê¸° ë¬¸ì œ
ì§€ê¸ˆê¹Œì§€ N + 1ì— ëŒ€í•œ ê¸°ë³¸ì ì¸ ì´í•´ì™€ í•´ê²° ë°©ë²•ì— ëŒ€í•´ì„œ ì•Œì•„ë³´ì•˜ë‹¤.

í•˜ì§€ë§Œ ìœ„ ì˜ˆì‹œëŠ” `Post 1 : N Comment`ì—ì„œ `í•œ ê°œì˜ Postë‹¹ í•œ ê°œì˜ Comment`ë§Œ ì¡´ì¬í•  ë•Œì˜ ì˜ˆì‹œì´ë‹¤.

ì¦‰, **1 : N ê´€ê³„ì—ì„œ Nì´ í•˜ë‚˜ì¸ ê²½ìš° (ë°ì´í„° ê°œìˆ˜ê°€ 1 : 1ì¸ ê²½ìš° ê²½ìš°) distinctì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ì •ìƒë™ì‘í•œë‹¤.**

ì‹¤ì œ í˜„ì—…ì—ì„  ì¼ëŒ€ì¼ ê´€ê³„ê°€ ì•„ë‹Œì´ìƒ ìœ„ì™€ ê°™ì€ ìƒí™©ì€ ê±°ì˜ ì—†ë‹¤. (1 : Nì´ë©´ ë‹¹ì—°íˆ ë°ì´í„°ë„ 1 : Nìœ¼ë¡œ ë§ì€ ë°ì´í„°ê°€ ì €ì¥ë¨)

> Postë§ˆë‹¤ í•˜ë‚˜ì˜ Commentë§Œ ë‹¬ ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ëŠ” ì—†ì§€ ì•Šì€ê°€..! ë³´í†µ ì—¬ëŸ¬ ê°œì˜ Commentë¥¼ ì‘ì„±í•œë‹¤.

ì¦‰, ì‹¤ì œ ìš´ì˜ì—ì„œ ìœ„ì™€ê°™ì´ ì‚¬ìš©í•˜ë©´ í°ì¼ ë‚  ìˆ˜ ìˆë‹¤.

ê·¸ ì´ìœ ëŠ” **ë°ì´í„° ë»¥íŠ€ê¸° ë¬¸ì œê°€ ë°œìƒí•˜ê¸° ë•Œë¬¸ì´ë‹¤.**

ì´ë²ˆì—” `í•œ ê°œì˜ Postë‹¹ ì—¬ëŸ¬ ê°œì˜ Comment`ë¥¼ ê°€ì§„ ì˜ˆì‹œë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸í•˜ë©´ì„œ, ë°ì´í„° ë»¥íŠ€ê¸°ì— ëŒ€í•´ì„œ ì•Œì•„ë³¸ë‹¤.

<br>

> PostServiceMultiCommentTest.java

```java
@DisplayName("N + 1 í…ŒìŠ¤íŠ¸ - Postë‹¹ Comment ì—¬ëŸ¬ê°œì”©")
@ActiveProfiles("test")
@DirtiesContext(classMode = ClassMode.BEFORE_EACH_TEST_METHOD)
@SpringBootTest(webEnvironment = WebEnvironment.NONE)
public class PostServiceMultiCommentTest {

    @Autowired
    private PostService postService;

    @Autowired
    private PostRepository postRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private QueryCounter queryCounter;

    @BeforeEach
    void setUp() {
        User user = userRepository.save(User.builder().name("ë¹™í—ˆ").build());

        for (int i = 0; i < 10; i++) {
            Post post = Post.builder()
                .title("N + 1 ë¬¸ì œ" + i)
                .content("N + 1 ë¬¸ì œë¥¼ í•´ê²°í•´ë³´ì•„ìš”." + i)
                .writer(user)
                .build();

            post.addComment(Comment.builder().content("ë„ˆë¬´ ì¢‹ë„¤ìš” :)" + i).writer(user).build());
            post.addComment(Comment.builder().content("ë§¤ìš° ì¢‹ë„¤ìš” :)" + i).writer(user).build());
            postRepository.save(post);
        }
    }

    @DisplayName("ì¤‘ë³µ ì œê±° ì•ˆí•œ í…ŒìŠ¤íŠ¸ - ë°ì´í„° ë»¥íŠ€ê¸°ë¡œ ì¸í•´ ë™ì¼í•œ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ëŠ” ê°ì²´ ë‘ ê°œë¥¼ ì¤‘ë³µí•´ì„œ ê°€ì§€ê³  ìˆëŠ”ë‹¤. (ì¹´í…Œì‹œì•ˆ ê³±)")
    @Test
    void findAllCommentContentsByFetchJoin() {
        queryCounter.startCount();

        List<String> allCommentContents = postService.findAllCommentContentsByFetchJoin();

        assertThat(allCommentContents.size()).isNotEqualTo(20); // 20ì„ ì˜ˆìƒí•˜ì§€ë§Œ ë»¥íŠ€ê¸°ë˜ì–´ 40ê°œê°€ ë‚˜ì˜¨ë‹¤
        assertThat(allCommentContents).hasSize(40);
        assertThat(allCommentContents.get(0)).isSameAs(allCommentContents.get(2)); // ë™ì¼í•œ ì£¼ì†Œë¥¼ ê°€ë¦¬í‚¤ëŠ” ê°ì²´
        assertThat(queryCounter.getCount().getValue()).isEqualTo(1);
        printQueryCount();
    }
}
```
`í•œ ê°œì˜ Postë‹¹ ë‘ ê°œì˜ Comment`ë¥¼ ì €ì¥í•˜ê³  ëª¨ë“  Commentì˜ Contentë¥¼ ê°€ì ¸ì˜¤ëŠ” ì˜ˆì‹œì´ë‹¤.

**ë‹¹ì—°íˆ ê²°ê³¼ëŠ” `Post 10 * 2 = 20`ì¼ ê²ƒìœ¼ë¡œ ì˜ˆìƒí•˜ì§€ë§Œ, ê²°ê³¼ëŠ” 40ì´ ë‚˜ì˜¤ê²Œ ëœë‹¤.**

<p align="center"><img src="./image/cartesian_product_example.png" > </p>

ì´ëŠ” **ê°ì²´ì™€ RDB í…Œì´ë¸”ì˜ íŒ¨ëŸ¬ë‹¤ì„ ì°¨ì´**ë•Œë¬¸ì— ë°œìƒí•˜ëŠ” ë¬¸ì œì´ë‹¤.

ê¸€ë³´ë‹¤ëŠ” ê·¸ë¦¼ì„ í†µí•´ ë³´ëŠ” ê²ƒì´ ì´í•´í•˜ê¸° ì‰½ë‹¤.

<p align="center"><img src="./image/cartesian_product_workflow.png" > </p>

SQL Join ì¿¼ë¦¬ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì—, Postë‹¹ í–‰ì´ ë‘ ê°œê°€ ëœë‹¤. (**ë§Œì•½ Postê°€ Commentë¥¼ nê°œ ê°€ì§€ê³  ìˆë‹¤ë©´ nê°œ í–‰ì´ ëœë‹¤.**)

**ì‹¤ì œ `List<Post>`ëŠ” ê²°ê³¼ í…Œì´ë¸”ì˜ ê°œìˆ˜ì¸ 20ê°œì´ì§€ë§Œ, ê° ìš”ì†Œê°€ ì¤‘ë³µì ìœ¼ë¡œ ë°ì´í„°(`Post`ì˜ ì°¸ì¡°ê°’)ë¥¼ ê°€ì§€ê³  ìˆì–´ `getComment`ë¥¼ í•˜ë©´ ë°ì´í„°ê°€ 2ë°° (40ê°œ)ë¡œ ë‚˜ì˜¤ê²Œ ëœë‹¤.**

ë§Œì•½ Postë§ˆë‹¤ 3ê°œì”© Commentë¥¼ ê°€ì§€ê³  ìˆë‹¤ë©´, ê²°ê³¼ëŠ” 90 (Post 10 * Postë§ˆë‹¤ Comment ê°œìˆ˜ 3 * ì¤‘ë³µëœ idë¡œ ì¸í•œ ë°ì´í„° ë»¥íŠ€ê¸°3)ê°œê°€ ëœë‹¤. (ì ì  ë°ì´í„° ë»¥íŠ€ê¸°ê°€ ì‹¬í•´ì§„ë‹¤)

> 1:Nê´€ê³„ë¥¼ ì¡°ì¸í–ˆì„ ë•Œ Nì„ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì¸ì´ ë˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜´ìœ¼ë¡œì¨ ë°ì´í„° ë»¥íŠ€ê¸°ê°€ ë°œìƒ.

<br>

ğŸ¤” ì´ëŸ¬í•œ ë¬¸ì œëŠ” ì™œ ë°œìƒí• ê¹Œ?

**ê°ì²´ì—ì„  ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ê°€ì ¸ì™€ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ `id`ë¥¼ í†µí•´ íŒë³„í•˜ì—¬ í•˜ë‚˜ë§Œ ë§Œë“¤ê²Œ ëœë‹¤.**

í•˜ì§€ë§Œ RDB Join ê²°ê³¼ì˜ íŠ¹ì •ìƒ ì¤‘ë³µëœ ê°’ì„ ë°˜í™˜í•œë‹¤. JPAëŠ” RDB í…Œì´ë¸” ê²°ê³¼ì˜ ê°œìˆ˜ë§Œí¼ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ì•ˆì— ë‹´ì•„ ë°˜í™˜í•˜ê²Œ ë˜ë©°, ì´ë•Œ `id`ë¥¼ í†µí•´ íŒë³„í•œ ì¤‘ë³µëœ ê°’ì´ ë“¤ì–´ê°€ê²Œ ëœë‹¤.

ê·¸ëŸ¬ë¯€ë¡œ **20ê°œì˜ ì¿¼ë¦¬ ê²°ê³¼ê°€ ê°ì²´ì—ì„œì˜ Listì•ˆì—ëŠ” 40ê°œê°€ ì¡´ì¬í–ˆë˜ ê²ƒì´ë‹¤.**

> ì‰½ê²Œ ì–˜ê¸°í•´ì„œ **JPAëŠ” `id`ë¥¼ í†µí•´ SQL ê²°ê³¼ì˜ ë¡œìš°ë¥¼ íŒë³„í•œë‹¤. ì´ë•Œ ì¤‘ë³µì€ ì‹ ê²½ì“°ì§€ ì•Šê³  SQL ê²°ê³¼ì˜ í–‰ í•˜ë‚˜ë‹¹ í•˜ë‚˜ì˜ ê°ì²´ë¡œ ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.**

<br>

# 4) ë°ì´í„° ë»¥íŠ€ê¸° ë¬¸ì œ í•´ê²° ë°©ë²•
ë°ì´í„° ë»¥íŠ€ê¸° ë¬¸ì œëŠ” ìƒê°ë³´ë‹¤ í›¨ì”¬ ì‹¬ê°í•œ ì˜¤ë¥˜ë¥¼ ì´ˆë˜í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— í•­ìƒ ì£¼ì˜í•´ì£¼ì–´ì•¼í•œë‹¤.

N + 1 ë¬¸ì œì™€ ë‹¤ë¥´ê²Œ ë°œê²¬í•˜ê¸°ê°€ ì‰½ì§€ ì•Šë‹¤.

<br>

<p align="center"><img src="./image/collection_fetch_join_duplication_solve.png" > </p>

ìœ„ì™€ ê°™ì´ ì¤‘ë³µëœ ê²°ê³¼ë¥¼ ì œê±°í•´ì£¼ì–´ì•¼í•œë‹¤.

<br>

## 4-1) Set
ì²« ë²ˆì§¸ ë°©ë²•ì€ `1 : N` í•„ë“œì˜ íƒ€ì…ì„ `Set`ìœ¼ë¡œ ì„ ì–¸í•˜ëŠ” ê²ƒì´ë‹¤.

> ì´ë•Œ `equals`, `hashCode`ë¥¼ `id`ê¸°ì¤€ìœ¼ë¡œ ì¬ì •ì˜í•´ì£¼ì–´ì•¼í•œë‹¤. 

ìˆœì„œë¥¼ ë³´ì¥í•˜ê¸°ìœ„í•´ ë³´í†µì€ `LinkedHashSet`ë¥¼ ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤.

```java
@Entity
public class Post {

    ...

    @OneToMany(mappedBy = "post", fetch = FetchType.LAZY, cascade = CascadeType.PERSIST)
    private Set<Comment> comments = new LinkedHashSet<>();

    ...
}
```

<br>

## 4-2) DISTINCT
ë‘ ë²ˆì§¸ ë°©ë²•ì€ `DISTINCT`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µì„ ì œê±°í•˜ëŠ” ë°©ë²•ì´ë‹¤.

```java
public interface PostRepository extends JpaRepository<Post, Long> {

    @Query("select DISTINCT p from Post p join fetch p.comments")
    List<Post> findAllFetchJoinDistinct();

    @EntityGraph(attributePaths = "comments")
    @Query("select DISTINCT p from Post p")
    List<Post> findAllEntityGraphDistinct();
}
```
> Join Fetchì™€ @EntityGraph ëª¨ë‘ ë™ì¼í•˜ê²Œ ì‚¬ìš©ê°€ëŠ¥í•˜ë‹¤.

JPQLì˜ `DISTINCT`ëŠ” 2ê°€ì§€ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.
1. SQLì— `DISTINCT`ë¥¼ ì¶”ê°€
2. **ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì—”í‹°í‹° ì¤‘ë³µ ì œê±° (ê°™ì€ ì‹ë³„ìë¥¼ ê°€ì§„ ì—”í‹°í‹°ì˜ ì¤‘ë³µì„ ì œê±°í•´ì¤€ë‹¤)**

<br>

## 4-3) ë°ì´í„° ë»¥íŠ€ê¸° ë¬¸ì œëŠ” ì¼ëŒ€ë‹¤ ìƒí™©ì—ì„œë§Œ ë°œìƒí•œë‹¤
ë°ì´í„° ë»¥íŠ€ê¸° ë¬¸ì œëŠ” ê¸°ì¤€ì„ ì–´ë””ì— ë‘ëŠëƒì— ë”°ë¼ ë°ì´í„°ê°€ ëŠ˜ì–´ë‚˜ê±°ë‚˜ ëŠ˜ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤.
* `N : 1`ì˜ Commentì…ì¥ì—ì„œ ë°ì´í„°ëŠ” ë»¥íŠ€ê¸° ë˜ì§€ ì•ŠëŠ”ë‹¤.
* `1 : N`ì˜ Postì…ì¥ì—ì„œ ë°ì´í„°ëŠ” ë»¥íŠ€ê¸° ëœë‹¤.

ì¦‰, **PK(ë‹¤)ë¥¼ ê°€ì§€ê³  ìˆëŠ” ì—”í‹°í‹°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ fetch joiní•œë‹¤ë©´ ê°ì²´ì—ì„œì˜ ë°ì´í„° ë»¥íŠ€ê¸°ëŠ” ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.**

<br>

# 5) Join Fetch vs @EntityGraph
ì§€ê¸ˆê¹Œì§€ N + 1ë¥¼ í•´ê²° ë°©ë²•ìœ¼ë¡œ ë‘ ë°©ë²•ì„ ì†Œê°œí–ˆë‹¤.

ì´ ë‘ ë°©ë²•ì˜ ê³µí†µì ê³¼ ì°¨ì´ì ì€ ë¬´ì—‡ì¼ê¹Œ?

<br>

**ê³µí†µì  - ì¹´í…Œì‹œì•ˆ ê³±**

ë‘ í•´ê²° ë°©ë²•ì˜ ê³µí†µì ì€ ë‘˜ ë‹¤ ì¹´í…Œì‹œì•ˆ ê³±ì´ ë°œìƒí•œë‹¤.

ìœ„ ì˜ˆì‹œì—ì„œëŠ” Commentì˜ ìˆ˜ë§Œí¼ Postê°€ ì¤‘ë³µ ë°œìƒí•˜ê²Œ ëœë‹¤. (ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ë°ì´í„°ë³´ë‹¤ 2ë°° ë»¥íŠ€ê¸°ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆì—ˆë‹¤)

<br>

**ì°¨ì´ì **

* Fetch Joinì€ Inner Joinì„ ì‚¬ìš©í•œë‹¤.
* @EntityGraphëŠ” Left Outer Joinì„ ì‚¬ìš©í•œë‹¤.

> Inner Joinê³¼ Left Outer Joinì˜ ì°¨ì´ì ì€ [ì—¬ê¸°](https://stackoverflow.com/questions/38549/what-is-the-difference-between-inner-join-and-outer-join)ë¥¼ ì°¸ê³ .

<br>

# ë²ˆì™¸ - ì—¬ëŸ¬ ë‹¨ê³„ë¡œ Fetch Joinì„ í•´ì•¼í•˜ëŠ” ê²½ìš°
ì—¬ëŸ¬ ë‹¨ê³„ë¡œ Fetch Join (íŒ¨ì¹˜ ì¡°ì¸ì„ ì—¬ëŸ¬ë²ˆ ì‚¬ìš©í•´ì•¼ í•  ê²½ìš°)ì€ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ?

ì˜ˆë¥¼ ë“¤ì–´, ëª¨ë“  Postì˜ Commentì™€ Commentë¥¼ ì‘ì„±í•œ Userë¥¼ ì¿¼ë¦¬ í•œ ë²ˆìœ¼ë¡œ ê°€ì ¸ì˜¬ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œ? 

(Post -> Comment -> Userë¥¼ í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸°)

<br>

## Fetch Join ë³„ì¹­ì„ ì´ìš©í•œ ì—¬ëŸ¬ë²ˆ ì‚¬ìš©

ì²«ë²ˆì§¸ëŠ” **í•œ JPQL ì¿¼ë¦¬ì•ˆì— Fetch Joinì„ ì—¬ëŸ¬ë²ˆ ì‚¬ìš©**í•˜ëŠ” ë°©ë²•ì´ë‹¤.

<br>

> PostRepository.java
```java
public interface PostRepository extends JpaRepository<Post, Long> {
    @Query("select DISTINCT p from Post p join fetch p.comments c join fetch c.writer")
    List<Post> findAllFetchJoinWithCommentWriter();

    @EntityGraph(attributePaths = {"comments", "comments.writer"})
    @Query("select DISTINCT p from Post p")
    List<Post> findAllEntityGraphWithCommentWriter();
}
```
Fetch Joinê³¼ `@EntityGraph` ë°©ë²• ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.

ì´ì œ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ ì§ì ‘ ëˆˆìœ¼ë¡œ í™•ì¸í•´ë³¸ë‹¤.

<br>

> PostServiceMultiCommentTest.java
```java
@DisplayName("ì¤‘ë³µ ì œê±° + ì—¬ëŸ¬ ë‹¨ê³„ Fetch Join")
@Test
void findAllFetchJoinWithCommentWriter() {
    // given
    queryCounter.startCount();
    List<Post> posts = postRepository.findAllEntityGraphWithCommentWriter();
    // List<Post> posts = postRepository.findAllEntityGraphWithCommentWriter();

    // when
    // ê¸°ì¡´ì˜ Postì˜ Comments ê°€ì ¸ì˜¤ëŠ” ì½”ë“œ.
    List<String> comments = posts.stream()
        .flatMap(post -> post.getComments().stream().map(Comment::getContent))
        .collect(Collectors.toList());

    // (UserëŠ” Lazyì´ì§€ë§Œ, ì—¬ëŸ¬ ë‹¨ê³„ì˜ Fetch Joinì„ í†µí•´ Userë„ í•œ ë²ˆì— ê°€ì ¸ì™”ê¸° ë•Œë¬¸ì— ì¶”ê°€ë¡œ ì¿¼ë¦¬ê°€ ë‚ ì•„ê°€ì§€ ì•ŠëŠ”ë‹¤.)
    List<String> userNames = posts.stream()
        .map(post -> post.getWriter().getName())
        .collect(Collectors.toList());

    // then
    assertThat(comments).hasSize(20);
    assertThat(userNames).hasSize(10);
    assertThat(queryCounter.getCount().getValue()).isEqualTo(1);
    printQueryCount();
}
```

<p align="center"><img src="./image/nested_fetch_join_result.png" width="500"> </p>

**ë‘ ë²ˆì˜ inner joinì„ í†µí•´ ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. ì´ëŠ” Fetch Joinì— ë³„ì¹­ì„ ì£¼ëŠ” ë°©ë²•ì´ë‹¤.**

ë°ì´í„° ì¼ê´€ì„± ë¬¸ì œë¡œ ì¸í•´ Fetch Joinì— ë³„ì¹­ì„ ë¶™ì´ëŠ” ê²ƒì€ ì¢‹ì§€ ì•Šë‹¤.

ë‹¤ë§Œ, ìœ„ì™€ ê°™ì´ ì–´ë– í•œ ì¡°ê±´ë¬¸ ì—†ì´ Fetch Joinì— ë³„ì¹­ì„ ì£¼ëŠ” ê²ƒì€ ë°ì´í„° ì¼ê´€ì„±ì„ ê¹¨íŠ¸ë¦¬ì§€ ì•Šìœ¼ë¯€ë¡œ ë¬¸ì œê°€ ì—†ë‹¤.

> ë¬¼ë¡  ê·¸ë˜ë„ ë¬¸ì œê°€ ì—†ì„ì§€ ê¼¼ê¼¼íˆ í™•ì¸í•´ë³´ê³  ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

<br>

## batch_size

**ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ Fetch Joinì— ë³„ì¹­ì„ ì£¼ê¸° ì‹«ë‹¤í•˜ë©´ `batch_size`ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ë„ ìˆë‹¤.**

í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” [ì—¬ê¸°](https://github.com/binghe819/learning-sandbox/blob/master/jpa-n-plus-1-basic/src/test/java/com/binghe/jpanplus1/repository/PostRepositoryMultiFetchJoinTest.java)ì—ì„œ ìì„¸íˆ ë³¼ ìˆ˜ ìˆìœ¼ë©°, batch_sizeë¥¼ ì´ìš©í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ë‘ ë²ˆì˜ ì¿¼ë¦¬ê°€ ë‚ ì•„ê°€ì§€ë§Œ, N + 1 ë¬¸ì œëŠ” ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.

í•œë²ˆì€ Post + Commentë¥¼ ê°€ì ¸ì˜¤ë©° (ì¿¼ë¦¬ í•œë²ˆ), Commentì˜ UserëŠ” Batchì²˜ë¦¬ë¡œ inì ˆì„ ì´ìš©í•˜ì—¬ (ì¿¼ë¦¬ í•œë²ˆ) í•œë²ˆì— ê°€ì ¸ì˜¨ë‹¤.

<p align="center"><img src="./image/nested_fetch_join_batch_size.png" width="500"> </p>

> batch_sizeì™€ ê´€ë ¨ëœ ë‚´ìš©ì€ ë‹¤ìŒ ê¸€ì—ì„œ ë” ìì„¸íˆ ë‹¤ë£° ì˜ˆì •ì´ë‹¤.

<br>

# ë§ˆì¹˜ë©°
ê°„ë‹¨íˆ ì‘ì„±í•˜ë ¤ê³  í–ˆë˜ ê¸€ì´ ìƒê°ë³´ë‹¤ ê¸¸ì–´ì¡Œë‹¤.

ê·¸ë§Œí¼ N + 1 ë¬¸ì œëŠ” ì‰¬ìš°ë©´ì„œë„ ê³ ë ¤í•´ì•¼ í•  ë¶€ë¶„ì´ ë§ë‹¤.

ì´ ê¸€ì„ í†µí•´ N + 1ì™€ ê´€ë ¨ëœ ê¸°ì´ˆì ì¸ ê°œë…ì„ ì´í•´í–ˆìœ¼ë©´ ì¢‹ê² ë‹¤. ë„ì›€ì´ ë˜ì—ˆìœ¼ë©´ ì¢‹ê² ë‹¤ëŠ” ì˜ë¯¸ :)

ë‹¤ìŒ ê¸€ì€ 2ê°œ ì´ìƒì˜ ì»¬ë ‰ì…˜ íŒ¨ì¹˜ ì¡°ì¸ê³¼ í˜ì´ì§• + Fetch Joinì— ê´€ë ¨ëœ ê¸€ì„ ì‘ì„±í•  ì˜ˆì •ì´ë‹¤.
