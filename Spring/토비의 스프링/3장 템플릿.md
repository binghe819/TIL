<img src="./image/800x0.png" width="250" />

[í† ë¹„ì˜ ìŠ¤í”„ë§](http://www.yes24.com/Product/Goods/76074405?OzSrank=2)ì„ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±í•œ ìë£Œì…ë‹ˆë‹¤.

<br>

# ëª©ì°¨
- [ëª©ì°¨](#ëª©ì°¨)
- [3ì¥ í…œí”Œë¦¿](#3ì¥-í…œí”Œë¦¿)
  - [1 JDBC ì˜ˆì™¸ ì²˜ë¦¬](#1-jdbc-ì˜ˆì™¸-ì²˜ë¦¬)
    - [1-1 ì˜ˆì™¸ì²˜ë¦¬ ê¸°ëŠ¥ì„ ê°–ì¶˜ DAO](#1-1-ì˜ˆì™¸ì²˜ë¦¬-ê¸°ëŠ¥ì„-ê°–ì¶˜-dao)
      - [ìˆ˜ì • ê¸°ëŠ¥ì˜ ì˜ˆì™¸ì²˜ë¦¬](#ìˆ˜ì •-ê¸°ëŠ¥ì˜-ì˜ˆì™¸ì²˜ë¦¬)
      - [ì¡°íšŒ ê¸°ëŠ¥ì˜ ì˜ˆì™¸ì²˜ë¦¬](#ì¡°íšŒ-ê¸°ëŠ¥ì˜-ì˜ˆì™¸ì²˜ë¦¬)
  - [2 JDBC ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì—¬ëŸ¬ ì‹œë„](#2-jdbc-ì˜ˆì™¸-ì²˜ë¦¬ë¥¼-ìœ„í•œ-ì—¬ëŸ¬-ì‹œë„)
    - [2-1 try/catch/finallyì˜ ë¬¸ì œì ](#2-1-trycatchfinallyì˜-ë¬¸ì œì )
    - [2-2 ë¶„ë¦¬ì™€ ì¬ì‚¬ìš©ì„ ìœ„í•œ ë””ìì¸ íŒ¨í„´ ì ìš©](#2-2-ë¶„ë¦¬ì™€-ì¬ì‚¬ìš©ì„-ìœ„í•œ-ë””ìì¸-íŒ¨í„´-ì ìš©)
      - [ë©”ì„œë“œ ì¶”ì¶œ](#ë©”ì„œë“œ-ì¶”ì¶œ)
      - [í…œí”Œë¦¿ ë©”ì„œë“œ íŒ¨í„´](#í…œí”Œë¦¿-ë©”ì„œë“œ-íŒ¨í„´)
      - [ì „ëµ íŒ¨í„´](#ì „ëµ-íŒ¨í„´)
      - [DIë¥¼ í†µí•œ í´ë¼ì´ì–¸íŠ¸/ì»¨í…ìŠ¤íŠ¸ ë¶„ë¦¬](#dië¥¼-í†µí•œ-í´ë¼ì´ì–¸íŠ¸ì»¨í…ìŠ¤íŠ¸-ë¶„ë¦¬)
  - [3 JDBC ì „ëµ íŒ¨í„´ì˜ ìµœì í™”](#3-jdbc-ì „ëµ-íŒ¨í„´ì˜-ìµœì í™”)
  - [4 ì»¨í…ìŠ¤íŠ¸ì™€ DI](#4-ì»¨í…ìŠ¤íŠ¸ì™€-di)
    - [4-1 í´ë˜ìŠ¤ ë¶„ë¦¬ + DI](#4-1-í´ë˜ìŠ¤-ë¶„ë¦¬--di)
    - [4-2 í´ë˜ìŠ¤ ë¶„ë¦¬ + ìˆ˜ë™ DI](#4-2-í´ë˜ìŠ¤-ë¶„ë¦¬--ìˆ˜ë™-di)
    - [4-3 ìŠ¤í”„ë§ DI vs ìˆ˜ë™ DI](#4-3-ìŠ¤í”„ë§-di-vs-ìˆ˜ë™-di)
  - [5 í…œí”Œë¦¿/ì½œë°±](#5-í…œí”Œë¦¿ì½œë°±)
    - [5-1 í…œí”Œë¦¿/ì½œë°±ì˜ ë™ì‘ì›ë¦¬](#5-1-í…œí”Œë¦¿ì½œë°±ì˜-ë™ì‘ì›ë¦¬)
    - [5-2 ì½œë°±ì˜ ì¬í™œìš©](#5-2-ì½œë°±ì˜-ì¬í™œìš©)
      - [ì½œë°± ê°ì²´ ì¬í™œìš©](#ì½œë°±-ê°ì²´-ì¬í™œìš©)
      - [ì½œë°±ê³¼ í…œí”Œë¦¿ì˜ ê²°í•© - ì¤‘ìš”](#ì½œë°±ê³¼-í…œí”Œë¦¿ì˜-ê²°í•©---ì¤‘ìš”)
    - [5-3 í…œí”Œë¦¿/ì½œë°±ì˜ ì‘ìš© - ì¤‘ìš”](#5-3-í…œí”Œë¦¿ì½œë°±ì˜-ì‘ìš©---ì¤‘ìš”)
  - [6 JdbcTemplate](#6-jdbctemplate)
    - [6-1 update()](#6-1-update)
    - [6-2 query()ì™€ queryForObject()](#6-2-queryì™€-queryforobject)
      - [query()](#query)
      - [query() with RowMapper](#query-with-rowmapper)
      - [queryForObject()](#queryforobject)
    - [6-3 ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì½œë°±ì˜ ë¶„ë¦¬](#6-3-ì¬ì‚¬ìš©-ê°€ëŠ¥í•œ-ì½œë°±ì˜-ë¶„ë¦¬)
      - [ì¤‘ë³µ ì œê±°](#ì¤‘ë³µ-ì œê±°)
- [ìš©ì–´ ì •ë¦¬](#ìš©ì–´-ì •ë¦¬)
  - [ë¦¬ì†ŒìŠ¤ ë°˜í™˜ê³¼ close()](#ë¦¬ì†ŒìŠ¤-ë°˜í™˜ê³¼-close)
  - [í…œí”Œë¦¿](#í…œí”Œë¦¿)
  - [ì½œë°±](#ì½œë°±)

<br>

# 3ì¥ í…œí”Œë¦¿

> 3ì¥ì€ ì˜ˆì™¸ì²˜ë¦¬ì™€ ì•ˆì „í•œ ë¦¬ì†ŒìŠ¤ ë°˜í™˜ì„ ë³´ì¥í•˜ë©° í•µì‹¬ ë¡œì§ê³¼ ë¶€ê°€ ë¡œì§ì„ ë¶„ë¦¬í•˜ëŠ” `DAO`ë¥¼ ë§Œë“œëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì— ëŒ€í•´ì„œ ë‹¤ë£¬ë‹¤. ê°ì²´ì§€í–¥ ì„¤ê³„ ì›ë¦¬ì™€ ë””ìì¸ íŒ¨í„´, DIë“±ì„ ì ìš©í•´ë³´ë©° ì„¤ëª…í•œë‹¤.

**ìµœì¢… ëª©í‘œ == ë¡œì§ì˜ ë¶„ë¦¬!**

<br>

## 1 JDBC ì˜ˆì™¸ ì²˜ë¦¬

ğŸ™‹â€â™‚ï¸ **DB ì»¤ë„¥ì…˜**ì´ë¼ëŠ” ì œí•œì ì¸ ë¦¬ì†ŒìŠ¤ë¥¼ ê³µìœ í•˜ëŠ” ì„œë²„ì—ì„œëŠ” ì»¤ë„¥ì…˜ì„ ì‚¬ìš©í•˜ê³  **ê¼­ ë¦¬ì†ŒìŠ¤ë¥¼ ë°˜í™˜í•˜ë„ë¡ í•´ì•¼í•œë‹¤.**

* **ë§Œì•½ ì–´ë–¤ ì´ìœ ë¡œë“  ì˜ˆì™¸ê°€ ë°œìƒí•´ì„œ ì‚¬ìš©í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ë°˜í™˜í•˜ì§€ ëª»í•˜ë©´ ë©”ëª¨ë¦¬ì— ë‚¨ìœ¼ë¯€ë¡œ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ê°€ ë°œìƒí•œë‹¤.**

* ê·¸ëŸ¬ë¯€ë¡œ, DAOì—ì„œëŠ” ê¼­ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ í†µí•´ ë¦¬ì†ŒìŠ¤ë¥¼ ë°˜í™˜í•´ì¤˜ì•¼ í•œë‹¤.

<br>

### 1-1 ì˜ˆì™¸ì²˜ë¦¬ ê¸°ëŠ¥ì„ ê°–ì¶˜ DAO

ğŸ™‹â€â™‚ï¸  ì¼ë°˜ì ìœ¼ë¡œ **ì„œë²„ì—ì„œëŠ” ì œí•œëœ ê°œìˆ˜ì˜ DB ì»¤ë„¥ì…˜ì„ ë§Œë“¤ì–´ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í’€ë¡œ ê´€ë¦¬í•œë‹¤.**

* ë§Œì•½ ì œëŒ€ë¡œ ë¦¬ì†ŒìŠ¤ë¥¼ ë°˜í™˜í•´ì£¼ì§€ ì•Šìœ¼ë©´ ì–´ëŠ ìˆœê°„ ì»¤ë„¥ì…˜ í’€ì˜ ì—¬ìœ ê°€ ì—†ì–´ì§€ê³  ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê²Œ ëœë‹¤.
* **DBì»¤ë„¥ì…˜ì˜ ëˆ„ìˆ˜ë¥¼ ë§‰ê¸°ìœ„í•´ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ í†µí•´ í•´ê²°í•´ë³´ì.**

<br>

#### ìˆ˜ì • ê¸°ëŠ¥ì˜ ì˜ˆì™¸ì²˜ë¦¬

:scream: **`PreparedStatement`ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ `close()`ë©”ì„œë“œê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•„ DB ì»¤ë„¥ì…˜ ë¦¬ì†ŒìŠ¤ê°€ ì œëŒ€ë¡œ ë°˜í™˜ë˜ì§€ ì•ŠëŠ”ë‹¤.**

```java
public void deleteAll() throws SQLException {
  Connection conn = dataSource.getConnection();
  
  // ì—¬ê¸°ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ê²Œ ë˜ë©´ close(), ì¦‰ ì»¤ë„¥ì…˜ì„ ë°˜í™˜í•˜ì§€ ì•Šê³  ë©”ì„œë“œê°€ ì¢…ë£Œë˜ê²Œ ëœë‹¤.
  PreparedStatement ps = conn.prepareStatement("delete from users");
  
  ps.close();
  conn.close();
}
```

<br>

ğŸ˜ ì–´ë–¤ ê²½ìš°ì—ë„ ë°˜í™˜í•˜ê²Œ í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ  [try/catch/finally ì½”ë“œ](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/UserDao.java)ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ê²°í•´ë³´ì.

```java
public void deleteAll() throws SQLException {
  // DB ì—°ê²° ê´€ì‹¬
  Connection conn = null;

  // SQL ì‹¤í–‰ ê´€ì‹¬
  PreparedStatement ps = null;

  try {
    // ì˜ˆì™¸ê°€ ë°œìƒí•  ìˆ˜ ìˆëŠ” ì½”ë“œë¥¼ ëª¨ë‘ tryë¬¸ ì•ˆì— ë‘”ë‹¤.
    conn = dataSource.getConnection();

    ps = conn.prepareStatement("delete from users");
    ps.executeUpdate();
  } catch (SQLException e){
    throw e;
  } finally { // ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ ë°˜í™˜í•˜ë„ë¡ í•œë‹¤.
    // ë¦¬ì†ŒìŠ¤ë¥¼ ë°˜í™˜í•˜ëŠ” ê´€ì‹¬
    if(ps != null){
      try
        ps.close();
      catch(SQLException e){}
    }
    if(conn != null){
      try
        conn.close();
      catch(SQLException e){}
    }
  }
}
```

* `finally`ëŠ” ì—ëŸ¬ê°€ ë°œìƒí•˜ë“  ì•ˆí•˜ë“  ì‹¤í–‰ë˜ë¯€ë¡œ ì´ê³³ì— ë¦¬ì†ŒìŠ¤ ë°˜í™˜(`close`)ë¥¼ ì‹¤í–‰í•´ì£¼ë©´ ëœë‹¤.
  * **ì–´ë””ì„œ ì˜ˆì™¸ê°€ ë°œìƒí• ì§€ ëª¨ë¥´ê¸°ë•Œë¬¸ì— í•­ìƒ `if(ë³€ìˆ˜ != null)`ì„ í†µí•´ í™•ì¸í›„ ë°˜í™˜í•´ì¤˜ì•¼ í•œë‹¤.**
* **ë¬¸ì œëŠ” `close()`ë„ `SQLException`ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì´ë‹¤.**
  * ëŒ€ì•ˆìœ¼ë¡œëŠ” ë˜ í•œë²ˆ `try/catch`ë¥¼ ê°ì‹¸ì£¼ëŠ” ê²ƒì´ë‹¤.

<br>

#### ì¡°íšŒ ê¸°ëŠ¥ì˜ ì˜ˆì™¸ì²˜ë¦¬ 

```java
public int getCount() throws SQLException {
  Connection conn = null;

  PreparedStatement ps = null;

  ResultSet rs = null;

  try {
    conn = dataSource.getConnection();

    ps = conn.prepareStatement("select count(*) from users");

    // ResultSetë„ SQLExceptionì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
    rs = ps.executeQuery();
    rs.next();

    return rs.getInt(1);
  } catch (SQLException e){
    throw  e;
  } finally {
    // ê¼­ ë¦¬ì†ŒìŠ¤ë¥¼ ë°˜í™˜í•´ì¤€ë‹¤.
    if(rs != null){
      try{
        rs.close();
      } catch (SQLException e){}
    }
    if(ps != null){
      try{
        ps.close();
      } catch (SQLException e){}
    }
    if(conn != null){
      try{
        conn.close();
      } catch (SQLException e){}
    }
  }
}
```

* ì¡°íšŒ ê¸°ëŠ¥ì€ ìˆ˜ì • ê¸°ëŠ¥ë³´ë‹¤ `ResultSet`ì´ ì¶”ê°€ë  ë¿ ë¹„ìŠ·í•˜ë‹¤.

<br>

## 2 JDBC ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì—¬ëŸ¬ ì‹œë„

>  **JDBCì—ë‹¤ê°€ ê¸°ë³¸ì ì¸ `try/catch/finally` ê³„ì†í•´ì„œ ì¤‘ë³µì ìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ ìœ ì§€ë³´ìˆ˜ë©´ì—ì„œ êµ‰ì¥íˆ ë¹„íš¨ìœ¨ì ì´ë‹¤.**

<br>

### 2-1 try/catch/finallyì˜ ë¬¸ì œì 

:scream: **`try/catch/finally`ëŠ” ì½”ë“œê°€ ê¸¸ì–´ì§€ê³ , ë³µì¡í•´ì§„ë‹¤. ë˜í•œ ë§¤ ë§¤ì„œë“œë§ˆë‹¤ ì¤‘ë³µë˜ë¯€ë¡œ êµ‰ì¥íˆ ë¹„íš¨ìœ¨ì ì´ë‹¤.**

* ë§¤ë²ˆ ë³µë¶™ì„ í•˜ë‹¤ í•˜ë‚˜ë¼ë„ ì˜ëª» ì‘ì„±í•˜ë©´ ë¦¬ì†ŒìŠ¤ë¥¼ ì œëŒ€ë¡œ ë°˜í™˜í•˜ì§€ ëª»í•´ ì„œë²„ê°€ í° ìœ„í—˜ì— ë¹ ì§„ë‹¤.

<br>

:point_right: **í•´ê²°ë°©ë²•ì€ ì½”ë“œë¥¼ ë¶„ë¦¬í•˜ëŠ” ê²ƒì´ë‹¤.**

* ë³€í•˜ì§€ ì•ŠëŠ”, ê·¸ëŸ¬ë‚˜ ë§ì€ ê³³ì—ì„œ ì¤‘ë³µë˜ëŠ” ì½”ë“œì™€ ë¡œì§ì— ë”°ë¼ ìê¾¸ í™•ì¥ë˜ê³  ìì£¼ ë³€í•˜ëŠ” ì½”ë“œë¥¼ ì˜ ë¶„ë¦¬í•´ë‚´ë©´ ëœë‹¤.

<br>

### 2-2 ë¶„ë¦¬ì™€ ì¬ì‚¬ìš©ì„ ìœ„í•œ ë””ìì¸ íŒ¨í„´ ì ìš©

ğŸ¤” **ì–´ë–»ê²Œ ë¶„ë¦¬í• ê¹Œ?**

* í•µì‹¬ë¡œì§ê³¼ ë¶€ê°€ë¡œì§ì„ êµ¬ë¶„í•œë‹¤. (ë¶€ê°€ë¡œì§ì´ ë¬´ì—‡ì¸ì§€ ì°¾ì•„ë‚¸ë‹¤.)

<p align="center"><img src="./image/image-20200909204111888.png" width="600" /></p>

<br>

#### ë©”ì„œë“œ ì¶”ì¶œ

<p align="center"><img src="./image/image-20200909204306774.png" width="600" /></p>

:scream: ë¬¸ì œì 

* **ë¶€ê°€ë¡œì§ì„ ë¶„ë¦¬í•˜ì—¬ í•µì‹¬ë¡œì§ë§Œ ì‘ì„±í•˜ë©´ ì‹¤í–‰ì´ ë˜ê²Œ í•˜ëŠ”ê²Œ ì¢‹ì€ ì½”ë“œì´ì§€ë§Œ ë©”ì„œë“œ ì¶”ì¶œì€ í•µì‹¬ë¡œì§ì„ ë¶„ë¦¬ì‹œì¼°ìœ¼ë¯€ë¡œ ë°˜ëŒ€ë¡œ ë˜ì–´ë²„ë ¸ë‹¤.. ì˜¤íˆë ¤ ì½”ë“œê°€ ë” ë³µì¡í•´ì§„ë‹¤.**

:point_right: ì½”ë“œ

* [ë©”ì„œë“œ ì¶”ì¶œ ì½”ë“œ](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/MethodExtraction/MethodExtractionUserDao.java)

<br>

#### í…œí”Œë¦¿ ë©”ì„œë“œ íŒ¨í„´

ğŸ¤” í…œí”Œë¦¿ ë©”ì„œë“œ íŒ¨í„´ì´ë€

<p align="center"><img src="./image/image-20200909211953400.png"</p>

* **ë³€í•˜ì§€ ì•ŠëŠ” ë¶€ë¶„ì€ ìŠˆí¼ í´ë˜ìŠ¤**ì— ë‘ê³  **ë³€í•˜ëŠ” ë¶€ë¶„ì€ ì¶”ìƒ ë©”ì„œë“œ**ë¡œ ì •ì˜í•´ë‘¬ì„œ **ì˜¤ë²„ë¼ì´ë”©ì„ í†µí•´ êµ¬í˜„**í•˜ëŠ” ë°©ë²•

<p align="center"><img src="./image/image-20200909205048210.png" width="800" /></p>

```java
// ìƒìœ„ í´ë˜ìŠ¤
public abstract class SuperUserDao {

    private DataSource dataSource;

    @Autowired
    public void setDataSource(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public void deleteAll() throws SQLException {
        // DB ì—°ê²° ê´€ì‹¬
        Connection con = null;

        // SQL ì‹¤í–‰ ê´€ì‹¬
        PreparedStatement ps = null;

        try {
            con = dataSource.getConnection();

            ps = makeStatement(con); // í•µì‹¬ ë¡œì§
            ps.executeUpdate();
        } catch (SQLException e){
            throw e;
        } finally {
            ps.close();
            con.close();
        }
    }

    public abstract PreparedStatement makeStatement(Connection con) throws SQLException;
}

// DeleteAllì˜ ì„œë¸Œ í´ë˜ìŠ¤
public class UserDaoDeleteAll extends UserDao{
  protected PreparedStatement makeStatement(Connection c) throws SQLException {
    PreparedStatement ps = c.preparedStatement("delete from users");
    return ps;
  }
}
```

<br>

:scream: ë¬¸ì œì 

*  **ë°”ë¡œ DAO ë¡œì§ë§ˆë‹¤ ìƒì†ì„ í†µí•´ ìƒˆë¡œìš´ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì•¼ í•œë‹¤ëŠ” ê²ƒ**
  * **`UserDao`ì˜ JDBCë©”ì„œë“œê°€ 4ê°œì¼ ê²½ìš° ê°œì˜ ì„œë¸Œ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•´ì•¼ í•œë‹¤.**

* ë˜í•œ, **ì»´íŒŒì¼ ì‹œì ì— ê´€ê³„ê°€ ëª¨ë‘ ì •í•´ì§€ë¯€ë¡œ, ìœ ì—°ì„±ì´ ë–¨ì–´ì§„ë‹¤.**
  * `delete` ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ `UserDeleteAll` ì„ ì„ ì–¸í•˜ì—¬ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

<br>

:point_right: ì½”ë“œ

* [í…œí”Œë¦¿ ë©”ì„œë“œ ì½”ë“œ - ìŠˆí¼ í´ë˜ìŠ¤](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/TemplateMethod/SuperUserDao.java)
* [í…œí”Œë¦¿ ë©”ì„œë“œ ì½”ë“œ - ì„œë¸Œ í´ë˜ìŠ¤ (deleteAll)](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/TemplateMethod/UserDaoDeleteAll.java)

<br>

#### ì „ëµ íŒ¨í„´

ğŸ¤” ì „ëµ íŒ¨í„´

<p align="center"><img src="./image/IMG_A4ACF5F981D2-1.png" width="600" /></p>

* OCPì™€ DIPë¥¼ ì˜ ì§€í‚¨ íŒ¨í„´ì´ë¼ê³  ë³¼ ìˆ˜ ìˆë‹¤.
* **`Context`ì˜ `contextMethod()`ì—ì„œ ì¼ì •í•œ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ë™ì‘í•˜ë‹¤ê°€ íŠ¹ì • í™•ì¥ ê¸°ëŠ¥ì€ `Strategy` ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ì™¸ë¶€ì˜ ë…ë¦½ëœ ì „ëµ í´ë˜ìŠ¤ì— ìœ„ì„í•˜ëŠ” ê²ƒ.**
  * DB ì»¤ë„¥ì…˜ê³¼ ë°˜í™˜ì€ `Context`, SQLë¬¸ ì‹¤í–‰ë“±ì€ `Strategy`ë¥¼ êµ¬í˜„í•œ ì „ëµ í´ë˜ìŠ¤.

<br>

```java
// ì „ëµ ì¸í„°í˜ì´ìŠ¤ (Strategy) (í•µì‹¬ ë¡œì§)
public interface StatementStrategy {
    PreparedStatement makePreparedStatement(Connection connection) throws SQLException;
}
```

```java
// ì „ëµ í´ë˜ìŠ¤ (deleteAll) (í•µì‹¬ ë¡œì§)
public class DeleteAllStrategy implements StatementStrategy{
    @Override
    public PreparedStatement makePreparedStatement(Connection conn) throws SQLException {
        PreparedStatement ps = conn.prepareStatement("delete from users");
        return ps;
    }
}
```

```java
// Context í´ë˜ìŠ¤ (ë¶€ê°€ ë¡œì§)
public void deleteAll() throws SQLException {
  ...
    try {
      con = dataSource.getConnection();

      // ì „ëµ ìƒì„±ë° ì‚¬ìš© (ì»¨í…ìŠ¤íŠ¸ê°€ ì§ì ‘ ì „ëµì„ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•œë‹¤.)
      StatementStrategy strategy = new DeleteAllStrategy();
      ps = strategy.makePreparedStatement(con);
      ps.executeUpdate();
    } ...
}
```

<br>

:scream: ë¬¸ì œì 

* **ì „ëµì„ ì»¨í…ìŠ¤íŠ¸ í´ë˜ìŠ¤ì—ì„œ ì§ì ‘ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•˜ë©°, ì´ë¯¸ êµ¬ì²´ì ì¸ í´ë˜ìŠ¤ì¸ `DeleteAllStrategy`ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ê³ ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ëŠìŠ¨í•˜ì§€ ì•Šë‹¤.(ìœ ì—°í•˜ì§€ ì•Šë‹¤)**
* ì»¨í…ìŠ¤íŠ¸ê°€ ì§ì ‘ ì „ëµì„ ìƒì„±í•˜ì—¬ ì‚¬ìš©í•œë‹¤.

<br>

:point_right: ì½”ë“œ

* [ì»¨í…ìŠ¤íŠ¸ ì½”ë“œ](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/Strategy/ContextUserDao.java)
* [ì „ëµ êµ¬í˜„ ì½”ë“œ](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/Strategy/DeleteAllStrategy.java)

<br>

#### DIë¥¼ í†µí•œ í´ë¼ì´ì–¸íŠ¸/ì»¨í…ìŠ¤íŠ¸ ë¶„ë¦¬

ğŸ¤” ì§„ì§œ ì „ëµ íŒ¨í„´

* **ì»¨í…ìŠ¤íŠ¸ê°€ ì–´ë–¤ ì „ëµì„ ì‚¬ìš©í• ì§€ ê²°ì •í•˜ëŠ” ê²ƒì€ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ì•ë‹¨ì˜ í´ë¼ì´ì–¸íŠ¸ë‹¤.**

<p align="center"><img src="./image/image-20200908183707327.png" width="600" /></p>

* í´ë¼ì´ì–¸íŠ¸ ì±…ì„ì„ ë‹´ë‹¹í•  ë©”ì„œë“œë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ êµ¬í˜„í•˜ë©´ ëœë‹¤.
  * ì¦‰, **ìˆ˜ë™ì ìœ¼ë¡œ DIë¥¼ êµ¬í˜„í•œ ê²ƒ. (ë§ˆì´í¬ë¡œ DI)**

```java
// ì»¨í…ìŠ¤íŠ¸
public class DIContextUserDao {

    private DataSource dataSource;

    public DIContextUserDao(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    // í´ë¼ì´ì–¸íŠ¸ ì—­í•  (Serviceê°€ í˜¸ì¶œí•˜ëŠ” ë©”ì„œë“œ)
    public void deleteAll() throws SQLException {
        StatementStrategy st = new DeleteAllStrategy(); // ì „ëµ ìƒì„±
        jdbcContextWithStatementStrategy(st); // ì „ëµ ì£¼ì… ë° ì»¨í…ìŠ¤íŠ¸ ì‹¤í–‰
    }

    // jdbc ì»¨í…ìŠ¤íŠ¸ (ë¶€ê°€ê¸°ëŠ¥)
    public void jdbcContextWithStatementStrategy(StatementStrategy stmt) throws SQLException {
        // DB ì—°ê²° ê´€ì‹¬
        Connection conn = null;
        // SQL ì‹¤í–‰ ê´€ì‹¬
        PreparedStatement ps = null;

        try {
            conn = dataSource.getConnection();

            ps = stmt.makePreparedStatement(conn);

            ps.executeUpdate();
        } catch (SQLException e){
            throw e;
        } finally {
            ps.close(); // SQLExceptionìœ¼ë¡œ ê°ì‹¸ì¤˜ì•¼í•˜ëŠ”ë° ì—¬ê¸°ì„  ë¬´ì‹œí•œë‹¤.
            conn.close();
        }
    }
}
```

:point_right: ì½”ë“œ

* [DIë¥¼ í†µí•œ ì „ëµ íŒ¨í„´](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/DIStrategy/DIContextUserDao.java)

> í•µì‹¬ë¡œì§ë§Œì„ êµ¬í˜„í•˜ë©´ ë˜ë„ë¡ í•µì‹¬ë¡œì§ê³¼ ë¶€ê°€ë¡œì§ì„ ë‚˜ëˆ´ì§€ë§Œ ì—¬ì „íˆ ë¶€ì¡±í•´ë³´ì¸ë‹¤.

<br>

## 3 JDBC ì „ëµ íŒ¨í„´ì˜ ìµœì í™”

>  ìœ„ì—ì„œ êµ¬í˜„í•œ ì „ëµ íŒ¨í„´ì˜ ê°€ì¥ í° ë¬¸ì œì ì€ í•µì‹¬ë¡œì§ì„ êµ¬í˜„í•˜ëŠ” í´ë˜ìŠ¤ë“¤ì„ ëª¨ë‘ ë§Œë“¤ì–´ì¤˜ì•¼í•œë‹¤ëŠ” ê²ƒì´ë‹¤.
>
>  * **í´ë˜ìŠ¤ íŒŒì¼ì´ ë§ì•„ì§€ëŠ” ë¬¸ì œ. (DAOì˜ ë©”ì„œë“œë§ˆë‹¤ í´ë˜ìŠ¤ íŒŒì¼ì„ ë§Œë“¤ì–´ì¤˜ì•¼ í•œë‹¤.)**

* ì „ëµê³¼ í´ë¼ì´ì–¸íŠ¸ë¥¼ ìµëª… í´ë˜ìŠ¤ë¥¼ í†µí•´ êµ¬í˜„í•˜ë©´ ì´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤. (**ë¡œì»¬ í´ë˜ìŠ¤**)

<br>

ğŸ’â€â™‚ï¸ ìµëª… í´ë˜ìŠ¤ë¡œ JDBC ì „ëµ íŒ¨í„´ êµ¬í˜„

* **`UserDao`ì˜ ë©”ì„œë“œê°€ í´ë¼ì´ì–¸íŠ¸**ì´ê³ , **ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤ê°€ ê°œë³„ì ì¸ ì „ëµ**ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤.
  * í´ë¼ì´ì–¸íŠ¸ = `UserDao` ë©”ì„œë“œ
  * ì»¨í…ìŠ¤íŠ¸ = `jdbcContextWithStatementStrategy` ë©”ì„œë“œ
  * ì „ëµ = ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤

```java
public class JDBCStrategyUserDao {

    private DataSource dataSource;

    @Autowired
    public void setDataSource(DataSource dataSource) {
        this.dataSource = dataSource;
    }

  	// ì»¨í…ìŠ¤íŠ¸
    public void jdbcContextWithStatementStrategy(StatementStrategy stmt) throws SQLException{
				... (ì»¤ë„¥ì…˜)
        try {
            conn = dataSource.getConnection();

            ps = stmt.makePreparedStatement(conn);

            ps.executeUpdate();
        } 
      	... (ì»¤ë„¥ì…˜ ë°˜í™˜)
    }

  	// ì „ëµê³¼ ì»¨í…ìŠ¤íŠ¸ í†µí•© (ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤ ì‚¬ìš©)
    public void add(User user) throws SQLException {
        jdbcContextWithStatementStrategy(new StatementStrategy() {
            @Override
            public PreparedStatement makePreparedStatement(Connection conn) throws SQLException {
                PreparedStatement ps = conn.prepareStatement("insert into users(id, name, password) values(?, ?, ?)");

                ps.setString(1, user.getId());
                ps.setString(2, user.getName());
                ps.setString(3, user.getPassword());

                return ps;
            }
        });
    }
}
```

:point_right: ì½”ë“œ

* [ìµëª… í´ë˜ìŠ¤ë¡œ êµ¬í˜„ëœ JDBC ì „ëµ íŒ¨í„´ ì½”ë“œ](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/JDBCStrategy/JDBCStrategyUserDao.java)

<br>

## 4 ì»¨í…ìŠ¤íŠ¸ì™€ DI

> ì „ëµ íŒ¨í„´ì˜ êµ¬ì¡°ë¡œ ë³´ë©´ `UserDao` ì˜ ë©”ì„œë“œê°€ **í´ë¼ì´ì–¸íŠ¸**ì´ê³ , ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤ë¡œ ë§Œë“¤ì–´ì§€ëŠ” ê²ƒì´ **ì „ëµ**, `jdbcContextWithStatementStrategy()` ë©”ì„œë“œëŠ” **ì»¨í…ìŠ¤íŠ¸**ì´ë‹¤.
>
> ì§€ê¸ˆê¹Œì§€ êµ¬í˜„í•œ ë‚´ìš©ì„ ì¢…í•©í•´ë³´ë©´ `Dao` ë§ˆë‹¤ ì»¨í…ìŠ¤íŠ¸ë¥¼ ë§¤ë²ˆ ì •ì˜í•´ì¤˜ì•¼ í•œë‹¤. ì¦‰, `jdbcContext...`ë¥¼ ë§¤ë²ˆ ì •ì˜í•´ì£¼ì–´ì•¼ í•œë‹¤.

<br>

ğŸ¤” ëª¨ë“  `DAO`ê°€ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ì»¨í…ìŠ¤íŠ¸ (`jdbcContextWith...`)ë¥¼ ë¶„ë¦¬í•˜ëŠ” ë°©ë²•ì€?

* í´ë˜ìŠ¤ ë¶„ë¦¬ + DI
* í´ë˜ìŠ¤ ë¶„ë¦¬ + ìˆ˜ë™ DI

> `jdbcContextWith...` ë¥¼ ë¶„ë¦¬í•œ í´ë˜ìŠ¤ì´ë¦„ì„ `JdbcContext`ë¡œ í•˜ê³ ìˆë‹¤.

<br>

### 4-1 í´ë˜ìŠ¤ ë¶„ë¦¬ + DI

ğŸ’â€â™‚ï¸ ì»¨í…ìŠ¤íŠ¸ í´ë˜ìŠ¤ ë¶„ë¦¬ + ìŠ¤í”„ë§ DI

* ëª¨ë“  `DAO` ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ì»¨í…ìŠ¤íŠ¸(`jdbcContext`)ë¥¼ ë¶„ë¦¬í•˜ê³ , ìŠ¤í”„ë§ DIë¥¼ í†µí•´ ì˜ì¡´ì„±ì„ ì£¼ì…ë°›ëŠ” ì˜ˆì‹œ

`ì»¨í…ìŠ¤íŠ¸ (jdbcContext)`

```java
public class JdbcContext {

    private DataSource dataSource;

    @Autowired
    public void setDataSource(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public void workWithStatementStrategy(StatementStrategy stmt) throws SQLException {
      	... (ì»¤ë„¥ì…˜)

        try {
            conn = dataSource.getConnection();

          	// í•µì‹¬ ë¡œì§ì„ ì£¼ì… ë°›ì•„ì„œ ì‹¤í–‰
            ps = stmt.makePreparedStatement(conn);

            ps.executeUpdate();
        } 

      	... (ì»¤ë„¥ì…˜ ë°˜ë‚©)
    }
}
```

<br>

`í´ë¼ì´ì–¸íŠ¸ (UserDao)`

* **`í…œí”Œë¦¿/ì½œë°±` íŒ¨í„´ì„ ì ìš©í•œ ì½”ë“œ.**

```java
public class UserDao {
		
  	// ì»¨í…ìŠ¤íŠ¸ë¥¼ ìŠ¤í”„ë§ DIë¥¼ í†µí•´ ì˜ì¡´ì„± ì£¼ì…ë°›ëŠ”ë‹¤.
    private JdbcContext jdbcContext;

    @Autowired
    public void setJdbcContext(JdbcContext jdbcContext) {
        this.jdbcContext = jdbcContext;
    }

    public void add(User user) throws SQLException {
        this.jdbcContext.workWithStatementStrategy(new StatementStrategy() {
            @Override
            public PreparedStatement makePreparedStatement(Connection conn) throws SQLException {
                // add í•µì‹¬ ë¡œì§ êµ¬í˜„
              	...
            }
        });
    }

    public void deleteAll() throws SQLException {
        this.jdbcContext.workWithStatementStrategy(new StatementStrategy() {
            @Override
            public PreparedStatement makePreparedStatement(Connection conn) throws SQLException {
             		// deleteAll í•µì‹¬ ë¡œì§ êµ¬í˜„
                return conn.prepareStatement("delete from users");
            }
        });
    }
}
```

<br>

`ìŠ¤í”„ë§ ìë°” ì„¤ì •`

```java
@Configuration
public class Config {
    @Bean
    public JdbcContext jdbcContext(){
        return new JdbcContext();
    }
    @Bean
    public DataSource dataSource() {
        .. h2 ë“œë¼ì´ë²„ ì—°ê²°
    }
    @Bean
    public UserDao userDao() {
        return new UserDao();
    }
}
```

* ì˜ì¡´ ê´€ê³„ë¥¼ ê°€ì§„ ì„¸ ê°œì˜ í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ë¹ˆìœ¼ë¡œ ì„¤ì •í•˜ì˜€ë‹¤.
* ì´ìœ 
  * **ìŠ¤í”„ë§ DIë¥¼ ìœ„í•´ì„œëŠ” ëª¨ë‘ ìŠ¤í”„ë§ ë¹ˆì´ì–´ì•¼ í•œë‹¤.**
  * ì‹±ê¸€í†¤ ë°©ì‹ì˜ íš¨ìœ¨ì„±

<br>

ğŸ’â€â™‚ï¸ ì˜ì¡´ ê´€ê³„ ë³€ê²½

* ê¸°ì¡´

<p align="center"><img src="./image/image-20200909223417932.png"</p>

* í´ë˜ìŠ¤ ë¶„ë¦¬í›„
<p align="center"><img src="./image/image-20200909223516949.png"</p>

ìŠ¤í”„ë§ DIì˜ ê¸°ë³¸ì ì¸ ì›ì¹™ì€ ì‚¬ì´ì— ì¸í„°í˜ì´ìŠ¤ë¥¼ ë‘ëŠ” ê²ƒì´ë‹¤. í•˜ì§€ë§Œ `UserDao` ì™€`JdbcContext` ëŠ” êµ¬ì²´ í´ë˜ìŠ¤ì´ë‹¤.

ğŸ¤” ì™œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì€ ê²ƒ ì¼ê¹Œ?

* ìš°ì„  `JdbcContext` ëŠ” ë³€ê²½ ê°€ëŠ¥ì„±ì´ ì—†ë‹¤. ì¦‰ `UserDao` ì™€ `JdbcContext` ëŠ” ê°•í•œ ì‘ì§‘ë„ë¥¼ ê°€ì§€ê³  ìˆë‹¤.
* ê°•í•œ ì‘ì§‘ë„ë¥¼ ê°€ì§„ ê²½ìš° êµ³ì´ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë‘˜ í•„ìš”ê°€ ì—†ë‹¤.

<br>

> ğŸ¤” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  êµ¬ì²´ í´ë˜ìŠ¤ë¥¼ ì“´ê±°ë©´ DIì˜ ê¸°ë³¸ ì›ì¹™ì„ ìœ„ë°˜í•œê±° ì•„ë‹Œê°€?
>
> * DIì˜ ê¸°ë³¸ ì›ì¹™
>   * DIì˜ ê¸°ë³¸ ì›ì¹™ì— ë”°ë¥´ë©´ **ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ì´ì— ë‘¬ì„œ í´ë˜ìŠ¤ ë ˆë²¨ì—ì„œ ì˜ì¡´ ê´€ê³„ë¥¼ ë“œëŸ¬ë‚´ì§€ ì•Šê³ **, **ëŸ°íƒ€ì„ ì‹œì— ë‹¤ì´ë‚˜ë¯¹ í”„ë¡ì‹œë¥¼ í†µí•´ ì˜ì¡´ì„±ì„ ì£¼ì…í•´ì£¼ëŠ”ê²Œ ë§ë‹¤.**
> * ìŠ¤í”„ë§ì˜ DI 
>   * ìŠ¤í”„ë§ì˜ DIëŠ” ê°ì²´ì˜ ì œì–´ê¶Œí•œì„ ì™¸ë¶€ì— ìœ„ì„í–ˆë‹¤ëŠ” **IoC ê°œë…ì„ í¬ê´„í•œë‹¤.**
> * ì¦‰, `JdbcContext` ì™€ `UserDao` ëŠ” DIì›ì¹™ì„ ìœ„ë°°í•œ ê²ƒì´ ì•„ë‹ˆë‹¤.

<br>

> ì¼ë°˜ì ìœ¼ë¡œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì¤‘ê°„ì— ë‘ê³  í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤. ê·¸ëƒ¥ ì´ëŸ° ë°©ì‹ë„ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œê³  ìµœí›„ì— ì‚¬ìš©í•˜ë©´ ì¢‹ì„ê²ƒì´ë‹¤.

<br>

:point_right: ì½”ë“œ

* [í´ë¼ì´ì–¸íŠ¸ (UserDao)](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/JDBCContextWithDI/UserDao.java)
* [ì»¨í…ìŠ¤íŠ¸ (JdbcContext)](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/JDBCContextWithDI/JdbcContext.java)
* [ë¹ˆ ì„¤ì • íŒŒì¼](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/JDBCContextWithDI/Config.java)

<br>

### 4-2 í´ë˜ìŠ¤ ë¶„ë¦¬ + ìˆ˜ë™ DI

<br>

ğŸ¤” ìˆ˜ë™ DI

* ì™¸ë¶€ì—ì„œ ì˜ì¡´ì„±ì„ ì£¼ì…ë°›ì§€ ì•Šê³ , ìê¸° ìì‹ ì´ í•„ìš”í•œ ì˜ì¡´ì„±ì„ `new`í•˜ì—¬ ìƒì„±í•˜ëŠ” ê²ƒ.

<br>

ğŸ’â€â™‚ï¸ ì»¨í…ìŠ¤íŠ¸ í´ë˜ìŠ¤ ë¶„ë¦¬ + ìˆ˜ë™ DI

**ìŠ¤í”„ë§ DIë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ì¡´ì„±ì„ ìë™ìœ¼ë¡œ ì£¼ì…ë°›ê³  ì‹±ê¸€í†¤ìœ¼ë¡œ ë§Œë“œëŠ” ê²ƒì„ í¬ê¸°í•˜ê³  `DAO` ë§ˆë‹¤ `JdbcContext` ë¥¼ ì§ì ‘ `new` ë¡œ ìƒì„±í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤.**

```java
public class UserDao {
  private JdbcContex jdbcContext;
  
  public void setDataSource(DataSource dataSource){
    this.jdbcContext = new JdbcContext();
    this.jdbcContext.setDataSource(dataSource);
  }
}
```

* `UserDao` ê°€ ì§ì ‘ `JdbcContext` ì˜ ì˜ì¡´ì„±ì„ ìƒì„±í•œë‹¤.
  * ì‹±ê¸€í†¤ ë°©ì‹ ì—†ì–´ì§

<br>

### 4-3 ìŠ¤í”„ë§ DI vs ìˆ˜ë™ DI

* ìŠ¤í”„ë§ DI
  * ì¥ì  : ê°ì²´ì˜ ì˜ì¡´ê´€ê³„ê°€ ì„¤ì •íŒŒì¼ì— ëª…í™•í•˜ê²Œ ë“œëŸ¬ë‚œë‹¤.
  * ë‹¨ì  : DIì˜ ê·¼ë³¸ì ì¸ ì›ì¹™(ì¸í„°í˜ì´ìŠ¤ ë‘ëŠ” ê²ƒ)ì— ë¶€í•©í•˜ì§€ ì•Šì•„ êµ¬ì²´ì ì¸ í´ë˜ìŠ¤ì™€ì˜ ê´€ê³„ê°€ ë…¸ì¶œëœë‹¤.
* ìˆ˜ë™ DI
  * ì¥ì  : ê´€ê³„ê°€ ì™¸ë¶€ì— ë“œëŸ¬ë‚˜ì§€ ì•ŠëŠ”ë‹¤. DI ì „ëµì„ ì™¸ë¶€ì—ëŠ” ê°ì¶œ ìˆ˜ ìˆë‹¤.
  * ë‹¨ì  : ì‹±ê¸€í†¤ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ì—†ê³ , DI ì‘ì—…ì„ ìœ„í•œ ì¶”ê°€ì ì¸ ì½”ë“œê°€ í•„ìš”í•˜ë‹¤.

<br>

## 5 í…œí”Œë¦¿/ì½œë°±

> ìœ„ì—ì„œ `UserDao` ë¥¼ êµ¬í˜„í•  ë•Œ ë©”ì„œë“œì˜ ë§¤ê°œë³€ìˆ˜ë¥¼ í†µí•´ ì „ëµ ì¸í„°í˜ì´ìŠ¤(`StatementStrategy`)ë¥¼ êµ¬í˜„í•œ í•µì‹¬ ë¡œì§ì„ ìˆ˜í–‰í•˜ì˜€ë‹¤. 
> 
> ì´ëŠ” `í…œí”Œë¦¿/ì½œë°±` íŒ¨í„´ì„ ì‚¬ìš©í•œ ê²ƒì´ë©°, ì´ì— ëŒ€í•´ì„œ ë” ìì„¸íˆ ë‹¤ë¤„ë³´ì.

<br>

ğŸ¤” ìš°ë¦¬ì˜ ëª©í‘œ

* **ë¡œì§ì˜ ë¶„ë¦¬ì™€ ì¬í™œìš©**
* ë³€í•˜ëŠ” ê²ƒ (í•µì‹¬ ë¡œì§)ê³¼ ë³€í•˜ì§€ ì•ŠëŠ” ê²ƒ (ë¶€ê°€ ë¡œì§)ì„ ë¶„ë¦¬í•˜ê³  ë³€í•˜ì§€ ì•ŠëŠ” ê²ƒì€ **ìœ ì—°í•˜ê²Œ ì¬í™œìš©í•  ìˆ˜ ìˆê²Œ ë§Œë“œëŠ” ê²ƒ.**
  * ë³€í•˜ëŠ” ê²ƒ (í•µì‹¬ ë¡œì§) : SQL ì¿¼ë¦¬
  * ë³€í•˜ì§€ ì•ŠëŠ” ê²ƒ (ë¶€ê°€ ë¡œì§) : ì»¤ë„¥ì…˜, ë°˜í™˜

<br>

### 5-1 í…œí”Œë¦¿/ì½œë°±ì˜ ë™ì‘ì›ë¦¬

* **ì½œë°±**ì€ ë³´í†µ **ë‹¨ì¼ ë©”ì„œë“œ ì¸í„°í˜ì´ìŠ¤**ë¥¼ ì‚¬ìš©í•œë‹¤. í…œí”Œë¦¿ì˜ ì‘ì—… íë¦„ ì¤‘ íŠ¹ì§• ê¸°ëŠ¥ì„ ìœ„í•´ **í•œ ë²ˆ í˜¸ì¶œë˜ëŠ” ê²½ìš°ê°€ ì¼ë°˜ì **ì´ê¸° ë•Œë¬¸ì´ë‹¤.
* **ì½œë°± ì¸í„°í˜ì´ìŠ¤ì˜ ë©”ì„œë“œ**ì—ëŠ” ë³´í†µ **íŒŒë¼ë¯¸í„°ê°€ ìˆë‹¤**. ì´ íŒŒë¼ë¯¸í„°ëŠ” í…œí”Œë¦¿ì˜ ì‘ì—… íë¦„ ì¤‘ì— ë§Œë“¤ì–´ì§€ëŠ” **ì»¨í…ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì „ë‹¬ ë°›ì„ ë•Œ ì‚¬ìš©í•œë‹¤.**

<p align="center"><img src="./image/image-20200910033238972.png"</p>

* í´ë¼ì´ì–¸íŠ¸ : ì½œë°± ê°ì²´ (ì „ëµ ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ í´ë˜ìŠ¤)ë¥¼ ìƒì„±í•˜ê³  ì»¨í…ìŠ¤íŠ¸ë¥¼ í˜¸ì¶œí•˜ë©´ì„œ ì½œë°± ê°ì²´ë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ë„˜ê¸´ë‹¤. (DAO)
* í…œí”Œë¦¿ : ë¶€ê°€ ë¡œì§ (DB ì»¤ë„¥ì…˜ ë° ë°˜í™˜)ì„ ì§„í–‰í•˜ë‹¤ê°€ ë„˜ê²¨ ë°›ì€ ì½œë°± ê°ì²´ì˜ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ê³ , ì¿¼ë¦¬ì˜ ê²°ê³¼ë¥¼ ë°˜í™˜

> ë³µì¡í•´ë³´ì´ì§€ë§Œ, **DI ë°©ì‹ì˜ ì „ëµ íŒ¨í„´ êµ¬ì¡°**ì´ë‹¤.
>
> í´ë¼ì´ì–¸íŠ¸ê°€ í…œí”Œë¦¿ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ì„œ ì½œë°± ê°ì²´ë¥¼ ì „ë‹¬í•˜ëŠ” ê²ƒì€ **ë©”ì„œë“œ ë ˆë²¨ì—ì„œ ì¼ì–´ë‚˜ëŠ” DI**ë¼ê³  í•œë‹¤..

<br>

### 5-2 ì½œë°±ì˜ ì¬í™œìš©

> í…œí”Œë¦¿/ì½œë°± íŒ¨í„´ì€ ë§ì€ ì¥ì ì´ ìˆì§€ë§Œ, ì—¬ì „íˆ `DAO` ë©”ì„œë“œì—ì„œ **ë§¤ë²ˆ ìµëª… ë‚´ë¶€ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ìƒëŒ€ì ìœ¼ë¡œ ì½”ë“œë¥¼ ì‘ì„±í•˜ê³  ì½ê¸°ê°€ ë¶ˆí¸í•˜ë‹¤.** ê²Œë‹¤ê°€ ë¹„ìŠ·í•œ í•µì‹¬ ë¡œì§ë¼ë¦¬ëŠ”**ì¤‘ë³µì´ ë°œìƒí•œë‹¤.**

<br>

#### ì½œë°± ê°ì²´ ì¬í™œìš©

ğŸ¤” ì¤‘ë³µì´ ë°œìƒí•˜ëŠ” ë¶€ë¶„ (**ë¶„ë¦¬ ì „**)

<p align="center"><img src="./image/image-20200910033748114.png"></p>

ğŸ˜ ì¤‘ë³µì„ ë¶„ë¦¬ (**ë¶„ë¦¬ í›„**)

<p align="center"><img src="./image/image-20200910034614729.png"</p>

* ì´ë ‡ê²Œ í•´ì„œ ì¬í™œìš© ê°€ëŠ¥í•œ ì½œë°±ì„ ë‹´ëŠ” ë©”ì„œë“œë¥¼ ë§Œë“¤ ìˆ˜ ìˆë‹¤.
* **ì£¼ì˜**
  * **DBëŠ” ì¡°íšŒ, ìƒì„±, ìˆ˜ì •, ì‚­ì œ ë“±ë“±ì˜ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ê³  ë‚œ ê²°ê³¼ê°€ ëª¨ë‘ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ê°ê°ì˜ ë§ê²Œ êµ¬í˜„í•´ì¤˜ì•¼í•œë‹¤.**
  * ìœ„ ì˜ˆì‹œëŠ” ì‚­ì œ ê¸°ëŠ¥ì„ í•˜ëŠ” ì˜ˆì‹œì´ë©°, ë§¤ê°œë³€ìˆ˜ë¡œ ì–´ë– í•œ ê°’ë„ ë„˜ê²¨ì¤„ í•„ìš”ì—†ì´ SQLë¬¸ë§Œ ì‹¤í–‰í•˜ë©´ ë  ë•Œ ì¬í™œìš©í•  ìˆ˜ ìˆë‹¤.

<br>

#### ì½œë°±ê³¼ í…œí”Œë¦¿ì˜ ê²°í•© - ì¤‘ìš”

ğŸ’â€â™‚ï¸ ì½œë°±ì˜ ì¬í™œìš© ë©”ì„œë“œ(`executeSql()`)ë¥¼ í…œí”Œë¦¿ìœ¼ë¡œ ì˜®ê¸´ë‹¤.

<p align="center"><img src="./image/image-20200910040017248.png"</p>

<p align="center"><img src="./image/image-20200910041623899.png"</p>


<br>

<br>

:point_right: **ì»¨í…ìŠ¤íŠ¸ ì „ì²´ ì½”ë“œ (JDBCTemplateê³¼ ìœ ì‚¬)**

```java
public class JdbcContext {

    private DataSource dataSource;

    @Autowired
    public void setDataSource(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    // ì½œë°± ê°ì²´
    public void executeSql(final String query) throws SQLException {
        workWithStatementStrategy(new StatementStrategy() {
            @Override
            public PreparedStatement makePreparedStatement(Connection conn) throws SQLException {
                return conn.prepareStatement(query);
            }
        });
    }

    public void workWithStatementStrategy(StatementStrategy stmt) throws SQLException {
        Connection conn = null;
        PreparedStatement ps = null;

        try {
            conn = dataSource.getConnection();

            ps = stmt.makePreparedStatement(conn);

            ps.executeUpdate();
        } catch (SQLException e){
            throw e;
        } finally {
            if(ps != null){
                try{
                    ps.close();
                } catch (SQLException e){}
            }
            if(conn != null){
                try{
                    conn.close();
                } catch (SQLException e){}
            }
        }
    }
}
```

* ì½œë°±ì˜ ê°ì²´ë¥¼ í…œí”Œë¦¿ì´ ìƒì„±í•œë‹¤. 
  * í•µì‹¬ì¤‘ì˜ í•µì‹¬ì€ SQL ì¿¼ë¦¬ëŠ” ì—¬ì „íˆ Client (`UserDao`)ê°€ ë©”ì‹œì§€ë¥¼ í†µí•´ ì „ë‹¬í•œë‹¤.

<br>

:point_right: ì½”ë“œ

* [í´ë¼ì´ì–¸íŠ¸ (UserDao)](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/TemplateCallback/UserDao.java)
* [ì»¨í…ìŠ¤íŠ¸ (JdbcContext)](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/TemplateCallback/JdbcContext.java)

<br>

> **ëª¨ë“  DB ì‘ì—… (CRUD)ë¥¼ ì´ëŸ° ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ì´ ê°€ëŠ¥í•˜ë‹¤.**
>
> * `add` ê°™ì€ ê²½ìš°, ë„˜ê²¨ì•¼í•˜ëŠ” ë°ì´í„°ë¥¼ ê°€ë³€ì¸ìë¥¼ í†µí•´ ìˆœì„œëŒ€ë¡œ ë„˜ê²¨ì„œ ì¿¼ë¦¬ ì‘ì—…ì„ í•´ì£¼ë©´ëœë‹¤.
> * **`try .. catch ... finally`ì˜ ì¤‘ë³µì´ ë°œìƒí•œë‹¤ë©´ í…œí”Œë¦¿/ì½œë°± íŒ¨í„´ì„ ê³ ë ¤í•´ë³´ì.**

> **ìŠ¤í”„ë§ì—ì„œëŠ” í…œí”Œë¦¿/ì½œë°± íŒ¨í„´ì„ ë§ì´ ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤. ì‹¤ì œ ì½”ë“œì—ì„œë„ ë§ì´ ë°œê²¬ëœë‹¤. ê¼­ê¼­! ë§ì´ ì—°ìŠµí•˜ì.**

<br>

### 5-3 í…œí”Œë¦¿/ì½œë°±ì˜ ì‘ìš© - ì¤‘ìš”

> ê³ ì •ëœ ì‘ì—… íë¦„ì„ ê°€ì§€ëŠ”ë° ë°˜ë³µë˜ëŠ” ì½”ë“œê°€ ìˆë‹¤ë©´, **ì¤‘ë³µë˜ëŠ” ì½”ë“œë¥¼ ë¶„ë¦¬í•  ë°©ë²•ì„ ìƒê°í•˜ëŠ” ìŠµê´€ì„ ê¸¸ëŸ¬ì•¼ í•œë‹¤.**
>
> * ì¤‘ë³µëœ ì½”ë“œëŠ” ë¨¼ì € ë©”ì„œë“œë¡œ ë¶„ë¦¬í•˜ëŠ” ê°„ë‹¨í•œ ì‹œë„ë¥¼ í•´ë³¸ë‹¤.
> * ê·¸ì¤‘ ì¼ë¶€ ì‘ì—…ì„ í•„ìš”í—¤ ë”°ë¼ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‚¬ì´ì— ë‘ê³  ë¶„ë¦¬í•´ì„œ ì „ëµ íŒ¨í„´ì„ ì ìš©í•˜ê³  DIë¡œ ì˜ì¡´ê´€ê³„ë¥¼ ê´€ë¦¬í•˜ë„ë¡ í•œë‹¤.
> * ê·¸ëŸ°ë° ë°”ë€ŒëŠ” ë¶€ë¶„ì´ í•œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì•ˆì—ì„œ ë™ì‹œì— ì—¬ëŸ¬ ì¢…ë¥˜ê°€ ë§Œë“¤ì–´ì§ˆ ìˆ˜ ìˆë‹¤ë©´ í…œí”Œë¦¿/ì½œë°±ì„ ê³ ë ¤í•´ë³´ì.
> * ì—¬ëŸ¬ íƒ€ì…ì„ ì§€ì›í•˜ëŠ” ì½œë°±ê³¼ í…œí”Œë¦¿ì„ ë§Œë“¤ê³ ì í•œë‹¤ë©´ ì œë„¤ë¦­ìŠ¤ë¥¼ ì´ìš©í•œ ì½œë°±ì„ ê³ ë ¤í•´ë³´ì.

<br>

ğŸ’â€â™‚ï¸ ì „í˜•ì ì¸ í…œí”Œë¦¿/ì½œë°± íŒ¨í„´ì˜ í›„ë³´ëŠ” `try..catch..finalyy` ê°€ ì¤‘ë³µìœ¼ë¡œ ë°œìƒí•˜ëŠ” ì½”ë“œì´ë‹¤.

* ìŠ¤í”„ë§ì—ì„œ ì œê³µí•˜ëŠ” `jdbc` ì½”ë“œì—ë„ í…œí”Œë¦¿/ì½œë°±ì´ ì‚¬ìš©ëœë‹¤ê³  í•œë‹¤.

<br>

ğŸ’â€â™‚ï¸ **í…œí”Œë¦¿/ì½œë°±ì„ ì ìš©í•  ë•ŒëŠ” í…œí”Œë¦¿ê³¼ ì½œë°±ì˜ ê²½ê³„ë¥¼ ì •í•˜ê³  í…œí”Œë¦¿ì´ ì½œë°±ì—ê²Œ, ì½œë°±ì´ í…œí”Œë¦¿ì—ê²Œ ê°ê° ì „ë‹¬í•˜ëŠ” ë‚´ìš©ì´ ë¬´ì—‡ì¸ì§€ íŒŒì•…í•˜ëŠ”ê²Œ ê°€ì¥ ì¤‘ìš”í•˜ë‹¤. ê·¸ì— ë”°ë¼ ì½œë°±ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì •ì˜í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.**

> í´ë˜ìŠ¤ ì´ë¦„ì´ `Template` ìœ¼ë¡œ ëë‚˜ê±°ë‚˜ ì¸í„°í˜ì´ìŠ¤ ì´ë¦„ì´ `Callback` ìœ¼ë¡œ ëë‚œë‹¤ë©´ í…œí”Œë¦¿/ì½œë°± íŒ¨í„´ì´ ì ìš©ëœ ê²ƒì´ë¼ê³  ë³´ë©´ ëœë‹¤.

<br>

## 6 JdbcTemplate

<br>

ğŸ¤” `JdbcTemplate` == `JdbcContext`

* ìŠ¤í”„ë§ì´ `DAO` ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì¤€ë¹„ëœ ë‹¤ì–‘í•œ í…œí”Œë¦¿ê³¼ ì½œë°±.
* ê±°ì˜ ëª¨ë“  ì¢…ë¥˜ì˜ JDBC ì½”ë“œì— ì‚¬ìš© ê°€ëŠ¥í•œ í…œí”Œë¦¿/ì½œë°±ì„ ì œê³µí•˜ë©°, ìì£¼ ì‚¬ìš©ë˜ëŠ” íŒ¨í„´ì€ ì½œë°± ê°ì²´ë¥¼ ì¬í™œìš©í•˜ì—¬ ê°„ë‹¨í•œ SQLë¬¸ë§Œìœ¼ë¡œë„ ì‚¬ìš©ê°€ëŠ¥í•˜ë„ë¡ ë˜ì–´ìˆë‹¤.

<br>

ğŸ¤” ì„¤ì • ë°©ë²•ì€?

```java
public class UserDao {
    private JdbcTemplate jdbcTemplate;
    private DataSource dataSource;

    public void setDataSource(DataSource dataSource){
     		// ìˆ˜ë™ DI
        jdbcTemplate = new JdbcTemplate(dataSource);
      
        this.dataSource = dataSource;
    }
    
}
```

* ê°„ë‹¨í•œë‹¤. ìŠ¤í”„ë§ DIë¥¼ í†µí•´ `DataSource` ë¥¼ ì£¼ì…ë°›ëŠ” `Setter` ë‚˜ ìƒì„±ìì— ìˆ˜ë™ì ìœ¼ë¡œ `new` ë¥¼ í†µí•´ ì˜ì¡´ì„±ì„ ìƒì„±í•´ì£¼ë©´ ëœë‹¤.

<br>

### 6-1 update()

* Issue a single SQL update operation **(such as an insert, update or delete statement).**

<br>

ğŸ’â€â™‚ï¸ `JDBCTemplate`ê°€ ì œê³µí•˜ëŠ” `update()`ë¥¼ ì´ìš©í•˜ì—¬ `deleteAll()`ì„ êµ¬í˜„í•´ë³´ì.

```java
public void deleteAll() {
    this.jdbcTemplate.update(new PreparedStatementCreator() {
        @Override
        public PreparedStatement createPreparedStatement(Connection connection) throws SQLException {
            return connection.prepareStatement("delete from users");
        }
    });

    // ì „ì— ë§Œë“¤ì—ˆë˜ executeSqlì²˜ëŸ¼ SQLë§Œìœ¼ë¡œ ë™ì‘í•˜ë„ë¡ JDBCTemplateì—ì„œ ì œê³µí•œë‹¤.
    // this.jdbcTemplate.update("delete from users");
}
```

* [5 í…œí”Œë¦¿/ì½œë°±](#5-í…œí”Œë¦¿ì½œë°±) ì—ì„œ êµ¬í˜„í–ˆë˜ êµ¬ì¡°ì™€ ë™ì¼í•˜ë‹¤.
  * `makePreparedStatement()`ê°€ `createPreparedStatement()`ë¡œ ë°”ë€ ê²ƒë¿ì´ë‹¤.
* `JDBCTemplate`ë„ ì½œë°± ê°ì²´ë¥¼ ì¬í™œìš©í•  ìˆ˜ ìˆê²Œ SQLë¬¸ë§Œìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ í•  ìˆ˜ ìˆë‹¤.
  * `jdbcTemplate.update(String sql)`

<br>

ğŸ’â€â™‚ï¸ ë™ì¼í•˜ê²Œ `ResultSet` ì´ í•„ìš” ì—†ëŠ” `add()` ë„ êµ¬í˜„í•´ë³´ì.

```java
public void add(User user) {
  this.jdbcTemplate.update("insert into users(id, name, password) values(?, ?, ?)", 																	user.getId(), user.getName(), user.getPassword());
}
```

* `ps.setString()` í•´ì¤˜ì•¼ í•˜ëŠ” ì‘ì—…ì„ `JDBCTemplate`ê°€ ê°€ë³€ ì¸ìë¡œ ë°›ì•„ë“¤ì—¬ ëŒ€ì‹  ë°”ì¸ë”©í•´ì¤€ë‹¤.
  * ë°”ì¸ë”©í•  íŒŒë¼ë¯¸í„°ëŠ” ìˆœì„œëŒ€ë¡œ ë„£ì–´ì£¼ë©´ ëœë‹¤.

<br>

### 6-2 query()ì™€ queryForObject()

> ì±…ì—ì„œëŠ” `queryForInt()`ì˜ ëŒ€í•œ ì„¤ëª…ì´ ë‚˜ì˜¤ì§€ë§Œ, í˜„ì¬ëŠ” `deprecated` ë˜ì—ˆë‹¤.
>
> ì¼ë°˜ì ì¸ queryì— ëŒ€í•´ ì•Œì•„ë³´ì

<p align="center"><img src="./image/IMG_2F10BA8D6BB4-1.jpeg"> </p>

<br>

#### query()

ğŸ¤” `query()`

* Execute a query given static SQL, **reading the ResultSet with a ResultSetExtractor or RowMapper.**
  * `query()`ëŠ” ë§¤ìš° ë§ì€ ì˜¤ë²„ë¡œë”©ì´ ì¡´ì¬í•˜ëŠ”ë°, `Statement`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒë„ ìˆê³  `preparedStatement`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒë„ ìˆë‹¤.
  * ë˜í•œ, SQLì— ë°”ì¸ë”©í•  ë§¤ê°œë³€ìˆ˜ë„ `Object` ë°°ì—´ì„ í†µí•´ ê°€ëŠ¥í•˜ë‹¤.
  * ë˜í•œ, `ResultSet`ì€ `ResultSetExtractor`ì™€ `RowMapper`ë¥¼ í†µí•´ ë°˜í™˜í•  ìˆ˜ ìˆë‹¤.

```java
// getCount
public int getCount() {
    return this.jdbcTemplate.query(new PreparedStatementCreator() {
        @Override
        public PreparedStatement createPreparedStatement(Connection connection) throws SQLException {
            return connection.prepareStatement("select count(*) from users");
        }
    }, new ResultSetExtractor<Integer>(){
        @Override
        public Integer extractData(ResultSet resultSet) throws SQLException, DataAccessException {
            resultSet.next();
            return resultSet.getInt(1);
        }
    });
}
```

* ë‘ ê°œì˜ ì¸ìë¥¼ ë„˜ê¸´ë‹¤.
  * `PreparedStatementCreator()` : ì½œë°± ê°ì²´ (í•µì‹¬ ë¡œì§)
  * `ResultSetExtractor<>` : í•µì‹¬ ë¡œì§ì„ ì‹¤í–‰í•œ í›„ì˜ ê²°ê³¼ë¥¼ ë°›ì•„ì˜¤ëŠ” ì½œë°± (**ì œë„¤ë¦­ìŠ¤ë¥¼ ì‚¬ìš©í•œë‹¤.**)

<br>

ğŸ’â€â™‚ï¸ `queryForObject()`ë¥¼ ì‚¬ìš©í•´ì„œ ê°„ë‹¨íˆë„ êµ¬í˜„ ê°€ëŠ¥í•˜ë‹¤.

```java
queryForObject(String sql, Class<T> requiredType)
```

```java
public int getCount() {
  return this.jdbcTemplate.queryForObject("select count(*) from users", Integer.class);
}
```

* `RowMapper`ë¥¼ ì‚¬ìš©.

<br>

#### query() with RowMapper

ğŸ’â€â™‚ï¸ `query()`ë¥¼ í†µí•´ ì—¬ëŸ¬ ë¡œìš°ë¥¼ ì°¸ì¡°í•˜ì—¬ ê²°ê³¼ê°’ì„ ê°€ì ¸ì™€ì•¼í•˜ëŠ” ê²½ìš° `RowMapper`ë¥¼ ì‚¬ìš©í•œë‹¤.

DBì˜ ëª¨ë“  íšŒì› ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” `getAll()`ì„ êµ¬í˜„í•´ë³´ì.

```java
public List<User> getAll(){
  return this.jdbcTemplate.query("select * from users order by id",
        new RowMapper<User>() {
            @Override
            public User mapRow(ResultSet resultSet, int i) throws SQLException {
                User user = new User();
                user.setId(resultSet.getString("id"));
                user.setName(resultSet.getString("name"));
                user.setPassword(resultSet.getString("password"));
                return user;
            }
        });
}
```

* `query`ë„ ì˜¤ë²„ë¡œë”© ëœ ë©”ì„œë“œê°€ ë§ìœ¼ë©°, ì—¬ê¸°ì„  `List<T>`ë¥¼ ë°˜í™˜í•˜ëŠ” ë©”ì„œë“œë¥¼ ì‚¬ìš©í•œë‹¤.
* **`query`ëŠ” `ResultSet`ì˜ ëª¨ë“  ë¡œìš°ë¥¼ ì—´ëŒí•˜ë©´ì„œ ë¡œìš°ë§ˆë‹¤ `RowMapper` ì½œë°±ì„ í˜¸ì¶œí•œë‹¤.**
  * ì¦‰, ì¿¼ë¦¬ì˜ ê²°ê³¼ë§Œí¼ `RowMapper`ë¥¼ ì‹¤í–‰í•œë‹¤.
  * `RowMapper`ëŠ” í˜„ì¬ ë¡œìš°ì˜ ë‚´ìš©ì„ `<T>`ì˜ íƒ€ì…ìœ¼ë¡œ ë¦¬í„´í•œë‹¤.
  * ëª¨ë“  ë¡œìš°ì— ëŒ€í•œ ì‘ì—…ì„ ë§ˆì¹˜ë©´ ëª¨ë“  ë¡œìš°ì— ëŒ€í•œ `<T>` ê°ì²´ë¥¼ ë‹´ê³  ìˆëŠ” `List<T>`ë¥¼ ë°˜í™˜í•œë‹¤.

<br>

> **`query()`ëŠ” `queryForObject()`ì™€ ë‹¤ë¥´ê²Œ ì˜ˆì™¸ë¥¼ ë˜ì§€ì§€ ì•ŠëŠ”ë‹¤. ëŒ€ì‹  í¬ê¸°ê°€ 0ì¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•œë‹¤.**

<br>

#### queryForObject()

> **ì¿¼ë¦¬ì˜ ê²°ê³¼ê°€ ë¡œìš° í•˜ë‚˜ì¼ ë•Œ ì‚¬ìš©í•œë‹¤. ì—¬ëŸ¬ ê°œì¼ ê²½ìš° `query`**

ğŸ’â€â™‚ï¸ `queryForObject()`ëŠ” `RowMapper` ì½œë°±ì„ ì‚¬ìš©í•œë‹¤.

* `ResultSetExtract` : `ResultSet`ì„ í•œ ë²ˆ ì „ë‹¬ë°›ì•„ ì•Œì•„ì„œ ì¶”ì¶œ ì‘ì—…ì„ ëª¨ë‘ ì§„í–‰í•˜ê³  ìµœì¢… ê²°ê³¼ë§Œ ë¦¬í„´.
* `RowMapper` : `ResultSet`ì˜ ë¡œìš° í•˜ë‚˜ë¥¼ ë§¤í•‘í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ê¸° ë•Œë¬¸ì— ì—¬ëŸ¬ë²ˆ í˜¸ì¶œí•  ìˆ˜ ìˆë‹¤.
  * This method should not call `next()` on the ResultSet; it is only supposed to map values of the current row.

```java
public User get(String id) {
    return this.jdbcTemplate.queryForObject("select * from users where id = ? ", 
      new Object[]{id},  // SQLë¬¸ì— ë°”ì¸ë”© í•  íŒŒë¼ë¯¸í„° ê°’. ê°€ë³€ì¸ì ëŒ€ì‹  ë°°ì—´ì„ ì‚¬ìš©í•œë‹¤.
      new RowMapper<User>() { // ResultSet í•œ ë¡œìš°ì˜ ê²°ê³¼ë¥¼ ê°ì²´ì— ë§¤í•‘í•´ì£¼ëŠ” RowMapper ì½œë°±
        @Override
        public User mapRow(ResultSet resultSet, int i) throws SQLException {
            User user = new User();
            user.setId(resultSet.getString("id"));
            user.setName(resultSet.getString("name"));
            user.setPassword(resultSet.getString("password"));
            return user;
        }
    });
}
```

* ì™œ ê°€ë³€ì¸ìë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë°°ì—´ì„ ì‚¬ìš©í•˜ëŠ”ê°€?
  * ì‚½ì…, ìˆ˜ì •, ì‚­ì œëŠ” `ResultSet`ì´ í•„ìš”ì—†ë‹¤. í•˜ì§€ë§Œ `ResultSet`ì´ í•„ìš”í•œ ê²½ìš° ë’¤ì— ë‹¤ë¥¸ íŒŒë¼ë¯¸í„°ê°€ ìˆê¸° ë•Œë¬¸ì— ì´ ê²½ìš°ì—” ê°€ë³€ì¸ìê°€ ì•„ë‹Œ `Object`íƒ€ì…ì„ ì‚¬ìš©í•œë‹¤

> `RowMapper`ëŠ” ë¡œìš°ì˜ ê°œìˆ˜ê°€ 0ì´ë©´ `EmptyResultDataAccessException`ì„ ë˜ì§„ë‹¤. (ë°ì´í„°ê°€ ì—†ë‹¤ëŠ” ëœ»)

<br>

:point_right: ì˜ˆì‹œ

* [JdbcTemplate UserDao](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/JdbcTemplate/UserDao.java)

<br>

### 6-3 ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì½œë°±ì˜ ë¶„ë¦¬

> ì´ë¯¸ ì–´ëŠì •ë„ ì¤‘ë³µì„ ë§ì´ ì œê±° í–ˆì§€ë§Œ, ì—¬ì „íˆ ì¤‘ë³µì„ ì œê±°í•˜ëŠ” ë°©ë²•ì´ ë‚¨ì•„ìˆë‹¤.

* ì¤‘ë³µ `RowMapper` ë¶„ë¦¬
  * `RowMapper` ë¥¼ êµ¬í˜„í•œ ìµëª… í´ë˜ìŠ¤ë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ ê³µìœ .
  * ìŠ¤í”„ë§ ë¹ˆìœ¼ë¡œ ë¶„ë¦¬ (ìŠ¤í”„ë§ ì„¤ì •ì— ë“±ë¡í•˜ì—¬ ì˜ì¡´ì„±ì„ ìë™ì ìœ¼ë¡œ ì£¼ì…)
  * ëª¨ë“  SQLë¬¸ì„ ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ë¡œ ë¶„ë¦¬

<br>

#### ì¤‘ë³µ ì œê±°

ğŸ’â€â™‚ï¸ ì œì¼ ê°„ë‹¨í•œ `RowMapper` ë¥¼ ìµëª… í´ë˜ìŠ¤ ë³€ìˆ˜ë¡œ ë¶„ë¦¬

```java
public class UserDao {

    private JdbcTemplate jdbcTemplate;

    @Autowired
    public void setDataSource(DataSource dataSource) {
        jdbcTemplate = new JdbcTemplate(dataSource);
    }

  	// RowMapper ë…ë¦½
    private RowMapper<User> userRowMapper = new RowMapper<User>() {
        @Override
        public User mapRow(ResultSet resultSet, int i) throws SQLException {
            User user = new User();
            user.setId(resultSet.getString("id"));
            user.setName(resultSet.getString("name"));
            user.setPassword(resultSet.getString("password"));
            return user;
        }
    };
    ...
}
```

[ì¤‘ë³µ ì œê±° JdbcTemplate ì½”ë“œ](https://github.com/binghe819/toby-spring-code/blob/master/Ch03/src/main/java/com/binghe/user/FinalJdbcTemplate/UserDao.java)

<br>

# ìš©ì–´ ì •ë¦¬

<br>

## ë¦¬ì†ŒìŠ¤ ë°˜í™˜ê³¼ close()

* `close()`ì˜ ì˜ë¯¸
  * ë¦¬ì†ŒìŠ¤ë¥¼ ë°˜í™˜í•œë‹¤ëŠ” ì˜ë¯¸
* ì»¤ë„¥ì…˜ í’€
  * `Connection`ê³¼ `PreparedStatement`ëŠ” ë³´í†µ í’€(pool) ë°©ì‹ìœ¼ë¡œ ìš´ì˜ëœë‹¤.
  * ë¯¸ë¦¬ ì •í•´ì§„ í’€ ì•ˆì— ì œí•œëœ ìˆ˜ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ë§Œë“¤ì–´ë‘ê³  í•„ìš”í•  ë•Œ ì´ë¥¼ í• ë‹¹í•˜ê³ , ë°˜í™˜í•˜ë©´ ë‹¤ì‹œ í’€ì— ë„£ëŠ” ë°©ì‹ì´ë‹¤.
  * ìš”ì²­ì´ ë§¤ìš° ë§ì€ ê²½ìš° ê°ì²´ ìƒì„± ë¹„ìš©ì„ ìµœëŒ€í•œ ì¤„ì´ëŠ” í’€(pool) ë°©ì‹ì´ í›¨ì”¬ íš¨ìœ¨ì ì´ë‹¤.
* ì£¼ì˜í•  ì 
  * ë§Œì•½ ì»¤ë„¥ì…˜ì„ ë‹¤ ì‚¬ìš©í•˜ê³  `close()`(ë°˜í™˜)í•˜ì§€ ì•Šìœ¼ë©´ ë¦¬ì†ŒìŠ¤ê°€ ê³ ê°ˆë˜ê³  ê²°êµ­ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.

<br>

## í…œí”Œë¦¿

* í…œí”Œë¦¿ì€ ì–´ë–¤ ëª©ì ì„ ìœ„í•´ ë¯¸ë¦¬ ë§Œë“¤ì–´ë‘” ëª¨ì–‘ì´ ìˆëŠ” í‹€ì„ ê°€ë¦¬í‚¨ë‹¤.
* í”„ë¡œê·¸ë˜ë°ì—ì„œëŠ” ê³ ì •ëœ í‹€ ì•ˆì— ë°”ê¿€ ìˆ˜ ìˆëŠ” ë¶€ë¶„ì„ ë„£ì–´ì„œ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì— í…œí”Œë¦¿ì´ë¼ê³  ë¶€ë¥¸ë‹¤.
* ëŒ€í‘œì ì¸ ì˜ˆì‹œ
  * í…œí”Œë¦¿ ë©”ì„œë“œ íŒ¨í„´

<br>

## ì½œë°±

* ì½œë°±(callback)ì€ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ëª©ì ìœ¼ë¡œ ë‹¤ë¥¸ ê°ì²´ì˜ ë©”ì„œë“œì— ì „ë‹¬ë˜ëŠ” ê°ì²´ë¥¼ ë§í•œë‹¤.
* ìë°”ì—ì„œëŠ” ë©”ì„œë“œ ìì²´ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•  ë°©ë²•ì´ ì—†ê¸° ë•Œë¬¸ì— ë©”ì„œë“œê°€ ë‹´ê¸´ ê°ì²´ë¥¼ ì „ë‹¬í•´ì•¼ í•œë‹¤. (í•¨ìˆ˜í˜• ê°ì²´, ìµëª… ê°ì²´)

