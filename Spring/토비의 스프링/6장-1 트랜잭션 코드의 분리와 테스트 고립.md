# ëª©ì°¨

<br>

- [ëª©ì°¨](#ëª©ì°¨)
- [1 íŠ¸ëœì­ì…˜ ì½”ë“œì˜ ë¶„ë¦¬](#1-íŠ¸ëœì­ì…˜-ì½”ë“œì˜-ë¶„ë¦¬)
  - [1-1 ë©”ì„œë“œ ì¶”ì¶œ](#1-1-ë©”ì„œë“œ-ì¶”ì¶œ)
  - [1-2 DI ì ìš©ì„ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ë¶„ë¦¬ (í”„ë¡ì‹œ íŒ¨í„´)](#1-2-di-ì ìš©ì„-ì´ìš©í•œ-íŠ¸ëœì­ì…˜-ë¶„ë¦¬-í”„ë¡ì‹œ-íŒ¨í„´)
  - [1-3 íŠ¸ëœì­ì…˜ ì½”ë“œ ë¶„ë¦¬ì˜ ì¥ì ](#1-3-íŠ¸ëœì­ì…˜-ì½”ë“œ-ë¶„ë¦¬ì˜-ì¥ì )
- [2 ê³ ë¦½ëœ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸](#2-ê³ ë¦½ëœ-ë‹¨ìœ„-í…ŒìŠ¤íŠ¸)
  - [2-1 ë³µì¡í•œ ì˜ì¡´ê´€ê³„ ì†ì˜ í…ŒìŠ¤íŠ¸](#2-1-ë³µì¡í•œ-ì˜ì¡´ê´€ê³„-ì†ì˜-í…ŒìŠ¤íŠ¸)
  - [2-2 í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ê°ì²´ ê³ ë¦½](#2-2-í…ŒìŠ¤íŠ¸-ëŒ€ìƒ-ê°ì²´-ê³ ë¦½)
  - [2-3 Mockitoë¥¼ ì´ìš©í•œ ë¦¬íŒ©í† ë§](#2-3-mockitoë¥¼-ì´ìš©í•œ-ë¦¬íŒ©í† ë§)
  - [2-4 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì™€ í†µí•© í…ŒìŠ¤íŠ¸](#2-4-ë‹¨ìœ„-í…ŒìŠ¤íŠ¸ì™€-í†µí•©-í…ŒìŠ¤íŠ¸)

<br>

# 1 íŠ¸ëœì­ì…˜ ì½”ë“œì˜ ë¶„ë¦¬

ğŸ’â€â™‚ï¸ ì§€ê¸ˆê¹Œì§€ í•´ì˜¨ ê²ƒì²˜ëŸ¼ íŠ¸ëœì­ì…˜ ê´€ë ¨ëœ ì½”ë“œë¥¼ ë¶„ë¦¬í•´ë³´ì.

<br>

## 1-1 ë©”ì„œë“œ ì¶”ì¶œ
> [ë©”ì„œë“œ ì¶”ì¶œ ì½”ë“œ](https://github.com/binghe819/spring-toby-practice/commit/13a868d174874a7ed75c6714699810bdd8934848)
* í•µì‹¬ ë¡œì§: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
* ë¶€ê°€ ë¡œì§: íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •

<br>

## 1-2 DI ì ìš©ì„ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ë¶„ë¦¬ (í”„ë¡ì‹œ íŒ¨í„´)
> [DI ì ìš©ì„ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ë¶„ë¦¬](https://github.com/binghe819/spring-toby-practice/commit/aad29b9939bd3f5c7149af8b66c90e2482b924d4)

**ì´ì œ `UserService`ì—ëŠ” ìˆœìˆ˜í•˜ê²Œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ì¡´ì¬í•˜ê³ , íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì • ì½”ë“œëŠ” ì™¸ë¶€ë¡œ ë¹¼ë‚´ë³´ì.**

<br>

:scream: í˜„ì¬ `UserService` ê°•í•œ ê²°í•©ë„ë¡œ ê³ ì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì—, ì‚¬ì´ë¥¼ ë¹„ì§‘ê³  ë‹¤ë¥¸ ë¬´ì—‡ì¸ê°€ë¥¼ ì¶”ê°€í•˜ê¸° í˜ë“¤ë‹¤.

<p align="center"><img src="./image/IMG_B664AAD28E3E-1.jpeg" width="400"><br>ì§ì ‘ ì—°ê²°ì„ í†µí•œ ê°•í•œ ê²°í•©<br> ì¶œì²˜: í† ë¹„ì˜ ìŠ¤í”„ë§ vol.1</p>

<br>

ğŸ’â€â™‚ï¸ ê°€ì¥ ë¨¼ì € ì‹œë„í•´ë³¼ ë¦¬íŒ©í† ë§ì€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë‘ê³  DIë¥¼ ì ìš©ì‹œí‚¤ëŠ” ê²ƒì´ë‹¤.

<p align="center"><img src="./image/IMG_1206D0B4BEF1-1.jpeg" width="400"><br>ì¸í„°í˜ì´ìŠ¤ ë„ì…ì„ í†µí•´ ì•½í•œ ê²°í•©ì„ ê°–ëŠ” ìœ ì—°í•œ êµ¬ì¡°<br>ì¶œì²˜: í† ë¹„ì˜ ìŠ¤í”„ë§ vol.1</p>

* ë³´í†µ **DIë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ **ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.
  * ì½”ë“œ ë ˆë²¨(ì»´íŒŒì¼)ë•Œ ì¶”ìƒì ì¸ ê²ƒ(ì¸í„°í˜ì´ìŠ¤)ì— ì˜ì¡´í•˜ê³ , ëŸ°íƒ€ì„ ì‹œì— DIë¥¼ í†µí•´ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë°”ê¿”ê°€ë©´ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•¨.
  * í…ŒìŠ¤íŠ¸ ë•ŒëŠ” í…ŒìŠ¤íŠ¸ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼, ì •ì‹ ìš´ì˜ ì¤‘ì—ëŠ” ì •ê·œ ê·œí˜„ í´ë˜ìŠ¤ë¥¼ DI.
* **í•˜ì§€ë§Œ ê¼­ ìœ„ì™€ ê°™ì´ ì‚¬ìš©í•´ì•¼í•œë‹¤ëŠ” ì œì•½ì€ ì—†ë‹¤.**
  * **í•œ ë²ˆì— ë‘ ê°œì˜ `UserService` êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë™ì‹œì— ì´ìš©í•  ìˆ˜ë„ ìˆë‹¤. -> í”„ë¡ì‹œ**

<br>

ğŸ’â€â™‚ï¸ í”„ë¡ì‹œ íŒ¨í„´

<p align="center"><img src="./image/IMG_9E1DC29B0215-1.jpeg" width="550"><br>íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ë¶„ë¦¬ë¥¼ ìœ„í•œ UserServiceTxë„ì… (í”„ë¡ì‹œ)<br>ì¶œì²˜: í† ë¹„ì˜ ìŠ¤í”„ë§ vol.1</p>

* `UserServiceImpl` : ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì—­í•  ë‹´ë‹¹ (ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬)
* `UserServiceTx` : íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ì—­í•  ë‹´ë‹¹
  * **`UserServiceImpl`ë¥¼ ìƒíƒœë¡œ ê°€ì§€ê³  ìˆìœ¼ë©°, íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •ì„ í•˜ê³ , ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬ë¥¼ `UserServiceImpl`ì—ê²Œ ìœ„ì„í•œë‹¤.**

<br>

<p align="center"><img src="./image/IMG_183722CD74F4-1.jpeg" width="500"><br>íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì˜ ê°ì²´ê°€ ì ìš©ëœ ì˜ì¡´ê´€ê³„ <br>ì¶œì²˜: í† ë¹„ì˜ ìŠ¤í”„ë§ vol.1</p>

<br>

:point_right: ì½”ë“œ

```java
// UserService ì¸í„°í˜ì´ìŠ¤
public interface UserService {
    void add(User user);
    void upgradeLevels();
}
```
```java
// ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹í•˜ëŠ” UserServiceImpl
public class UserServiceImpl implements UserService{

    private UserDao userDao;
    private MailSender mailSender;

    public UserServiceImpl(UserDao userDao, MailSender mailSender) {
        this.userDao = userDao;
        this.mailSender = mailSender;
    }

    ...

    public void upgradeLevels() {
        // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (í•µì‹¬ë¡œì§)
        List<User> users = userDao.getAll();
        for (User user : users) {
            if (canUpgradeLevel(user)) {
                upgradeLevel(user);
            }
        }
    }

    ...
}
```
```java
// íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •ì„ ë‹´ë‹¹í•˜ëŠ” UserServiceTx
public class UserServiceTx implements UserService {

    // UserServiceë¥¼ êµ¬í˜„í•œ ë‹¤ë¥¸ ê°ì²´ë¥¼ DI ë°›ëŠ”ë‹¤. (UserServiceImpl)
    private final UserService userService;
    private final PlatformTransactionManager transactionManager;

    public UserServiceTx(UserService userService,
        PlatformTransactionManager transactionManager) {
        this.userService = userService;
        this.transactionManager = transactionManager;
    }

    @Override
    public void add(User user) {
        userService.add(user); // ìœ„ì„
    }

    @Override
    public void upgradeLevels() {
        // íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •
        TransactionStatus status = this.transactionManager.getTransaction(new DefaultTransactionDefinition());
        try {
            userService.upgradeLevels(); // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìœ„ì„
            this.transactionManager.commit(status);
        } catch (RuntimeException e) {
            this.transactionManager.rollback(status);
            throw e;
        }
    }
}
```

<br>

## 1-3 íŠ¸ëœì­ì…˜ ì½”ë“œ ë¶„ë¦¬ì˜ ì¥ì 

1. **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ë¡œì§ì˜ ë¶„ë¦¬**
   * ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹í•˜ëŠ” `UserServiceImpl` ì½”ë“œì—ì„  íŠ¸ëœì­ì…˜ê³¼ ê°™ì€ ê¸°ìˆ ì ì¸ ë‚´ìš©ì€ ì „í˜€ ì‹ ê²½ì“°ì§€ ì•Šì•„ë„ ëœë‹¤.
   * **íŠ¸ëœì­ì…˜ì˜ ì ìš©ì´ í•„ìš”í•œì§€ë„ ì‹ ê²½ì“°ì§€ ì•Šì•„ë„ ëœë‹¤. ë§Œì•½ ì ìš©ì‹œí‚¤ê³  ì‹¶ë‹¤ë©´ `UserServiceTx`ì™€ ê°™ì´ íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ê°€ì§„ ê°ì²´ê°€ ë¨¼ì € ì‹¤í–‰ë˜ë„ë¡ ë§Œë“¤ê¸°ë§Œ í•˜ë©´ ëœë‹¤.**
2. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì†ì‰½ê²Œ ë§Œë“¤ì–´ë‚¼ ìˆ˜ ìˆë‹¤.
   * ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ë¡œì§ì˜ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ë”°ë¡œ í•  ìˆ˜ ìˆë‹¤.

<br>

# 2 ê³ ë¦½ëœ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

> ì• ì¥ì—ì„  í”„ë¡ì‹œë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ê°ì²´ë¥¼ ë¶„ë¦¬í•˜ì˜€ë‹¤. 
> 
> ì´ë²ˆ ì¥ì—ì„œëŠ” ê³ ë¦½ëœ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì— ëŒ€í•œ ì´í•´ì™€ ì¤‘ìš”ì„±ì„ ì„¤ëª…í•˜ê³ , í…ŒìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì‘ì„±í•´ë³¸ë‹¤.

<br>

ğŸ’â€â™‚ï¸ ê°€ì¥ í¸í•˜ê³  ì¢‹ì€ í…ŒìŠ¤íŠ¸ ë°©ë²•ì€ ê°€ëŠ¥í•œ í•œ ì‘ì€ ë‹¨ìœ„ë¡œ ìª¼ê°œì„œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒ.

ê·¸ ì´ìœ ëŠ” í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆì„ ë•Œ ì›ì¸ì„ ì°¾ê¸° ì‰½ê³ , ë¹ ë¥¸ í”¼ë“œë°±ì„ ë°›ì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì´ë‹¤.

<br>

## 2-1 ë³µì¡í•œ ì˜ì¡´ê´€ê³„ ì†ì˜ í…ŒìŠ¤íŠ¸

:scream: í˜„ì‹¤ì—ì„œëŠ” ì‘ì€ ë‹¨ìœ„ë¡œ í…ŒìŠ¤íŠ¸í•˜ê¸° í˜ë“  ê²½ìš°ê°€ ë§ë‹¤. 

`UserService`ì˜ˆì‹œë¥¼ í†µí•´ ì™œ í˜ë“ ì§€ ì‚´í´ë³´ì.

<p align="center"><img src="./image/IMG_2459C2A7E079-1.jpeg" width="500"><br>UserServiceë¥¼ ë¶„ë¦¬í•˜ê¸° ì „ í…ŒìŠ¤íŠ¸ êµ¬ì¡°<br>ì¶œì²˜: í† ë¹„ì˜ ìŠ¤í”„ë§ vol.1</p>

* ë¬¸ì œì : í…ŒìŠ¤íŠ¸ê°€ ê³ ë¦½ë˜ì–´ ìˆì§€ ì•Šë‹¤.
* `UserService`ëŠ” `ì‚¬ìš©ì ì •ë³´ ê´€ë¦¬`í•˜ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìˆ˜í–‰í•œë‹¤. ê·¸ë¦¬ê³  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ëŒ€í•œ ì„±ê³µê³¼ ì‹¤íŒ¨ì— ëŒ€í•´ì„œë§Œ í…ŒìŠ¤íŠ¸ë˜ì•¼í•œë‹¤.
  * í•˜ì§€ë§Œ `UserDao`, `TransactionManager`, `MailSender`ì— ëª¨ë‘ ì˜ì¡´í•˜ê³  ìˆë‹¤.
  * ì¦‰, ì˜ì¡´í•˜ê³  ìˆëŠ” ì„¸ ê°€ì§€ ê°ì²´ê°€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìˆ˜í–‰í•˜ëŠ” í…ŒìŠ¤íŠ¸ì—ì„œë„ ê°™ì´ ìˆ˜í–‰ëœë‹¤.
* ì‰½ê²Œ ë§í•´, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ì›í•˜ì§€ë§Œ, ê·¸ ë’¤ì˜ ì˜ì¡´ê´€ê³„ê¹Œì§€ ëª¨ë‘ í…ŒìŠ¤íŠ¸ ëŒ€ìƒì´ ë˜ë²„ë¦° ê²ƒ.
  * ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ë¬¸ì œ ì—†ì§€ë§Œ, ê·¸ ë’¤ì˜ ì˜ì¡´ê´€ê³„ ê°ì²´ì—ì„œ ë¬¸ì œê°€ ìƒê¸°ë©´ í…ŒìŠ¤íŠ¸ëŠ” ì‹¤íŒ¨í•˜ê²Œ ëœë‹¤. (í†µí•© í…ŒìŠ¤íŠ¸ê°€ ë˜ë²„ë¦¬ëŠ” ê²ƒ)

<br>

## 2-2 í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ê°ì²´ ê³ ë¦½

ğŸ’â€â™‚ï¸ ì—¬ëŸ¬ ì˜ì¡´ê´€ê³„ ì†ì˜ í…ŒìŠ¤íŠ¸ê°€ ì™œ ì•ˆì¢‹ì€ì§€ ì•Œì•˜ë‹¤. ì´ì œ í…ŒìŠ¤íŠ¸ë¥¼ ê³ ë¦½ì‹œì¼œë³´ì.

* ê³ ë¦½ì‹œí‚¤ëŠ” ë°©ë²•ì€ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ëŒ€ì—­ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒ.
  * OCP + DI í˜¹ì€ Mockì‚¬ìš©

<br>

ì±…ì—ì„  [DIë¥¼ í†µí•œ í”„ë¡ì‹œíŒ¨í„´](#1-2-di-ì ìš©ì„-ì´ìš©í•œ-íŠ¸ëœì­ì…˜-ë¶„ë¦¬-í”„ë¡ì‹œ-íŒ¨í„´)ì„ ì‚¬ìš©í•´ì„œ ê°ì²´ë¥¼ ë¶„ë¦¬ì‹œí‚¤ê³ , í…ŒìŠ¤íŠ¸ë„ ê³ ë¦½ì‹œí‚¨ë‹¤.

<p align="center"><img src="./image/IMG_708BE2F8C096-1.jpeg" width="500"><br>DIì™€ í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•œ í…ŒìŠ¤íŠ¸ ê³ ë¦½ì‹œí‚¨ êµ¬ì¡°<br>ì¶œì²˜: í† ë¹„ì˜ ìŠ¤í”„ë§ vol.1</p>

* `MockUserDao`ì™€ `MockMailSender` (í…ŒìŠ¤íŠ¸ ëŒ€ì—­)ë¥¼ ë§Œë“¤ì–´ í…ŒìŠ¤íŠ¸ë¥¼ ê³ ë¦½ì‹œí‚¨ ê²ƒ.
  * ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í…ŒìŠ¤íŠ¸
  * íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • í…ŒìŠ¤íŠ¸

<br>

<br>

**MockUserDao**
```java
public class MockUserDao implements UserDao {

    // ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ í›„ë³´ User ê°ì²´ ëª©ë¡
    private List<User> users;
    // ì—…ê·¸ë ˆì´ë“œ ëŒ€ìƒ ê°ì²´ë¥¼ ì €ì¥í•´ë‘” ëª©ë¡
    private List<User> updated = new ArrayList();

    public MockUserDao(List<User> users) {
        this.users = users;
    }

    public List<User> getUpdated() {
        return this.updated;
    }

    // ìŠ¤í… ê¸°ëŠ¥ ì œê³µ
    public List<User> getAll() {
        return this.users;
    }

    // ëª© ê°ì²´ ê¸°ëŠ¥ ì œê³µ
    public void update(User user) {
        updated.add(user);
    }

    public void add(User user) { throw new UnsupportedOperationException(); }
    public void deleteAll() { throw new UnsupportedOperationException(); }
    public User get(String id) { throw new UnsupportedOperationException(); }
    public int getCount() { throw new UnsupportedOperationException(); }
}
```

* `UserDao`ë¥¼ ìŠ¤í…ì´ ì•„ë‹Œ ëª© ê°ì²´ë¡œ ë”°ë¡œ ë§Œë“  ì´ìœ 
  * ë¶€ê°€ì ì¸ ê²€ì¦ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•¨ 
  * `upgradeImpl`ì´ voidë¥¼ ë°˜í™˜í•˜ê¸° ë•Œë¬¸ì— ê²€ì¦í•˜ê¸° í˜ë“  ì ì„ ë³´ì™„í•˜ê¸° ìœ„í•´, DBì— ì €ì¥ë˜ëŠ” ê°ì²´ë¥¼ ì €ì¥í•˜ëŠ” ëª©ë¡(List)ë¥¼ ë‘ê³  í…ŒìŠ¤íŠ¸í•œë‹¤.
* í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ë©”ì„œë“œëŠ” ì˜ˆì™¸ë¥¼ ë˜ì ¸ì£¼ë„ë¡ í•œë‹¤. (í˜¹ì‹œ ëª¨ë¥´ê¸° ë•Œë¬¸)

<br>

<br>

**MockMailSender**
```java
public class MockMailSender implements MailSender {

    // UserServiceë¡œë¶€í„° ì „ì†¡ ìš”ì²­ì„ ë°›ì€ ë©”ì¼ ì£¼ì†Œ ì €ì¥.
    private List<String> requests = new ArrayList<String>();

    public List<String> getRequests() {
        return requests;
    }

    public void send(SimpleMailMessage mailMessage) throws MailException {
        requests.add(mailMessage.getTo()[0]);
    }

    public void send(SimpleMailMessage[] mailMessage) throws MailException {
    }
}
```
* í…ŒìŠ¤íŠ¸ í•˜ê¸° ìœ„í•´ì„œ `requests` í†µí•´ ì–´ë–¤ ë©”ì¼ ì „ì†¡ ìš”ì²­ì´ ë“¤ì–´ì™”ëŠ”ì§€ ê¸°ë¡í•œë‹¤.

<br>

<br>

**Mockì„ ì´ìš©í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í…ŒìŠ¤íŠ¸**

ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹í•˜ëŠ” `UserServiceImpl`ëŠ” `UserDao`ì™€ `MailSender`ì— ì˜ì¡´í•˜ê³  ìˆëŠ” ê°ì²´ì´ë©°, ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬ë¥¼ ì²˜ë¦¬í•œë‹¤.

ë‹¤ì‹œ ë§í•´, **`MockUserDao`ê³¼ `MockMailSender`ì„ ë§Œë“¤ì–´ í…ŒìŠ¤íŠ¸í•´ì•¼í•œë‹¤. (í˜¹ì€ Mockitoë¥¼ ì‚¬ìš©í•´ë„ ëœë‹¤.)**

ë˜í•œ, **ì¤‘ìš”í•œ ì ì€ íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •ì˜ ì±…ì„ì„ ë¶„ë¦¬í•˜ì˜€ê¸° ë•Œë¬¸ì—, íŠ¸ëœì­ì…˜ ê´€ë ¨ ê°ì²´(`UserServiceTx`)ëŠ” ì „í˜€ í•„ìš”ì—†ë‹¤.**

```java
@DisplayName("Mockì„ ì´ìš©í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ - íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ëº€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œì„ í…ŒìŠ¤íŠ¸í•œë‹¤.")
@Test
void upgradeLevels() {
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œì„ ì²˜ë¦¬í•˜ëŠ” UserService êµ¬í˜„ì²´
    UserServiceImpl userServiceImpl = new UserServiceImpl(); 
		
    MockUserDao mockUserDao = new MockUserDao(this.users);  
    userServiceImpl.setUserDao(mockUserDao);

    MockMailSender mockMailSender = new MockMailSender();
    userServiceImpl.setMailSender(mockMailSender);
    
    // Mock ê°ì²´ë“¤ì„ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê²Œ ëœë‹¤.
    userServiceImpl.upgradeLevels();

    // Mock ê°ì²´ ì•ˆì— ìƒíƒœë¥¼ ì¶”ê°€í•˜ì—¬ ìœ ì €ê°€ ë ˆë²¨ì—† ë˜ë©´ ë‚¨ê¸°ë„ë¡í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤. (Mockì˜ ì¥ì ì´ê¸°ë„ í•˜ë‹¤.)
    List<User> updated = mockUserDao.getUpdated();  
    assertThat(updated.size(), is(2));  
    checkUserAndLevel(updated.get(0), "joytouch", Level.SILVER); 
    checkUserAndLevel(updated.get(1), "madnite1", Level.GOLD);
    
    List<String> request = mockMailSender.getRequests();
    assertThat(request.size(), is(2));
    assertThat(request.get(0), is(users.get(1).getEmail()));
    assertThat(request.get(1), is(users.get(3).getEmail()));
}
```

<br>

<br>

**íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸**

ğŸ’â€â™‚ï¸  ì´ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ì˜ ë™ì‘í•œë‹¤ëŠ” ê²ƒì„ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ë³´ì¥í–ˆë‹¤ë©´, íŠ¸ëœì­ì…˜ë„ ì˜ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•´ì•¼í•œë‹¤.

```java
@DisplayName("íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸ - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ë¡œì§ í†µí•© í…ŒìŠ¤íŠ¸")
@Test
public void upgradeAllOrNothing() {
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬ UserService
    TestUserService testUserService = new TestUserService(users.get(3).getId());
    testUserService.setUserDao(userDao);
    testUserService.setMailSender(mailSender);
    
    // íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • UserService
    UserServiceTx txUserService = new UserServiceTx();
    txUserService.setTransactionManager(transactionManager);
    txUserService.setUserService(testUserService); // UserServiceImplë¥¼ ì£¼ì…í•œë‹¤. (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬ë¥¼ ìœ„í•¨)
        
    userDao.deleteAll();			  
    for(User user : users) userDao.add(user);
    
    try {
        assertThatThrownBy(() -> userServiceTx.upgradeLevels())
                .isInstanceOf(TestUserServiceException.class);
    }
    catch(TestUserServiceException e) { 
    }
    
    checkLevelUpgraded(users.get(1), false);
}
```
* **ë‚´ìš©ì´ ê¸¸ì–´ë³´ì´ì§€ë§Œ, ì‚¬ì‹¤ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ë¡œì§ì„ ë¶„ë¦¬ì‹œí‚¤ê³ , ë”°ë¡œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•œ ê²ƒì´ë‹¤.**

> [ì „ì²´ ì½”ë“œ](https://github.com/binghe819/spring-toby-practice/blob/chapter06/src/test/java/com/binghe/service/UserServiceTest.java)


<br>

## 2-3 Mockitoë¥¼ ì´ìš©í•œ ë¦¬íŒ©í† ë§
ğŸ’â€â™‚ï¸ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” ìŠ¤í…ì´ë‚˜ ëª© ê°ì²´ì˜ ì‚¬ìš©ì´ í•„ìˆ˜ì ì´ë‹¤. í•˜ì§€ë§Œ ë§¤ë²ˆ ê°ì²´ë¥¼ ë”°ë¡œ ë§Œë“¤ì–´ì£¼ê¸°ëŠ” í˜ë“¤ë‹¤.

* ì´ë•Œ ì‚¬ìš©ë˜ëŠ” ê²ƒì´ ë°”ë¡œ ëª© í”„ë ˆì„ì›Œí¬ë‹¤.
* ê·¸ë¦¬ê³  ê°€ì¥ ëŒ€í‘œì ì¸ ê²ƒì´ ë°”ë¡œ Mockitoì´ë‹¤.

<br>

ğŸ¤” Mockitoë€?
* Mock ê°ì²´ë¥¼ ì‰½ê²Œ ë§Œë“¤ê³  ê´€ë¦¬í•˜ê³  ê²€ì¦í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì œê³µí•˜ëŠ” í”„ë ˆì„ì›Œí¬ë‹¤.

> ë” ìì„¸í•œ ë‚´ìš©ì€ [ì—¬ê¸°](https://github.com/binghe819/TIL/blob/master/Test/Mockito/Mockito.md)ì„œ í™•ì¸ê°€ëŠ¥í•˜ë‹¤.

<br>

ğŸ’â€â™‚ï¸ MockitoëŠ” ë‹¤ìŒê³¼ ê°™ì€ ìˆœì„œë¡œ êµ¬í˜„í•´ì£¼ë©´ ëœë‹¤.
1. ì¸í„°í˜ì´ìŠ¤ë¥¼ ì´ìš©í•´ ëª© ê°ì²´ë¥¼ ë§Œë“ ë‹¤. (ìƒì„±)
2. ëª© ê°ì²´ê°€ ë¦¬í„´í•  ê°’ì´ ìˆìœ¼ë©´ ì´ë¥¼ ì§€ì •í•´ì¤€ë‹¤. (ì˜ˆì™¸ë„ ê°€ëŠ¥)
3. í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ê°ì²´ì— DIí•´ì„œ ëª© ê°ì²´ê°€ í…ŒìŠ¤íŠ¸ ì¤‘ì— ì‚¬ìš©ë˜ë„ë¡ ë§Œë“ ë‹¤.
4. í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ê°ì²´ë¥¼ ì‚¬ìš©í•œ í›„ì— ëª© ê°ì²´ì˜ íŠ¹ì • ë©”ì„œë“œê°€ í˜¸ì¶œëëŠ”ì§€, ì–´ë–¤ ê°’ì„ ê°€ì§€ê³  ëª‡ ë²ˆ í˜¸ì¶œëëŠ”ì§€ë¥¼ ê²€ì¦í•œë‹¤.

<br>

:point_right: ì½”ë“œ

```java
@DisplayName("Mockì„ ì´ìš©í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ - íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ëº€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í…ŒìŠ¤íŠ¸í•œë‹¤.")
@Test
void upgradeLevels() {
    UserServiceImpl userServiceImpl = new UserServiceImpl();

    UserDao mockUserDao = mock(UserDao.class);
    when(mockUserDao.getAll()).thenReturn(this.users);
    userServiceImpl.setUserDao(mockUserDao);

    MailSender mockMailSender = mock(MailSender.class);
    userServiceImpl.setMailSender(mockMailSender);

    userServiceImpl.upgradeLevels();

    // Mockitoë¥¼ ì´ìš©í•´ì„œ ì–´ë–¤ ë©”ì„œë“œê°€ ëª‡ ë²ˆ í˜¸ì¶œëëŠ”ì§€, íŒŒë¼ë¯¸í„°ëŠ” ë¬´ì—‡ì¸ì§€ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
    verify(mockUserDao, times(2)).update(any(User.class));
    verify(mockUserDao).update(users.get(1));
    assertThat(users.get(1).getLevel()).isEqualTo(Level.SILVER);
    verify(mockUserDao).update(users.get(3));
    assertThat(users.get(3).getLevel()).isEqualTo(Level.GOLD);

    // íŒŒë¼ë¯¸í„°ë¥¼ ì •ë°€í•˜ê²Œ ê²€ì‚¬í•˜ê¸° ìœ„í•´ ìº¡ì²˜í•  ìˆ˜ë„ ìˆë‹¤.
    ArgumentCaptor<SimpleMailMessage> mailMessageArg = ArgumentCaptor.forClass(SimpleMailMessage.class);
    verify(mockMailSender, times(2)).send(mailMessageArg.capture());
    List<SimpleMailMessage> mailMessages = mailMessageArg.getAllValues();
    assertThat(mailMessages.get(0).getTo()[0]).isEqualTo(users.get(1).getEmail());
    assertThat(mailMessages.get(1).getTo()[0]).isEqualTo(users.get(3).getEmail());
}
```

<br>

## 2-4 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì™€ í†µí•© í…ŒìŠ¤íŠ¸
ğŸ¤” ë‹¨ìœ„? í†µí•©?

* ë‹¨ìœ„: ë‹¨ìœ„ëŠ” ì‚¬ëŒë§ˆë‹¤ ì •í•˜ê¸° ë‚˜ë¦„ì´ë‹¤.
  * í† ë¹„ë‹˜ì€ Solitaryì„ ë‹¨ìœ„ë¼ê³  ë³¸ë‹¤. (MockistíŒŒ)
* í†µí•©: ë‘ ê°œ ì´ìƒì˜ ë‹¨ìœ„ê°€ ê²°í•©í•´ì„œ ë™ì‘í•˜ë©´ì„œ í…ŒìŠ¤íŠ¸ê°€ ìˆ˜í–‰ë˜ëŠ” ê²ƒ.
  * ë‘ ê°œ ì´ìƒì˜, ì„±ê²©ì´ë‚˜ ê³„ì¸µì´ ë‹¤ë¥¸ ê°ì²´ê°€ ì—°ë™í•˜ë„ë¡ ë§Œë“¤ì–´ì§„ í…ŒìŠ¤íŠ¸.
  * ì™¸ë¶€ì˜ DBë‚˜ íŒŒì¼, ì„œë¹„ìŠ¤ë“±ì˜ ë¦¬ì†ŒìŠ¤ê°€ ì°¸ì—¬í•˜ëŠ” í…ŒìŠ¤íŠ¸ë„ í†µí•©í…ŒìŠ¤íŠ¸.

<br>

ğŸ’â€â™‚ï¸ í† ë¹„ë‹˜ì´ ë§í•˜ì‹œëŠ” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì™€ í†µí•© í…ŒìŠ¤íŠ¸ì˜ ê°€ì´ë“œë¼ì¸

* í•­ìƒ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ë¨¼ì € ê³ ë ¤í•˜ë¼.
* í•˜ë‚˜ì˜ í´ë˜ìŠ¤ë‚˜ ì„±ê²©ì´ ê°™ì€ ê¸´ë°€í•œ í´ë˜ìŠ¤ ëª‡ ê°œë¥¼ ëª¨ì•„ì„œ ì™¸ë¶€ì™€ì˜ ì˜ì¡´ê´€ê³„ë¥¼ ëª¨ë‘ ì°¨ë‹¨í•˜ê³  í•„ìš”ì— ë”°ë¼ ìŠ¤í…ì´ë‚˜ ëª© ê°ì²´ ë“±ì˜ í…ŒìŠ¤íŠ¸ ëŒ€ì—­ì„ ì´ìš©í•˜ë„ë¡ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“ ë‹¤.
* ì™¸ë¶€ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•´ì•¼ë§Œ ê°€ëŠ¥í•œ í…ŒìŠ¤íŠ¸ëŠ” í†µí•© í…ŒìŠ¤íŠ¸ë¡œ ë§Œë“ ë‹¤.
  * ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¡œ ë§Œë“¤ê¸°ê°€ ì–´ë ¤ìš´ ì½”ë“œë„ ìˆë‹¤. ëŒ€í‘œì ìœ¼ë¡œ DAO.
  * ì½”ë“œë§Œ ë³´ë©´ í•˜ë‚˜ì˜ ê¸°ëŠ¥ ë‹¨ìœ„ë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì´ê¸°ë„í•˜ë‹¤.
  * DAO í…ŒìŠ¤íŠ¸ ì¶©ë¶„íˆ ê²€ì¦í•´ë‘ë©´, DAOë¥¼ ì´ìš©í•˜ëŠ” ì½”ë“œëŠ” DAOì—­í• ì„ ìŠ¤í…ì´ë‚˜ ëª© ê°ì²´ë¡œ ëŒ€ì²´í•´ì„œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë‹¤.
* ì—¬ëŸ¬ ê°œì˜ ë‹¨ìœ„ê°€ ì˜ì¡´ê´€ê³„ë¥¼ ê°€ì§€ê³  ë™ì‘í•  ë•Œë¥¼ ìœ„í•œ í†µí•© í…ŒìŠ¤íŠ¸ëŠ” í•„ìš”í•˜ë‹¤. 
  * ë‹¤ë§Œ, ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì¶©ë¶„íˆ ê±°ì³¤ë‹¤ë©´ í†µí•© í…ŒìŠ¤íŠ¸ì˜ ë¶€ë‹´ì€ ìƒëŒ€ì ìœ¼ë¡œ ì¤„ì–´ë“ ë‹¤.
* ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ê¸°ê°€ ë„ˆë¬´ ë³µì¡í•˜ë‹¤ê³  íŒë‹¨ë˜ëŠ” ì½”ë“œëŠ” ì²˜ìŒë¶€í„° í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ ê³ ë ¤í•´ë³¸ë‹¤.
  * ì´ë•Œë„ í†µí•© í…ŒìŠ¤íŠ¸ì— ì°¸ì—¬í•˜ëŠ” ê°€ëŠ¥í•œ í•œ ë§ì€ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“¤ì–´ë¼.
* ìŠ¤í”„ë§ í…ŒìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ë¥¼ ì´ìš©í•˜ëŠ” í…ŒìŠ¤íŠ¸ëŠ” í†µí•© í…ŒìŠ¤íŠ¸ë‹¤.

<br>

> í…ŒìŠ¤íŠ¸í•˜ê¸° í¸í•˜ê²Œ ë§Œë“¤ì–´ì§„ ì½”ë“œëŠ” ê¹”ë”í•˜ê³  ì¢‹ì€ ì½”ë“œê°€ ë  ê°€ëŠ¥ì„±ì´ ë†’ë‹¤!! í…ŒìŠ¤íŠ¸í•˜ì!!
