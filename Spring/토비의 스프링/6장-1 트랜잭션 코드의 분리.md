# ëª©ì°¨

<br>

- [ëª©ì°¨](#ëª©ì°¨)
- [1 íŠ¸ëœì­ì…˜ ì½”ë“œì˜ ë¶„ë¦¬](#1-íŠ¸ëœì­ì…˜-ì½”ë“œì˜-ë¶„ë¦¬)
  - [1-1 ë©”ì„œë“œ ì¶”ì¶œ](#1-1-ë©”ì„œë“œ-ì¶”ì¶œ)
  - [1-2 DI ì ìš©ì„ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ë¶„ë¦¬ (í”„ë¡ì‹œ íŒ¨í„´)](#1-2-di-ì ìš©ì„-ì´ìš©í•œ-íŠ¸ëœì­ì…˜-ë¶„ë¦¬-í”„ë¡ì‹œ-íŒ¨í„´)
  - [1-3 íŠ¸ëœì­ì…˜ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ - ì¤‘ìš”](#1-3-íŠ¸ëœì­ì…˜ê³¼-ë¹„ì¦ˆë‹ˆìŠ¤-ë¡œì§-ë‹¨ìœ„-í…ŒìŠ¤íŠ¸---ì¤‘ìš”)
  - [1-4 íŠ¸ëœì­ì…˜ ì½”ë“œ ë¶„ë¦¬ì˜ ì¥ì ](#1-4-íŠ¸ëœì­ì…˜-ì½”ë“œ-ë¶„ë¦¬ì˜-ì¥ì )

<br>


# 1 íŠ¸ëœì­ì…˜ ì½”ë“œì˜ ë¶„ë¦¬

ğŸ’â€â™‚ï¸ ì§€ê¸ˆê¹Œì§€ í•´ì˜¨ ê²ƒì²˜ëŸ¼ íŠ¸ëœì­ì…˜ ê´€ë ¨ëœ ì½”ë“œë¥¼ ë¶„ë¦¬í•´ë³´ì.

<br>

## 1-1 ë©”ì„œë“œ ì¶”ì¶œ
> [ë©”ì„œë“œ ì¶”ì¶œ ì½”ë“œ](https://github.com/binghe819/spring-toby-practice/commit/13a868d174874a7ed75c6714699810bdd8934848)
* í•µì‹¬ ë¡œì§: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
* ë¶€ê°€ ë¡œì§: íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •

<br>

## 1-2 DI ì ìš©ì„ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ë¶„ë¦¬ (í”„ë¡ì‹œ íŒ¨í„´)
> [DI ì ìš©ì„ ì´ìš©í•œ íŠ¸ëœì­ì…˜ ë¶„ë¦¬](https://github.com/binghe819/spring-toby-practice/commit/aad29b9939bd3f5c7149af8b66c90e2482b924d4)

**ì´ì œ `UserService`ì—ëŠ” ìˆœìˆ˜í•˜ê²Œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ ì¡´ì¬í•˜ê³ , íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì • ì½”ë“œëŠ” ì™¸ë¶€ë¡œ ë¹¼ë‚´ë³´ì.**

<br>

:scream: í˜„ì¬ `UserService` ê°•í•œ ê²°í•©ë„ë¡œ ê³ ì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì—, ì‚¬ì´ë¥¼ ë¹„ì§‘ê³  ë‹¤ë¥¸ ë¬´ì—‡ì¸ê°€ë¥¼ ì¶”ê°€í•˜ê¸° í˜ë“¤ë‹¤.

<p align="center"><img src="./image/IMG_B664AAD28E3E-1.jpeg" width="400"><br>ì§ì ‘ ì—°ê²°ì„ í†µí•œ ê°•í•œ ê²°í•©<br> ì¶œì²˜: í† ë¹„ì˜ ìŠ¤í”„ë§ vol.1</p>

<br>

ğŸ’â€â™‚ï¸ ê°€ì¥ ë¨¼ì € ì‹œë„í•´ë³¼ ë¦¬íŒ©í† ë§ì€ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë‘ê³  DIë¥¼ ì ìš©ì‹œí‚¤ëŠ” ê²ƒì´ë‹¤.

<p align="center"><img src="./image/IMG_1206D0B4BEF1-1.jpeg" width="400"><br>ì¸í„°í˜ì´ìŠ¤ ë„ì…ì„ í†µí•´ ì•½í•œ ê²°í•©ì„ ê°–ëŠ” ìœ ì—°í•œ êµ¬ì¡°<br>ì¶œì²˜: í† ë¹„ì˜ ìŠ¤í”„ë§ vol.1</p>

* ë³´í†µ **DIë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ **ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.
  * ì½”ë“œ ë ˆë²¨(ì»´íŒŒì¼)ë•Œ ì¶”ìƒì ì¸ ê²ƒ(ì¸í„°í˜ì´ìŠ¤)ì— ì˜ì¡´í•˜ê³ , ëŸ°íƒ€ì„ ì‹œì— DIë¥¼ í†µí•´ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë°”ê¿”ê°€ë©´ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•¨.
  * í…ŒìŠ¤íŠ¸ ë•ŒëŠ” í…ŒìŠ¤íŠ¸ êµ¬í˜„ í´ë˜ìŠ¤ë¥¼, ì •ì‹ ìš´ì˜ ì¤‘ì—ëŠ” ì •ê·œ ê·œí˜„ í´ë˜ìŠ¤ë¥¼ DI.
* **í•˜ì§€ë§Œ ê¼­ ìœ„ì™€ ê°™ì´ ì‚¬ìš©í•´ì•¼í•œë‹¤ëŠ” ì œì•½ì€ ì—†ë‹¤.**
  * **í•œ ë²ˆì— ë‘ ê°œì˜ `UserService` êµ¬í˜„ í´ë˜ìŠ¤ë¥¼ ë™ì‹œì— ì´ìš©í•  ìˆ˜ë„ ìˆë‹¤. -> í”„ë¡ì‹œ**

<br>

ğŸ’â€â™‚ï¸ í”„ë¡ì‹œ íŒ¨í„´

<p align="center"><img src="./image/IMG_9E1DC29B0215-1.jpeg" width="550"><br>íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ë¶„ë¦¬ë¥¼ ìœ„í•œ UserServiceTxë„ì… (í”„ë¡ì‹œ)<br>ì¶œì²˜: í† ë¹„ì˜ ìŠ¤í”„ë§ vol.1</p>

* `UserServiceImpl` : ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì—­í•  ë‹´ë‹¹ (ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬)
* `UserServiceTx` : íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ì—­í•  ë‹´ë‹¹
  * **`UserServiceImpl`ë¥¼ ìƒíƒœë¡œ ê°€ì§€ê³  ìˆìœ¼ë©°, íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •ì„ í•˜ê³ , ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬ë¥¼ `UserServiceImpl`ì—ê²Œ ìœ„ì„í•œë‹¤.**

<br>

<p align="center"><img src="./image/IMG_183722CD74F4-1.jpeg" width="500"><br>íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì˜ ê°ì²´ê°€ ì ìš©ëœ ì˜ì¡´ê´€ê³„ <br>ì¶œì²˜: í† ë¹„ì˜ ìŠ¤í”„ë§ vol.1</p>

<br>

:point_right: ì½”ë“œ

```java
// UserService ì¸í„°í˜ì´ìŠ¤
public interface UserService {
    void add(User user);
    void upgradeLevels();
}
```
```java
// ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹í•˜ëŠ” UserServiceImpl
public class UserServiceImpl implements UserService{

    private UserDao userDao;
    private MailSender mailSender;

    public UserServiceImpl(UserDao userDao, MailSender mailSender) {
        this.userDao = userDao;
        this.mailSender = mailSender;
    }

    ...

    public void upgradeLevels() {
        // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (í•µì‹¬ë¡œì§)
        List<User> users = userDao.getAll();
        for (User user : users) {
            if (canUpgradeLevel(user)) {
                upgradeLevel(user);
            }
        }
    }

    ...
}
```
```java
// íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •ì„ ë‹´ë‹¹í•˜ëŠ” UserServiceTx
public class UserServiceTx implements UserService {

    // UserServiceë¥¼ êµ¬í˜„í•œ ë‹¤ë¥¸ ê°ì²´ë¥¼ DI ë°›ëŠ”ë‹¤. (UserServiceImpl)
    private final UserService userService;
    private final PlatformTransactionManager transactionManager;

    public UserServiceTx(UserService userService,
        PlatformTransactionManager transactionManager) {
        this.userService = userService;
        this.transactionManager = transactionManager;
    }

    @Override
    public void add(User user) {
        userService.add(user); // ìœ„ì„
    }

    @Override
    public void upgradeLevels() {
        // íŠ¸ëœì­ì…˜ ê²½ê³„ ì„¤ì •
        TransactionStatus status = this.transactionManager.getTransaction(new DefaultTransactionDefinition());
        try {
            userService.upgradeLevels(); // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìœ„ì„
            this.transactionManager.commit(status);
        } catch (RuntimeException e) {
            this.transactionManager.rollback(status);
            throw e;
        }
    }
}
```

## 1-3 íŠ¸ëœì­ì…˜ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ - ì¤‘ìš”
ğŸ’â€â™‚ï¸  ì§€ê¸ˆê¹Œì§€ í”„ë¡ì‹œë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ê³¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ê°ì²´ë¥¼ ë¶„ë¦¬í•˜ì˜€ë‹¤. ì´ì œ í…ŒìŠ¤íŠ¸ ì½”ë“œë„ Mockì„ ì´ìš©í•´ ë¶„ë¦¬í•´ë³´ì.

<br>

**Mockì„ ì´ìš©í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í…ŒìŠ¤íŠ¸**

ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹í•˜ëŠ” `UserServiceImpl`ëŠ” `UserDao`ì™€ `MailSender`ì— ì˜ì¡´í•˜ê³  ìˆëŠ” ê°ì²´ì´ë©°, ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬ë¥¼ ì²˜ë¦¬í•œë‹¤.

ë‹¤ì‹œ ë§í•´, **`MockUserDao`ê³¼ `MockMailSender`ì„ ë§Œë“¤ì–´ í…ŒìŠ¤íŠ¸í•´ì•¼í•œë‹¤. (í˜¹ì€ Mockitoë¥¼ ì‚¬ìš©í•´ë„ ëœë‹¤.)**

ë˜í•œ, ì¤‘**ìš”í•œ ì ì€ íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •ì˜ ì±…ì„ì„ ë¶„ë¦¬í•˜ì˜€ê¸° ë•Œë¬¸ì—, íŠ¸ëœì­ì…˜ ê´€ë ¨ ê°ì²´(`UserServiceTx`)ëŠ” ì „í˜€ í•„ìš”ì—†ë‹¤.**

* [MockUserDao](https://github.com/binghe819/spring-toby-practice/blob/chapter06/src/test/java/com/binghe/service/MockUserDao.java)
* [MockMailSender](https://github.com/binghe819/spring-toby-practice/blob/chapter06/src/test/java/com/binghe/service/MockMailSender.java)

```java
@DisplayName("Mockì„ ì´ìš©í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ - íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ëº€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œì„ í…ŒìŠ¤íŠ¸í•œë‹¤.")
@Test
void upgradeLevels() {
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œì„ ì²˜ë¦¬í•˜ëŠ” UserService êµ¬í˜„ì²´
    UserServiceImpl userServiceImpl = new UserServiceImpl(); 
		
    MockUserDao mockUserDao = new MockUserDao(this.users);  
    userServiceImpl.setUserDao(mockUserDao);

    MockMailSender mockMailSender = new MockMailSender();
    userServiceImpl.setMailSender(mockMailSender);
    
    // Mock ê°ì²´ë“¤ì„ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê²Œ ëœë‹¤.
    userServiceImpl.upgradeLevels();

    // Mock ê°ì²´ ì•ˆì— ìƒíƒœë¥¼ ì¶”ê°€í•˜ì—¬ ìœ ì €ê°€ ë ˆë²¨ì—† ë˜ë©´ ë‚¨ê¸°ë„ë¡í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤. (Mockì˜ ì¥ì ì´ê¸°ë„ í•˜ë‹¤.)
    List<User> updated = mockUserDao.getUpdated();  
    assertThat(updated.size(), is(2));  
    checkUserAndLevel(updated.get(0), "joytouch", Level.SILVER); 
    checkUserAndLevel(updated.get(1), "madnite1", Level.GOLD);
    
    List<String> request = mockMailSender.getRequests();
    assertThat(request.size(), is(2));
    assertThat(request.get(0), is(users.get(1).getEmail()));
    assertThat(request.get(1), is(users.get(3).getEmail()));
}
```

<br>

<br>

**íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸**

ğŸ’â€â™‚ï¸  ì´ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ ì˜ ë™ì‘í•œë‹¤ëŠ” ê²ƒì„ í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ë³´ì¥í–ˆë‹¤ë©´, íŠ¸ëœì­ì…˜ë„ ì˜ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•´ì•¼í•œë‹¤.

```java
@DisplayName("íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸ - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ë¡œì§ í†µí•© í…ŒìŠ¤íŠ¸")
@Test
public void upgradeAllOrNothing() {
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬ UserService
    TestUserService testUserService = new TestUserService(users.get(3).getId());
    testUserService.setUserDao(userDao);
    testUserService.setMailSender(mailSender);
    
    // íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • UserService
    UserServiceTx txUserService = new UserServiceTx();
    txUserService.setTransactionManager(transactionManager);
    txUserService.setUserService(testUserService); // UserServiceImplë¥¼ ì£¼ì…í•œë‹¤. (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬ë¥¼ ìœ„í•¨)
        
    userDao.deleteAll();			  
    for(User user : users) userDao.add(user);
    
    try {
        assertThatThrownBy(() -> userServiceTx.upgradeLevels())
                .isInstanceOf(TestUserServiceException.class);
    }
    catch(TestUserServiceException e) { 
    }
    
    checkLevelUpgraded(users.get(1), false);
}
```
* **ë‚´ìš©ì´ ê¸¸ì–´ë³´ì´ì§€ë§Œ, ì‚¬ì‹¤ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ë¡œì§ì„ ë¶„ë¦¬ì‹œí‚¤ê³ , ë”°ë¡œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•œ ê²ƒì´ë‹¤.**

> [ì „ì²´ ì½”ë“œ](https://github.com/binghe819/spring-toby-practice/blob/chapter06/src/test/java/com/binghe/service/UserServiceTest.java)

<br>

## 1-4 íŠ¸ëœì­ì…˜ ì½”ë“œ ë¶„ë¦¬ì˜ ì¥ì 

1. **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ë¡œì§ì˜ ë¶„ë¦¬**
   * ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹í•˜ëŠ” `UserServiceImpl` ì½”ë“œì—ì„  íŠ¸ëœì­ì…˜ê³¼ ê°™ì€ ê¸°ìˆ ì ì¸ ë‚´ìš©ì€ ì „í˜€ ì‹ ê²½ì“°ì§€ ì•Šì•„ë„ ëœë‹¤.
   * **íŠ¸ëœì­ì…˜ì˜ ì ìš©ì´ í•„ìš”í•œì§€ë„ ì‹ ê²½ì“°ì§€ ì•Šì•„ë„ ëœë‹¤. ë§Œì•½ ì ìš©ì‹œí‚¤ê³  ì‹¶ë‹¤ë©´ `UserServiceTx`ì™€ ê°™ì´ íŠ¸ëœì­ì…˜ ê¸°ëŠ¥ì„ ê°€ì§„ ê°ì²´ê°€ ë¨¼ì € ì‹¤í–‰ë˜ë„ë¡ ë§Œë“¤ê¸°ë§Œ í•˜ë©´ ëœë‹¤.**
2. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì†ì‰½ê²Œ ë§Œë“¤ì–´ë‚¼ ìˆ˜ ìˆë‹¤.
   * ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ íŠ¸ëœì­ì…˜ ë¡œì§ì˜ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ë”°ë¡œ í•  ìˆ˜ ìˆë‹¤.
