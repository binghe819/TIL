<img src="./image/800x0.png" width="250" />

[í† ë¹„ì˜ ìŠ¤í”„ë§](http://www.yes24.com/Product/Goods/76074405?OzSrank=2)ì„ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±í•œ ìë£Œì…ë‹ˆë‹¤.



# ëª©ì°¨









# 5ì¥ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

ğŸ’â€â™‚ï¸ 5ì¥ì˜ ë‚´ìš©

5ì¥ì—ì„œëŠ” `DAO` ì— íŠ¸ëœì­ì…˜ì„ ì ìš©í•´ë³´ë©´ì„œ ìŠ¤í”„ë§ì´ ì–´ë–»ê²Œ ì„±ê²©ì´ ë¹„ìŠ·í•œ ì—¬ëŸ¬ ì¢…ë¥˜ì˜ ê¸°ìˆ ì„ ì¶”ìƒí™”í•˜ê³  ì´ë¥¼ ì¼ê´€ëœ ë°©ë²•ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ëŠ”ì§€ë¥¼ ì‚´í´ë³¸ë‹¤.



## 1 ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬ ê¸°ëŠ¥ ì¶”ê°€

ğŸ™‹â€â™‚ï¸ ì§€ê¸ˆê¹Œì§€ ê³„ì†í•´ì„œ `DAO` ë¡œì§ë§Œì„ ë§Œë“¤ì—ˆë‹¤. ì´ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë§Œë“¤ì–´ë³´ì.

ì•„ë˜ì™€ ê°™ì€ ê¸°ëŠ¥ì„ ê°€ì§„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë§Œë“¤ê³ ì í•œë‹¤.

* ì‚¬ìš©ì ë ˆë²¨ì€ BASIC, SILVER, GOLD
  * ì²˜ìŒ ê°€ì…í•˜ë©´ BASIC, í™œë™ì— ë”°ë¼ ë ˆë²¨ì—…
* ì‚¬ìš©ì ë ˆë²¨ì˜ ë³€ê²½ ì‘ì—…ì€ ì¼ì •í•œ ì£¼ê¸°ë¥¼ ê°€ì§€ê³  ì¼ê´„ì ìœ¼ë¡œ ì§„í–‰ëœë‹¤.
  * ë³€ê²½ ì‘ì—… ì „ì—ëŠ” ì¡°ê±´ì„ ì¶©ì¡±í•˜ë”ë¼ë„ ë ˆë²¨ì˜ ë³€ê²½ì´ ì¼ì–´ë‚˜ì§€ ì•ŠëŠ”ë‹¤.



ğŸ™‹â€â™‚ï¸ **ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ëŠ” ì‘ì—…ì€ ì•„ë˜ì™€ ê°™ë‹¤.**

* í•„ë“œ ì¶”ê°€
  * `Level` í•„ë“œ ì¶”ê°€
  * `User` í•„ë“œ ì¶”ê°€ (ë¡œê·¸ì¸ íšŸìˆ˜, ì¶”ì²œìˆ˜, ë ˆë²¨)
  * `UserDao` í…ŒìŠ¤íŠ¸ ìˆ˜ì •
  * `UserDaoJdbc` ìˆ˜ì •
* ì‚¬ìš©ì ìˆ˜ì • ê¸°ëŠ¥ ì¶”ê°€



### 1-1 í•„ë“œ ì¶”ê°€

#### Level í•„ë“œ ì¶”ê°€

ğŸ™‹â€â™‚ï¸ ì‚¬ìš©ìë§ˆë‹¤ `Level` ì´ë¼ëŠ” í•„ë“œë¥¼ ì¶”ê°€í•´ì£¼ì.

* DBì— ë¬¸ìì—´(`BASIC`)ì„ ì €ì¥í•˜ëŠ” ê²ƒ ë³´ë‹¤ëŠ” ì •ìˆ˜ì¸ 1, 2, 3ì„ ì €ì¥í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.
  * DBì— ì €ì¥í•  ë•ŒëŠ” ìˆ«ìë¡œ ë³€ê²½í•´ì„œ ì €ì¥í•˜ê³ 
  * DBì—ì„œ ì¡°íšŒí•  ë•ŒëŠ” `enum` ê°’ìœ¼ë¡œ ë³€ê²½í•´ì„œ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

```java
public enum Lever {
  BASIC(1), SILVER(2), GOLD(3);
  
  private final int value;
  
  // DBì— ì €ì¥í•  ê°’ì„ ë„£ì–´ì¤„ ìƒì„±ìë¥¼ ë§Œë“¤ì–´ë‘”ë‹¤.
  Level(int value){
    this.value = value;
  }
  
  // ê°’ì„ ê°€ì ¸ì˜¤ëŠ” ë©”ì„œë“œ
  public int intValue(){
    return value;
  }
  
  // DBì—ì„œ ìˆ«ì ê°’ì„ ë°›ì•„ì™€ì„œ ê°’ìœ¼ë¡œë¶€í„° Levelíƒ€ì… ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ë„ë¡ ë§Œë“  ìŠ¤íƒœí‹± ë©”ì„œë“œ.
  public static Level valueOf(int value){
    switch(value){
      case 1: return BASIC;
      case 2: return SILVER;
      case 3: return GOLD;
      default: throw new AssertionError("Unknown value: " + value);
    }
  }
}
```

ğŸ¤” `enum`ì„ ì‚¬ìš©í•œ ì´ìœ ëŠ”?

* ì •ìˆ˜í˜• ìƒìˆ˜ ê°’(`private static final int BASIC = 1`)ì„ ì‚¬ìš©í•˜ë©´ ì—‰ëš±í•œ ê°’ì„ ë„£ì—ˆì„ ë•Œ ì»´íŒŒì¼ëŸ¬ê°€ ì²´í¬í•´ì£¼ì§€ ëª»í•œë‹¤. 
  * `user.setLevel(1000)` ì„ í•´ë„ ì»´íŒŒì¼ëŸ¬ê°€ ì¡ì•„ë‚´ì§€ ëª»í•œë‹¤.
* `enum` ì€ ì •ìˆ˜ ê°’ì„ ê°€ì§€ê³  ìˆì§€ë§Œ, ê²‰ìœ¼ë¡œëŠ” `Level` íƒ€ì…ì˜ ê°ì²´ê¸° ë•Œë¬¸ì— ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
  * **ìƒíƒœê°€ ì•„ë‹Œ í•˜ë‚˜ì˜ ììœ¨ì ì¸ ê°ì²´ê°€ ë  ìˆ˜ ìˆëŠ” ê¸°íšŒ.**



#### Userí•„ë“œ ì¶”ê°€

ğŸ™‹â€â™‚ï¸ ë ˆë²¨ì„ ë§Œë“¤ì—ˆìœ¼ë‹ˆ, DBì™€ `User` ê°ì²´ì˜ ìƒíƒœë¥¼ ë³€ê²½í•´ì¤˜ì•¼ í•œë‹¤.

```java
public class User {
  ...
  Level level; 
  int login; // ë¡œê·¸ì¸ íšŸìˆ˜
  int recommend; // ì¶”ì²œìˆ˜
  
  // getter / setter
}
```

* `User` ë¿ë§Œ ì•„ë‹ˆë¼ DBë„ 3ê°€ì§€ì˜ ìƒíƒœë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.
  * Level/tinyint/NotNull
  * Login/int/NotNull
  * Recommend/int/NotNull



#### UserDaoTest ìˆ˜ì •

ë³€ê²½ëœ ì½”ë“œëŠ” [UserDaoTest ì½”ë“œ](https://github.com/binghe819/toby-spring-code/blob/master/Ch05/src/test/java/com/binghe/dao/UserDaoJdbcTemplateTest.java) ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë©°, ë³€ê²½ëœ ë‚´ìš©ì€ ì•„ë˜ì™€ ê°™ë‹¤.

* `User` ìƒì„±ì‹œ ìƒˆë¡œ ìƒê¸´ 3ê°€ì§€ ìƒíƒœë¥¼ ì¶”ê°€ ì¸ìë¡œ ë„£ì–´ì¤¬ë‹¤.
  
* `new User("ì•„ì´ë””", "ì´ë¦„", "ë¹„ë°€ë²ˆí˜¸", Level.BASIC, 1, 0);`
  
* ë‘ ê°ì²´ì˜ ë™ë“±ì„±ì„ ì²´í¬í•˜ëŠ” `checkSameUser` ì— ìƒˆë¡œ ìƒê¸´ 3ê°€ì§€ ìƒíƒœë¥¼ ë¹„êµí•˜ëŠ” ë¡œì§ë„ ì¶”ê°€ì£¼ì—ˆë‹¤.

  * ```java
    ...
    assertEquals(user1.getLevel().intValue(), user2.getLevel().intValue());
    assertEquals(user1.getLogin(), user2.getLogin());
    assertEquals(user1.getRecommend(), user2.getRecommend());
    ```

> **ì¤‘ìš”í•œ ê²ƒì€ DBì— ì €ì¥í•  ë•ŒëŠ” `intValue()` ë¥¼ í†µí•´ `Level` ì„ ìˆ«ìë¡œ ì €ì¥í•œë‹¤ëŠ” ê²ƒì´ë‹¤.**



#### UserDaoJdbc ìˆ˜ì •

ë³€ê²½ëœ ì½”ë“œëŠ” [UserDaoJdbc](https://github.com/binghe819/toby-spring-code/blob/master/Ch05/src/main/java/com/binghe/dao/UserDaoJdbcTemplate.java) ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë©°, ë³€ê²½ëœ ë‚´ìš©ì€ ì•„ë˜ì™€ ê°™ë‹¤.

* `RowMapper` ì—ì„œ ìƒˆë¡œ ìƒê¸´ 3ê°€ì§€ ìƒíƒœë„ ì¶”ê°€í•´ì£¼ì—ˆë‹¤.

  * ```java
    user.setLevel(Level.valueOf(resultSet.getInt("level")));
    user.setLogin(resultSet.getInt("login"));
    user.setRecommend(resultSet.getInt("recommend"));
    ```

  * **ì¤‘ìš”í•œ ê²ƒì€ DBì—ì„œ ê°€ì ¸ì˜¨ ì •ìˆ˜í˜• ë ˆë²¨ì„ `Level` ì´ë¼ëŠ” `enum` ê°ì²´ë¡œ ë³€ê²½í•œë‹¤ëŠ” ê²ƒì´ë‹¤.**



### 1-2 ì‚¬ìš©ì ìˆ˜ì • ê¸°ëŠ¥ ì¶”ê°€

ğŸ™‹â€â™‚ï¸ **ìˆ˜ì •í•  ì •ë³´ê°€ ë‹´ê¸´ `User` ê°ì²´ë¥¼ ì „ë‹¬í•˜ë©´ `id` ë¥¼ ì°¸ê³ í•´ì„œ ì—…ë°ì´íŠ¸í•´ì£¼ëŠ” ë¡œì§ì„ ë§Œë“¤ì–´ì£¼ì.**



#### ìˆ˜ì • ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì¶”ê°€

```java
@Test
void update(){
    userDao.deleteAll();

    userDao.add(user1);
    userDao.add(user2);

    user1.setName("ë³€ê²½ ì•„ì´ë””");
    user1.setPassword("test1234");
    user1.setLevel(Level.GOLD);
    user1.setLogin(1000);
    user1.setRecommend(999);

    userDao.update(user1);

    User user1update = userDao.get(user1.getId());
    checkSameUser(user1, user1update);
    User user2same = userDao.get(user2.getId());
    checkSameUser(user2, user2same);
}
```

* `user1` ì˜ ìƒíƒœë¥¼ ìˆ˜ì •í•˜ê³  DBì— ì—…ë°ì´íŠ¸í•˜ê³ ë‚˜ì„œ ì¡°íšŒí•œ í›„ì— ë™ì¼í•œ ê°’ì„ ê°€ì§„ ê°ì²´ì¸ì§€ í™•ì¸í•œë‹¤.



#### UserDaoì™€ UserDaoJdbc ìˆ˜ì •

ğŸ™‹â€â™‚ï¸ í…ŒìŠ¤íŠ¸ì½”ë“œë¥¼ ë¨¼ì € ì‘ì„±í•˜ê³  ë¡œì§ì„ ìˆ˜ì •í•˜ì˜€ë‹¤. (ë°°ì›Œì•¼ í•  ì )

* í…ŒìŠ¤íŠ¸ì½”ë“œì—ì„œ `update` ë©”ì„œë“œê°€ ìƒˆë¡œ ìƒê²¼ìœ¼ë‹ˆ ì´ê²ƒì„ ì¶”ê°€í•´ì£¼ë©´ ëœë‹¤.

```java
public void update(User user) {
    this.jdbcTemplate.update(
            "update users set name = ?, password = ? , level = ?, login = ?, recommend = ? where id = ?",
            user.getName(), user.getPassword(), user.getLevel().intValue(), user.getLogin(), user.getRecommend(), user.getId());
}
```

í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ëŒë¦¬ë©´ ì˜ ë™ì‘í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.



### 1-3 ì„œë¹„ìŠ¤ ë¡œì§ êµ¬í˜„ - upgradeLevels

ğŸ™‹â€â™‚ï¸ `DAO` ë¡œì§ê³¼ ì„œë¹„ìŠ¤ ë¡œì§ì˜ ì°¨ì´

* `DAO` : ë°ì´í„° ì•¡ì„¸ìŠ¤ ë¡œì§ (Persistence Layer)
  * ë°ì´í„°ë¥¼ ì–´ë–»ê²Œ ê°€ì ¸ì˜¤ê³  ì¡°ì‘í• ì§€ë¥¼ ë‹¤ë£¨ëŠ” ê³„ì¸µ
* ì„œë¹„ìŠ¤ ë¡œì§ : ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (Service Layer)
  * ë°ì´í„°ì— ëŒ€í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìˆ˜í–‰.



#### upgradeLevels êµ¬í˜„

ğŸ™‹â€â™‚ï¸ ì£¼ê¸°ì ìœ¼ë¡œ ìœ ì €ë“¤ì˜ ë ˆë²¨ì„ ì²´í¬í•˜ê³  ì—…ê·¸ë ˆì´ë“œ ì‹œì¼œì£¼ëŠ” ë¡œì§

```java
public class UserService {
  
	  private static final int MIN_LOGCOUNT_FOR_SILVER = 50;
    private static final int MIN_RECCOMEND_FOR_GOLD = 30;

    private UserDao userDao;

    @Autowired
    public void setUserDao(UserDao userDao) {
        this.userDao = userDao;
    }
    
    public void upgradeLevels(){
        List<User> users = userDao.getAll();
        for(User user : users){
            boolean changed = false;
            if(user.getLevel() == Level.BASIC && user.getLogin() >= UserService.MIN...){
                user.setLevel(Level.SILVER);
                changed = true;
            } else if(user.getLevel() == Level.SILVER && user.getRecommend() >= US.MIN...){
                user.setLevel(Level.GOLD);
                changed = true;
            }
            if(changed){
                userDao.update(user);
            }
        }
    }
}
```

* `upgradeLevels` ëŠ” ê° íšŒì›ë“¤ì˜ ìƒíƒœë¥¼ í™•ì¸í•˜ì—¬ ë ˆë²¨ì„ ì¡°ì ˆí•œë‹¤.
  * **ë¬¸ì œëŠ” ì½”ë“œê°€ ë§¤ìš° ë‚œì¡í•˜ë‹¤ëŠ” ê²ƒ. ì¶”í›„ì— ë¦¬íŒ©í† ë§ì„ í•œë‹¤.**



#### upgradeLevels í…ŒìŠ¤íŠ¸

```java
@ExtendWith(SpringExtension.class)
@SpringJUnitConfig(Config.class)
class UserServiceTest {

    List<User> users;

    @BeforeEach
    void setUp(){
        users = Arrays.asList(
                new User("binghe", "ê¹€ë³‘í™”", "test1", Level.BASIC, 49, 0),
                new User("honggildong", "í™ê¸¸ë™", "test2", Level.BASIC, 50, 0),
                new User("springtoby", "í† ë¹„ë‹˜", "test3", Level.SILVER, 60, 29),
                new User("java", "ìë°”", "java1234", Level.SILVER, 60, 30),
                new User("service", "ì„œë¹„ìŠ¤", "service", Level.GOLD, 100, 100)
        );
    }

    @DisplayName("ë ˆë²¨ ì²´í¬ í…ŒìŠ¤íŠ¸")
    @Test
    void upgradeLevels(){
        userDao.deleteAll();
        for(User user : users)
            userDao.add(user);

        userService.upgradeLevels();

        checkLevel(users.get(0), Level.BASIC);
        checkLevel(users.get(1), Level.SILVER);
        checkLevel(users.get(2), Level.SILVER);
        checkLevel(users.get(3), Level.GOLD);
        checkLevel(users.get(4), Level.GOLD);
    }

    private void checkLevel(User user, Level expectedLevel){
        User userUpdate = userDao.get(user.getId());
        assertEquals(expectedLevel, userUpdate.getLevel());
    }

}
```

* ë‹¤ì„¯ëª…ì˜ ìœ ì €ë¥¼ ì €ì¥í•˜ê³ , ë ˆë²¨ì´ ì—…ê·¸ë ˆì´ë“œ ë˜ëŠ”ì§€ ì²´í¬í•˜ëŠ” ì½”ë“œ.



### 1-4 ì„œë¹„ìŠ¤ ë¡œì§ êµ¬í˜„ - add

ğŸ™‹â€â™‚ï¸ íšŒì›ê°€ì… ì„œë¹„ìŠ¤ ë¡œì§ì„ êµ¬í˜„í•´ë³´ì.

* ì²˜ìŒ ê°€ì…í•˜ë©´ ë ˆë²¨ì€ `BASIC` ì´ì—¬ì•¼ í•œë‹¤.



#### add í…ŒìŠ¤íŠ¸

```java
@Test
void add(){
    userDao.deleteAll();

    User userWithLevel = users.get(4); // GOLD ë ˆë²¨ì¸ ìœ ì €ì´ë¯€ë¡œ ë ˆë²¨ì„ ì´ˆê¸°í™”í•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.
    User userWithoutLevel = users.get(0);
    userWithoutLevel.setLevel(null); // ë ˆë²¨ì´ ë¹„ì–´ ìˆìœ¼ë¯€ë¡œ ë¡œì§ì— ë”°ë¼ ë“±ë¡ ì¤‘ BASICë ˆë²¨ë¡œ ì„¤ì •ë˜ì•¼í•œë‹¤.

    userService.add(userWithLevel);
    userService.add(userWithoutLevel);

    User userWithLevelRead = userDao.get(userWithLevel.getId());
    User userWithoutLevelRead = userDao.get(userWithoutLevel.getId());

    assertEquals(userWithLevel.getLevel(), userWithLevelRead.getLevel());
    assertEquals(userWithoutLevel.getLevel(), userWithoutLevelRead.getLevel());
}
```

* ë ˆë²¨ì´ ì´ë¯¸ ì •í•´ì§„ ìœ ì €ì™€ ë ˆë²¨ì´ ì •í•´ì§€ì§€ ì•Šì€ ìœ ì €ë¥¼ ìƒì„±í•˜ì—¬ ë ˆë²¨ì´ ì—†ëŠ” ê²½ìš° ì´ˆê¸°í™”ë¥¼ í•˜ëŠ” ë¡œì§ì„ í…ŒìŠ¤íŠ¸í•œë‹¤.



#### addë¡œì§

```java
public void add(User user) {
    if(user.getLevel() == null){
        user.setLevel(Level.BASIC);
    }
    userDao.add(user);
}
```



### 1-5 ì½”ë“œ ê°œì„ í•˜ê¸°

ğŸ™‹â€â™‚ï¸ ì½”ë“œë¥¼ ë¦¬íŒ©í† ë§í•´ë³´ì. ë¦¬íŒ©í† ë§ ë‚´ìš©

* ì½”ë“œì— ì¤‘ë³µëœ ë¶€ë¶„ì€ ì—†ëŠ”ê°€?
* ì½”ë“œê°€ ë¬´ì—‡ì„ í•˜ëŠ” ê²ƒì¸ì§€ ì´í•´í•˜ê¸° ë¶ˆí¸í•˜ì§€ ì•ŠëŠ”ê°€?
* ì½”ë“œê°€ ìì‹ ì´ ìˆì–´ì•¼ í•  ìë¦¬ì— ìˆëŠ”ê°€?
* ì•ìœ¼ë¡œ ë³€ê²½ì´ ì¼ì–´ë‚œë‹¤ë©´ ì–´ë–¤ ê²ƒì´ ìˆì„ ìˆ˜ ìˆê³ , ê·¸ ë³€í™”ì— ì‰½ê²Œ ëŒ€ì‘í•  ìˆ˜ ìˆê»˜ ì‘ì„±ë˜ì–´ ìˆëŠ”ê°€?



#### upgradeLevels ì½”ë“œ ë¶„ë¦¬

:scream: ê¸°ì¡´ `UserSerivce.upgradeLevels` ì˜ ë¬¸ì œ

* ë ˆë²¨ ê°œìˆ˜ë§Œí¼ ifë¬¸ì´ ë°˜ë³µëœë‹¤. ë§Œì•½ ìƒˆë¡œìš´ ë ˆë²¨ì´ ì¶”ê°€ëœë‹¤ë©´ `Level` ì´ëŠ„ë„ ìˆ˜ì •í•´ì•¼ í•˜ê³ , `upgradeLevels` ì˜ ë¡œì§ë„ ë³€ê²½ì´ í•„ìš”í•˜ë‹¤.
* ì´í•´í•˜ê¸° í˜ë“¤ë‹¤.

ğŸ¤” í•´ê²°ë°©ë²•ì€?

* ëª¨ë“  ê°ì²´ë¥¼ ììœ¨ì ì¸ ê°ì²´ë¡œ ë§Œë“¤ì–´ì£¼ë©´ ëœë‹¤. -> ì½”ë“œë¥¼ ë¶„ë¦¬í•´ë³´ì.

##### 1ì°¨ ë¦¬íŒ©í† ë§

```java
public void upgradeLevels(){
    List<User> users = userDao.getAll();
    for(User user : users){
        if(canUpgradeLevel(user)){
            upgradeLevel(user);
        }
    }
}

private boolean canUpgradeLevel(User user) {
    Level currentLevel = user.getLevel();
    switch (currentLevel){
        case BASIC: return (user.getLogin() >= 50);
        case SILVER: return (user.getRecommend() >= 30);
        case GOLD: return false;
        // í˜„ì¬ ë¡œì§ì´ ë‹¤ë£° ìˆ˜ ì—†ëŠ” ë ˆë²¨ì¸ ê²½ìš° ì˜ˆì™¸ë¥¼ ë˜ì§„ë‹¤.
        default: throw new IllegalArgumentException("Unknown Level : "+currentLevel);
    }
}

private void upgradeLevel(User user) {
    if(user.getLevel() == Level.BASIC) user.setLevel(Level.SILVER);
    else if(user.getLevel() == Level.SILVER) user.setLevel(Level.GOLD);
    userDao.update(user);
}
```

`upgradeLevels` ì˜ ë¡œì§ì´ ë§¤ìš° ê°„ë‹¨í•´ì¡Œë‹¤.

* ëª¨ë“  ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì™€ í•œ ëª…ì”© ì—…ê·¸ë ˆì´ë“œê°€ ê°€ëŠ¥í•œì§€ í™•ì¸í•˜ê³  (`if(canUpgradeLevel(users))`)
* ê°€ëŠ¥í•˜ë©´ ì—…ê·¸ë ˆì´ë“œë¥¼ í•œë‹¤. (`upgradeLevel(user)`)

> **ë˜í•œ í˜„ì¬ ë¡œì§ì´ ë‹¤ë£° ìˆ˜ ì—†ëŠ” ë ˆë²¨(ì˜ˆì™¸)ì¸ ê²½ìš°ëŠ” ê¼­ ì˜ˆì™¸ë¥¼ í†µí•´ ê°œë°œìê°€ ì–´ë–¤ ì˜ˆì™¸ê°€ ë°œìƒí–ˆëŠ”ì§€ ì•Œ ìˆ˜ ìˆê²Œ í•´ì•¼í•œë‹¤.**



##### 2ì°¨ ë¦¬íŒ©í† ë§

> ë°ì´í„°(`Level`)ë§Œ ê°€ì ¸ì™€ì„œ í”„ë¡œì„¸ìŠ¤(`UserService`)ì—ì„œ ë‹¤ìŒ ë‹¨ê³„ ë ˆë²¨ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì€ **ì ˆì°¨ì§€í–¥ì ** ì½”ë“œì´ë‹¤.
>
> **ê°ì²´ì§€í–¥ì **ì½”ë“œëŠ” ë°ì´í„°ì™€ í”„ë¡œì„¸ìŠ¤ë¥¼ ëª¨ë‘ ê°ì²´ ìì‹ ì´ ê°€ì§€ê³  ìˆëŠ”ë‹¤. (ììœ¨ì ì¸ ê°ì²´)

[1ì°¨ ë¦¬íŒ©í† ë§](#1ì°¨-ë¦¬íŒ©í† ë§)ì—ì„œ ì½”ë“œë¥¼ ê°„ë‹¨íˆ ë¶„ë¦¬í–ˆì§€ë§Œ, **ì—¬ì „íˆ ìƒˆë¡œìš´ ë ˆë²¨ì„ ì¶”ê°€í•˜ë©´ ë§ì€ ë¡œì§ë“¤ì„ ë³€ê²½í•´ì¤˜ì•¼í•œë‹¤. (ë³€ê²½ì— ì·¨ì•½í•˜ë‹¤.)**

**ê° ì½”ë“œë¥¼ ë¶„ë¦¬í•˜ê³ , ë©”ì‹œì§€ë¥¼ í†µí•œ ìš”ì²­ìœ¼ë¡œ ë¡œì§ì„ ì²˜ë¦¬í•˜ë„ë¡ ë³€ê²½í•´ì•¼í•œë‹¤.**

* `Level` ì—ì„œ ë‹¤ìŒ ë‹¨ê³„ì˜ ë ˆë²¨ ì •ë³´ë¥¼ ì§ì ‘ ê°€ì§€ê³  ìˆê²Œí•œë‹¤.
* ì‚¬ìš©ì ì •ë³´ë¥¼ ë°”ê¾¸ëŠ” ë¡œì§ì„ `UserService` ê°€ ì•„ë‹Œ `User` ê°€ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ í•œë‹¤. (ììœ¨ì ì¸ ê°ì²´)
  * `User` ì˜ ìƒíƒœë¥¼ ë°”ê¾¸ëŠ” í–‰ìœ„(ë ˆë²¨ì˜ ì—…ê·¸ë ˆì´ë“œ)ì´ë¯€ë¡œ `User` ìì‹ ì´ ì²˜ë¦¬í•˜ê³ , `UserService` ëŠ” ë©”ì‹œì§€ë¥¼ í†µí•´ ìš”ì²­í•˜ëŠ” ë°©ì‹.

```java
public enum Level {
	  // DBì— ì €ì¥í•  ê°’ê³¼ í•¨ê»˜ ë‹¤ìŒ ë‹¨ê³„ì˜ ë ˆë²¨ ì •ë³´ë„ ì¶”ê°€í•œë‹¤.
    GOLD(3, null), SILVER(2, GOLD), BASIC(1, SILVER);

    private final int value;
    private final Level next;

    // DBì— ì €ì¥í•  ê°’ì„ ë„£ì–´ì¤„ ìƒì„±ìë¥¼ ë§Œë“¤ì–´ë‘”ë‹¤
    Level(int value, Level next){
        this.value = value;
        this.next = next;
    }

    // ê°’ì„ ê°€ì ¸ì˜¤ëŠ” ë©”ì„œë“œ
    public int intValue(){
        return value;
    }
    
    public Level nextLevel() { return this.nextLevel(); }

    public static Level valueOf(int value){
        switch (value){
            case 1: return BASIC;
            case 2: return SILVER;
            case 3: return GOLD;
            default: throw new AssertionError("Unknown value: " + value);
        }
    }
}
```

```java
public class User {
  ...
    
  public void upgradeLevel(){
    Level nextLevel = this.level.nextLevel();
    if(nextLevel == null)
      throw new IllegalStateException(this.level + "ì€ ì—…ê·¸ë ˆì´ë“œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.");
    else
      this.level = nextLevel;
  }
  
  ...
}
```

```java
public class UserService {
  ...
  
  private void upgradeLevel(User user){
    user.upgradeLevel(); // ë ˆë²¨ì„ ì—…ê·¸ë ˆì´ë“œí•´ë‹¬ë¼ê³  Userì—ê²Œ ìš”ì²­.
    userDao.update(user);
  }
  
  ...
}
```





#### User í…ŒìŠ¤íŠ¸

`User` ì˜ ì½”ë“œê°€ ì¶”ê°€ë˜ì—ˆìœ¼ë¯€ë¡œ `User` ì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ëŠ” ê²ƒì´ ì¢‹ë‹¤. [User í…ŒìŠ¤íŠ¸ ì½”ë“œ](https://github.com/binghe819/toby-spring-code/blob/master/Ch05/src/test/java/com/binghe/domain/UserTest.java)

ì§€ê¸ˆì€ í•„ìš” ì—†ì–´ë³´ì´ì§€ë§Œ, ì‹œìŠ¤í…œì´ ì»¤ì ¸ì„œ ì–´ë–¤ ë¬¸ì œê°€ ë°œìƒí• ì§€ ëª¨ë¥´ê¸°ë•Œë¬¸ì— í•´ì£¼ëŠ” ê²ƒì´ ì¢‹ë‹¤.

> `User` ëŠ” POJOì´ê¸°ì— `Extension` ì—†ì´ í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•˜ë‹¤.



#### UserService í…ŒìŠ¤íŠ¸

ë¦¬íŒ©í† ë§ì„ í†µí•´ ë§ì€ ì½”ë“œë¥¼ ë³€ê²½í–ˆìœ¼ë¯€ë¡œ, ë³€ê²½ì— ë§ì¶° `UserService` ì˜ í…ŒìŠ¤íŠ¸ë„ ë³€ê²½í•´ì¤˜ì•¼í•œë‹¤.

( ê°€ì¥ ì¢‹ì€ ê±´ í…ŒìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì™„ì„±ì‹œí‚¤ê³ , ì½”ë“œë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒ ê°™ë‹¤... ì½”ë“œë¥¼ ì‘ì„±í•˜ê³  í…ŒìŠ¤íŠ¸ ì‘ì„±í•˜ë ¤ë‹ˆ ê·€ì°®ë‹¤..)



#### ì—…ê·¸ë ˆì´ë“œ ì •ì±… ë¶„ë¦¬

ë§Œì•½ ì—°ë§ ì´ë²¤íŠ¸ë‚˜ ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ í™ë³´ê¸°ê°„ ì¤‘ì—ëŠ” ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ ì •ì±…ì´ ë³€ê²½í•´ì•¼í•˜ëŠ” ê²½ìš°ê°€ ìˆë‹¤.

ì´ëŸ´ ê²½ìš°, ë§¤ë²ˆ `UserService` ë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒì€ ë²ˆê±°ëŸ½ê³  ìœ„í—˜í•œ ë°©ë²•ì´ë‹¤.

ì´ëŸ´ ë• ì‚¬ìš©ì ì—…ê·¸ë ˆì´ë“œ ì •ì±…ì„ ë”°ë¡œ ë¶„ë¦¬í•˜ì.

```java
public interface UserLevelUpgradePolicy {
  boolean canUpgradeLevel(User user);
  void upgradeLevel(User user);
}
```



## 2 íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

ğŸ™‹â€â™‚ï¸ ì‚¬ìš©ì ë ˆë²¨ ê´€ë¦¬ì˜ ë¬¸ì œ

* ë§Œì•½ ì‚¬ìš©ì ë ˆë²¨ì„ ê´€ë¦¬í•˜ëŠ” ë„ì¤‘ì— ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ë‚˜ ë‹¤ì–‘í•œ ì—ëŸ¬ì˜ ì˜í•´ ì‹œìŠ¤í…œì´ ì¢…ë£Œëœë‹¤ë©´ ì–´ë–¤ ì‚¬ìš©ìëŠ” ë ˆë²¨ ì—…ì´ ë˜ì–´ìˆê³ , ì–´ë–¤ ì‚¬ìš©ìëŠ” ì•ˆë  ìˆ˜ ìˆë‹¤.

ì´ëŸ´ë•Œ íŠ¸ë™ì­ì…˜ì„ ì‚¬ìš©í•´ì„œ ëª¨ë“  ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ì´ˆê¸°ë¡œ ëŒë ¤ë†”ì•¼í•œë‹¤.



### 2-1 íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸ì½”ë“œ ì‘ì„±

ğŸ™‹â€â™‚ï¸ íŠ¸ëœì­ì…˜ ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸° ì „ì— íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸ë¥¼ ë¨¼ì € ë§Œë“ ë‹¤.

* í…ŒìŠ¤íŠ¸ì˜ ë¡œì§
  * 5ëª…ì˜ ì‚¬ìš©ì ì •ë³´ë¥¼ DBì— ë„£ê³ , ì—…ê·¸ë ˆì´ë“œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë‹¤ê°€ ì¤‘ê°„ì—ì„œ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.
  * ê·¸ë¦¬ê³  ì˜ˆì™¸ê°€ ë°œìƒí•˜ê¸° ì „ì˜ ì‚¬ìš©ì ì •ë³´ê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸.
    * ë§Œì•½ ë³€ê²½ë˜ì—ˆë‹¤ë©´ í…ŒìŠ¤íŠ¸ëŠ” ì‹¤íŒ¨
    * ë³€ê²½ë˜ì§€ ì•Šê³  ë¡¤ë°±ë˜ì—ˆë‹¤ë©´ í…ŒìŠ¤íŠ¸ëŠ” ì„±ê³µ

#### UserService í…ŒìŠ¤íŠ¸

ğŸ™‹â€â™‚ï¸ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ `UserService` ì˜ ë¡œì§ì„ ë³€ê²½í•  ìˆ˜ ì—†ìœ¼ë‹ˆ í…ŒìŠ¤íŠ¸ ì½”ë“œì•ˆì— ìƒì†ì„ í†µí•´ `TestUserService` ê°ì²´ë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ì¤€ë‹¤.

* ìš°ì„  `RuntimeException` ì„ ìƒì†ë°›ì€ `TestUserServiceException` ì˜ˆì™¸ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.
* `UserService` í…ŒìŠ¤íŠ¸ ì½”ë“œ ì•ˆì— `TestUserService` ë¥¼ í•˜ë‚˜ ë§Œë“¤ì–´ì¤€ë‹¤.

```java
class TestUserService extends UserService{

    private String id;
    
    public TestUserService(String id) {
        this.id = id;
    }

    @Override
    protected void upgradeLevel(User user) {
        if(user.getId().equals(this.id))
            throw new TestUserServiceException();
        super.upgradeLevel(user);
    }
}
```



#### ê°•ì œ ì˜ˆì™¸ ë°œìƒì„ í†µí•œ í…ŒìŠ¤íŠ¸

ğŸ™‹â€â™‚ï¸ í…ŒìŠ¤íŠ¸ì˜ ëª©ì ì€ ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œë¥¼ ì‹œë„í•˜ë‹¤ê°€ ì¤‘ê°„ì— ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ê²½ìš°, ê·¸ ì „ì— ì—…ê·¸ë ˆì´ë“œí–ˆë–¤ ì‚¬ìš©ìë„ ë‹¤ì‹œ ì›ë˜ ìƒíƒœë¡œ ëŒì•„ê°€ëŠ” ê²ƒì„ í™•ì¸í•˜ëŠ” ê²ƒì´ë‹¤.

```java
@Test
void upgradeAllOrNothing(){
    // 4ë²ˆì§¸ Userì˜ ë ˆë²¨ì„ ì—…ê·¸ë ˆë“œí•˜ëŠ” ë„ì¤‘ ì˜ˆì™¸ë¥¼ ë°œìƒ
    UserService testUserSerivce = new TestUserService(users.get(3).getId());
    testUserSerivce.setUserDao(this.userDao); // ìˆ˜ë™ DI

    userDao.deleteAll();
    for(User user : users)
        userDao.add(user);

    // TestUserServiceëŠ” ì—…ê·¸ë ˆì´ë“œ ì‘ì—… ì¤‘ì— ì˜ˆì™¸ê°€ ë°œìƒí•´ì•¼ í•œë‹¤.
    assertThrows(TestUserServiceException.class, () -> {testUserSerivce.upgradeLevels();});

  	// ë¡¤ë°± í…ŒìŠ¤íŠ¸
    checkLevelUpgraded(users.get(1), false);
}
// ê²°ê³¼ (ë¡¤ë°± ì‹¤íŒ¨)
org.opentest4j.AssertionFailedError: 
Expected :BASIC
Actual   :SILVER
```

* ì˜ˆì™¸ í…ŒìŠ¤íŠ¸
  
  * `assertThrows` ë¥¼ í†µí•´ ì˜ˆì™¸ê°€ ì˜ ë°œìƒí–ˆëŠ”ì§€ í…ŒìŠ¤íŠ¸í•œë‹¤.
* ë¡¤ë°± í…ŒìŠ¤íŠ¸
  * `checkLevelUpgraded` ë¥¼ í†µí•´ ë ˆë²¨ ë³€ê²½ì´ ìˆì—ˆë˜ ì‚¬ìš©ìì˜ ë ˆë²¨ì´ ì²˜ìŒ ìƒíƒœë¡œ ë°”ë€Œì—ˆë‚˜ í™•ì¸í•œë‹¤.

  

ğŸ™‹â€â™‚ï¸ **í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ì˜ ì´ìœ ëŠ” íŠ¸ëœì­ì…˜ì˜ ë¡¤ë°±ì´ ì•ˆë˜ì„œì´ë‹¤.**

[UserService í…ŒìŠ¤íŠ¸ì˜  ì „ì²´ ì½”ë“œ]()



### 2-2 íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •

ğŸ™‹â€â™‚ï¸ íŠ¸ëœì­ì…˜ì˜ ë™ì‘

* ì»¤ë°‹ : ì—¬ëŸ¬ ê°œì˜ SQLì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²½ìš° ëª¨ë“  SQL ìˆ˜í–‰ ì‘ì—…ì´ ë‹¤ ì„±ê³µí•˜ê³  ì‘ì—…ì„ í™•ì •ì‹œí‚¤ëŠ” ë™ì‘.
* ë¡¤ë°± : ì—¬ëŸ¬ ê°œì˜ SQLì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë„ì¤‘ì— ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ëª¨ë“  SQLì˜ ì‘ì—…ì„ ì·¨ì†Œí•˜ëŠ” ë™ì‘.



#### JDBC íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì •

ğŸ™‹â€â™‚ï¸ ë¡œì»¬ íŠ¸ëœì­ì…˜ ê²½ê³„

![image-20200917214651003](./image/image-20200917214651003.png)

* íŠ¸ëœì­ì…˜ì˜ ì‹œì‘ê³¼ ì¢…ë£ŒëŠ” `JDBC Connection` ì„ í†µí•´ ì´ë£¨ì–´ì§„ë‹¤.
  * JDBCì˜ ê¸°ë³¸ì„¤ì •ì€ ì˜¤í† ì»¤ë°‹ì´ ì¼œì ¸ìˆë‹¤.(`true`)
* íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ëŠ” ë°©ë²•ì€ í•œ ê°€ì§€ì§€ë§Œ ëë‚˜ëŠ” ë°©ë²•ì€ ë‘ ê°€ì§€ë‹¤.
  * íŠ¸ëœì­ì…˜ì˜ ì‹œì‘
    * ì˜¤í†  ì»¤ë°‹ì„ `false` ë¡œ í˜¸ì¶œ
  * íŠ¸ëœì­ì…˜ì˜ ì¢…ë£Œ
    * ì»¤ë°‹ : `con.commit()`
    * ë¡¤ë°± : `con.rollback()`



#### íŠ¸ëœì­ì…˜ì˜ ë¡œì§

![image-20200917224721389](./image/image-20200917224721389.png)

* ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(`Service`)ì—ì„œ íŠ¸ëœì­ì…˜ì˜ ì‹œì‘ê³¼ ì¢…ë£Œë¥¼ ë‹´ë‹¹.
  * **ì—¬ëŸ¬ SQLë¬¸ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ë¡œ ë¬¶ìœ¼ë¥´ë©´ í•˜ë‚˜ì˜ `Connection` ê°ì²´ ì•ˆì—ì„œ ì‹¤í–‰ë˜ì•¼ í•œë‹¤.**
* ë°ì´í„° ì•¡ì„¸ìŠ¤ ë¡œì§ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ìš”ì²­ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ë„˜ê²¨ì¤€ `Connection`ì„ ì‚¬ìš©í•˜ì—¬ SQLì„ ì‹¤í–‰í•œë‹¤.
  * íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë©´ ë™ê¸°í™” ì €ì¥ì†Œì—ì„œ `Connection` ì„ ì°¾ëŠ”ë‹¤.



#### íŠ¸ëœì­ì…˜ì´ ì½”ë“œì— ê°€ì ¸ì˜¤ëŠ” ë¬¸ì œ

ğŸ™‹â€â™‚ï¸ íŠ¸ëœì­ì…˜ì€ `DAO` ê°€ ì•„ë‹Œ `Service` (ë¹„ì¦ˆë‹ˆìŠ¤)ë¡œì§ì— í•´ë‹¹í•˜ëŠ” ì‘ì—…ì´ë‹¤.

íŠ¸ëœì­ì…˜ì´ ì½”ë“œì— ê°€ì ¸ì˜¤ëŠ” ë¬¸ì œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

1. DB ì»¤ë„¥ì…˜ì„ ë¹„ë¡¯í•œ ë¦¬ì†ŒìŠ¤ì˜ ê¹”ë”í•œ ì²˜ë¦¬ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•œ `JdbcTemplate`ì„ ë”ì´ìƒ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.

   * `UserService`ì—ì„œ `Connection` ì„ ë§Œë“¤ì–´ `DAO` ì—ê²Œ ë„˜ê¸°ë¯€ë¡œ, `JdbcTemplate`ì€ ë”ì´ìƒ ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥í•´ì§„ë‹¤.

   * ê·¸ë ‡ê²Œë˜ë©´ ì´ë²ˆì—”  `UserService` ì—  `try... catch` ì§€ì˜¥ì´ ì¬ë°œí•œë‹¤...

2. `DAO` ì˜ ë©”ì„œë“œì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— `Connection` íŒŒë¼ë¯¸í„°ë¥¼ ëª¨ë‘ ë§Œë“¤ì–´ì¤˜ì•¼í•œë‹¤.
* `UserService` ì˜ ë©”ì„œë“œë§ˆë‹¤ `Connection` ì„ ë§Œë“¤ê³  ëª¨ë‘ ë„˜ê²¨ì¤˜ì•¼í•œë‹¤.
   
3. `Connection` íŒŒë¼ë¯¸í„°ê°€ `UserDao` ì¸í„°í˜ì´ìŠ¤ ë©”ì„œë“œì— ì¶”ê°€ë˜ë©´ `UserDao` ëŠ” ë” ì´ìƒ ë°ì´í„° ì•¡ì„¸ìŠ¤ ê¸°ìˆ ì— ë…ë¦½ì ì¼ ìˆ˜ê°€ ì—†ë‹¤.

   * `JPA` ë‚˜ í•˜ì´ë²„ë„¤í‹°ëŠ” `Connection` ì´ ì•„ë‹Œ `EntityManager` ë¥¼ ì“°ê¸° ë•Œë¬¸.
     * `add(User user)` -> `add(Connection con, User user)` (ë¬¸ì œ!!)

4. `DAO` ë©”ì„œë“œì— `Connection` íŒŒë¼ë¯¸í„°ë¥¼ ë°›ê²Œ í•˜ë©´ í…ŒìŠ¤íŠ¸ ì½”ë“œì—ë„ ì˜í–¥ì„ ë¼ì¹œë‹¤.



### 2-3 íŠ¸ëœì­ì…˜ ë™ê¸°í™”

ğŸ™‹â€â™‚ï¸ **JDBC íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì¸í•œ ì½”ë“œê°€ ë³µì¡í•´ì§€ëŠ” ë¬¸ì œì **ì„ í•´ê²°í•˜ëŠ” ë°©ë²•ì€ **ë™ê¸°í™”**ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤.

* ìŠ¤í”„ë§ì€ ë…ë¦½ì ì¸ **íŠ¸ëœì­ì…˜ ë™ê¸°í™”**ì„ ì§€ì›í•œë‹¤.



ğŸ¤”  **íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë€**

* `UserService`ì—ì„œ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ê¸° ìœ„í•´ ë§Œë“  `Connection` ê°ì²´ë¥¼ íŠ¹ë³„í•œ ì €ì¥ì†Œì— ë³´ê´€í•´ë‘ê³ 
* ì´í›„ì— í˜¸ì¶œë˜ëŠ” `DAO`ì˜ ë©”ì„œë“œì—ì„œ ì €ì¥ëœ `Connection` ì„ ê°€ì ¸ë‹¤ê°€ ì‚¬ìš©í•˜ê²Œ í•˜ëŠ” ê²ƒì´ë‹¤.



#### íŠ¸ëœì­ì…˜ ë™ê¸°í™”ì˜ ì‘ì—… íë¦„

![IMG_B78D4500B275-1](./image/IMG_B78D4500B275-1.jpeg)

<center>ì¶œì²˜ : í† ë¹„ì˜ ìŠ¤í”„ë§ vol.1 p.361</center>

1. `UserService`ëŠ” `Connection` ì„ ìƒì„±í•˜ê³ 
2. ì´ë¥¼ íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ì†Œì— ì €ì¥í•´ë‘ê³  ì˜¤í† ì»¤ë°‹ì„ `false` ë¥¼ í•˜ëŠ” ë™ì‹œì— íŠ¸ëœì­ì…˜ì„ ì‹œì‘ì‹œí‚¨ë‹¤.
3. `DAO`ì˜ ì²«ë²ˆì§¸ `update()` ë¥¼ í˜¸ì¶œë˜ê³ , `update()` ë‚´ë¶€ì—ì„œ ì´ìš©í•˜ëŠ” `JdbcTemplate` ëŠ” ê°€ì¥ ë¨¼ì €
4. íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ì†Œì— í˜„ì¬ ì‹œì‘ëœ íŠ¸ëœì­ì…˜ì„ ê°€ì§„ `Connection`ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤. ìˆë‹¤ë©´ ê°€ì ¸ì˜¨ë‹¤.
5. ê°€ì ¸ì˜¨ `Connection`ì„ ì´ìš©í•´ SQLì„ ì‹¤í–‰í•œë‹¤. 
   * **íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ì†Œì—ì„œ DB ì»¤ë„¥ì…˜ì„ ê°€ì ¸ì™”ì„ ë•ŒëŠ” `JdbcTemplate`ê°€ `Connection.close()`í•˜ì§€ ì•ŠëŠ”ë‹¤.**
6. ë‘ë²ˆì§¸ `update()` ê°€ í˜¸ì¶œë˜ë©´ ë§ˆì°¬ê°€ì§€ë¡œ
7. íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ì†Œì—ì„œ `Connection` ì„ ê°€ì ¸ì™€
8. ì‚¬ìš©í•œë‹¤
9. ë§ˆì§€ë§‰ `update()` ë„
10. ê°™ì€ `Connection` ì„ ê°€ì ¸ì™€
11. ì‚¬ìš©í•œë‹¤.
12. íŠ¸ëœì­ì…˜ì˜ ëª¨ë“  ì‘ì—…ì´ ì •ìƒì ìœ¼ë¡œ ëë‚˜ë©´ ì´ì œ `Connection` ì˜ `commit()`ì„ í˜¸ì¶œí•´ì„œ íŠ¸ëœì­ì…˜ì„ ì™„ë£Œì‹œí‚¨ë‹¤.
13. ë§ˆì§€ë§‰ìœ¼ë¡œ íŠ¸ëœì­ì…˜ ì €ì¥ì†Œì—ì„œ `Connection` ê°ì²´ë¥¼ ì œê±°í•œë‹¤.

> **íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì €ì¥ì†ŒëŠ” ì‘ì—… ìŠ¤ë ˆë“œë§ˆë‹¤ ë…ë¦½ì ìœ¼ë¡œ `Connection` ê°ì²´ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ê¸° ë•Œë¬¸ì— ë‹¤ì¤‘ ì‚¬ìš©ìë¥¼ ì²˜ë¦¬í•˜ëŠ” ì„œë²„ì˜ ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œë„ ì¶©ëŒ ë‚  ì—¼ë ¤ê°€ ì—†ë‹¤.**



#### íŠ¸ëœì­ì…˜ ë™ê¸°í™” ì ìš©

ğŸ™‹â€â™‚ï¸ `JdbcTemplate`ì€ íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì§€ì›í•˜ëŠ” ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œë¥¼ ì œê³µí•œë‹¤.

```java
public class UserService {
		...
    private DataSource dataSource;

    @Autowired
    public void setDataSource(DataSource dataSource) {
        this.dataSource = dataSource;
    }

    public void upgradeLevels() throws SQLException {
        // íŠ¸ëœì­ì…˜ ë™ê¸°í™” ê´€ë¦¬ìë¥¼ ì´ìš©í•´ ë™ê¸°í™” ì‘ì—…ì„ ì´ˆê¸°í™”í•œë‹¤.
        TransactionSynchronizationManager.initSynchronization();
        // DB ì»¤ë„¥ì…˜ì„ ìƒì„±í•˜ê³  íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•œë‹¤.
        Connection con = DataSourceUtils.getConnection(dataSource);
        con.setAutoCommit(false);

        try {
            List<User> users = userDao.getAll();
            for(User user : users){
                if(canUpgradeLevel(user)){
                    upgradeLevel(user);
                }
            }
            con.commit();
        } catch (Exception e){
            con.rollback();
            throw e;
        } finally {
            // ìŠ¤í”„ë§ ìœ í‹¸ë¦¬ì§€ ë©”ì„œë“œë¥¼ ì´ìš©í•´ DB ì»¤ë„¥ì…˜ì„ ì•ˆì „í•˜ê²Œ ë‹«ëŠ”ë‹¤.
            DataSourceUtils.releaseConnection(con, dataSource);
            // ë™ê¸°í™” ì‘ì—… ì¢…ë£Œ ë° ì •ë¦¬
            TransactionSynchronizationManager.unbindResource(this.dataSource);
            TransactionSynchronizationManager.clearSynchronization();
        }
    }
  	...
}
```



#### íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸ ë³´ì™„

ğŸ™‹â€â™‚ï¸ [íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸ ì½”ë“œ](#ê°•ì œ-ì˜ˆì™¸-ë°œìƒì„-í†µí•œ-í…ŒìŠ¤íŠ¸)ì„ ë™ê¸°í™”ì— ë§ì¶° ë³€ê²½í•´ì¤€ë‹¤.

```java
@Autowired DataSource dataSource;
...
  
@Test
public void upgradeAllOrNothing() throws Exception {
  UserService testUserService = new TestUserService(users.get(3).getId());
  testUserService.setUserDao(this.userDao);
  testUserService.setDataSource(this.dataSource);
  ...
}
```



#### JdbcTemplateì™€ íŠ¸ëœì­ì…˜ ë™ê¸°í™”

ğŸ™‹â€â™‚ï¸ `JdbcTemplate`ì˜ ë™ì‘

* íŠ¸ëœì­ì…˜ ì €ì¥ì†Œì— `Connection`ì´ ìˆëŠ” ê²½ìš° && íŠ¸ëœì­ì…˜ ë™ê¸°í™”ë¥¼ ì‹œì‘í•´ë†“ìœ¼ë©´
  * ì´ë¯¸ ì‹œì‘ëœ íŠ¸ëœì­ì…˜ì— ì°¸ì—¬ë§Œ í•œë‹¤. ìƒì„±, ì¢…ë£Œì—” ì¼ì ˆ ê´€ë ¤í•˜ì§€ ì•ŠëŠ”ë‹¤.
* íŠ¸ëœì­ì…˜ ì €ì¥ì†Œì— `Connection`ì´ ì—†ëŠ” ê²½ìš°
  * ì§ì ‘ `Connection`ì„ ìƒì„±í•˜ê³  ì¢…ë£Œí•˜ëŠ” ì¼ì„ ëª¨ë‘ ë‹´ë‹¹í•œë‹¤.



### 2-4 ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

ğŸ™‹â€â™‚ï¸ íŠ¸ëœì­ì…˜ì˜ ì¢…ë¥˜

* ë¡œì»¬ íŠ¸ëœì­ì…˜
  * í•˜ë‚˜ì˜ DBë¡œ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ë§Œì„ ë™ì‘
    * ë¡œì»¬ì€ í•˜ë‚˜ì˜ DB Connectionì— ì¢…ì†ì ì´ë‹¤.
  * í•˜ë‚˜ì˜ DB
* ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜
  * í•œ ê°œ ì´ìƒì˜ DBë¡œì˜ ì‘ì—…ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë™ì‘
  * í•œ ê°œ ì´ìƒì˜ DB



#### JTA

ğŸ¤” JTA

* Java Transaction API
* **ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜**ì„ ì§€ì›í•˜ëŠ” íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ ì§€ì›í•˜ê¸° ìœ„í•œ **API**
* **JTA**ë¥¼ ì´ìš©í•´ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ë¥¼ í™œìš©í•˜ë©´ **ì—¬ëŸ¬ ê°œì˜ DBë‚˜ ë©”ì‹œì§• ì„œë²„ì— ëŒ€í•œ ì‘ì—…ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ í†µí•©**í•˜ëŠ” ë¶„ì‚° íŠ¸ëœì­ì…˜ ë˜ëŠ” ê¸€ë¡œë²Œ íŠ¸ëœì­ì…˜ì´ ê°€ëŠ¥í•˜ë‹¤.
  * **ë‹¨, íŠ¸ëœì­ì…˜ì€ JDBCë‚˜ JMS APIë¥¼ ì‚¬ìš©í•´ì„œ ì§ì ‘ ì œì–´í•˜ì§€ ì•Šê³  JTAë¥¼ í†µí•´ íŠ¸ëœì­ì…˜ ë§¤ë‹ˆì €ê°€ ê´€ë¦¬í•˜ë„ë¡ ìœ„ì„í•œë‹¤.**

<img src="./image/IMG_9A68A68B305C-1.jpeg" width="600" />

<center>ì¶œì²˜ : í† ë¹„ì˜ ìŠ¤í”„ë§ vol.1 p.367</center>



#### íŠ¸ëœì­ì…˜ APIì˜ ì˜ì¡´ê´€ê³„ ë¬¸ì œì™€ í•´ê²°ì±…

:scream:  `Service` ì—ì„œ íŠ¸ëœì­ì…˜ ì¢…ë¥˜ì™€ `DAO` ì˜ êµ¬í˜„ì²´ì˜ ë”°ë¼ íŠ¹ì • `DAO` ì— ì¢…ì†ì ì¸ êµ¬ì¡°ê°€ ëœë‹¤.

![image-20200921002213881](./image/image-20200921002213881.png)

* **ë¡œì»¬ íŠ¸ëœì­ì…˜ì„ ì‚¬ìš©í•˜ë‹¤ê°€ JTAë¡œ ë³€ê²½ì„ í•œë‹¤ë©´ `Service` ì˜ ì½”ë“œë¥¼ ë³€ê²½í•´ì•¼ í•œë‹¤.** ë˜í•œ, ë§Œì•½ JPAë¡œ `DAO` ë¥¼ ë³€ê²½í•œë‹¤ë©´ `Service` ì˜ íŠ¸ëœì­ì…˜ ì½”ë“œëŠ” ë˜ ë³€ê²½ë  ê²ƒì´ë‹¤. 

* **ì¦‰, `Service` ëŠ” `DAO` ì˜ ì¢…ë¥˜ì— ë”°ë¼ì„œ íŠ¸ëœì­ì…˜ ì½”ë“œê°€ ì˜ì¡´ì ì´ê²Œ ëœë‹¤.**

> ê¸°ì¡´ì—” `UserDao` ì¸í„°í˜ì´ìŠ¤ì—ë§Œ ì˜ì¡´ì ì´ì˜€ìœ¼ë‚˜, íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì¸í•´ êµ¬í˜„ì²´ì— ì˜ì¡´ì ì´ê²Œ ë˜ì–´ë²„ë¦° ê²ƒì´ë‹¤.



ğŸ¤”  **ê°ê¸° ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ êµ¬í˜„ ë°©ì‹ìœ¼ë¡œë¶€í„°  `Service` ì™€ `DAO` ë¥¼ ë…ë¦½í•˜ëŠ” ë°©ë²•ì€ ë¬´ì—‡ì¼ê¹Œ?**

* íŠ¸ëœì­ì…˜ì˜ ê²½ê³„ì„¤ì •ì„ ë‹´ë‹¹í•˜ëŠ” ì½”ë“œëŠ” ì¼ì •í•œ íŒ¨í„´ì„ ê°–ëŠ” ìœ ì‚¬í•œ êµ¬ì¡°ì´ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ **ì´ë“¤ì˜ ê³µí†µì ì„ ì¶”ìƒí™” ì‹œí‚¤ë©´ ëœë‹¤.**
* `JDBC`, `JTA`, `Hibernate`, `JPA` ë“±ì˜ ê³µí†µì ì¸ íŠ¹ì§•ì„ ëª¨ì•„ ì¶”ìƒí™”ëœ **íŠ¸ëœì­ì…˜ ê´€ë¦¬ ê³„ì¸µ**ì„ ë§Œë“œëŠ” ê²ƒì´ë‹¤.
  * ê·¸ë¦¬ê³  `Service` ì—ì„œëŠ” íŠ¸ëœì­ì…˜ ì¶”ìƒ ê³„ì¸µì´ ì œê³µí•˜ëŠ” APIë¥¼ ì´ìš©í•´ íŠ¸ëœì­ì…˜ì„ ì´ìš©í•˜ê²Œ ë§Œë“¤ì–´ì¤€ë‹¤ë©´ íŠ¹ì • ê¸°ìˆ ì— ì¢…ì†ë˜ì§€ ì•ŠëŠ”ë‹¤.



#### ìŠ¤í”„ë§ì˜ íŠ¸ëœì­ì…˜ ì„œë¹„ìŠ¤ ì¶”ìƒí™”

**ìŠ¤í”„ë§ì€ íŠ¸ëœì­ì…˜ ê¸°ìˆ ì˜ ê³µí†µì ì„ ë‹´ì€ íŠ¸ëœì­ì…˜ ì¶”ìƒí™” ê¸°ìˆ ì„ ì œê³µí•˜ê³  ìˆë‹¤.**

ì´ëŠ” ê° ê¸°ìˆ ì˜ íŠ¸ëœì­ì…˜ APIë¥¼ ì´ìš©í•˜ì§€ ì•Šê³ ë„, ì¼ê´€ëœ ë°©ì‹ìœ¼ë¡œ íŠ¸ëœì­ì…˜ì„ ì œì–´í•˜ëŠ” íŠ¸ëœì­ì…˜ ê²½ê³„ì„¤ì • ì‘ì—…ì´ ê°€ëŠ¥í•´ì§„ë‹¤.

![image-20200921003614120](./image/image-20200921003614120.png)

* **ìŠ¤í”„ë§ì´ ì œê³µí•˜ëŠ” íŠ¸ëœì­ì…˜ ì¶”ìƒ ì¸í„°í˜ì´ìŠ¤ëŠ” `PlatformTransactionManager` ë‹¤!**

```java
public void upgradeLevels() {
  PlatformTransactionManager transactionManager = 
    new DataSourceTransactionManager(dataSourse); // JDBC íŠ¸ëœì­ì…˜ ì¶”ìƒ ê°ì²´ ìƒì„±
  
  TransactionStatus status = 
    transactionManager.getTransaction(new DefaultTransactionDefinition());
  
  try {
    ... íŠ¸ëœì­ì…˜ ì‘ì—…
      
    transactionManager.commit(status); // ì»¤ë°‹
  } catch (RuntimeException e){
    transactionManager.rollback(status); // ë¡¤ë°±
    throw e;
  }
}
```

* `JDBC` ì˜ ë¡œì»¬ íŠ¸ëœì­ì…˜ì„ ì´ìš©í•œë‹¤ë©´
  * **`PlatfromTransactionManager` ë¥¼ êµ¬í˜„í•œ `DataSourceTransactionManager` ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.**

> ë” ìì„¸í•œ ë‚´ìš©ì€ í† ë¹„ì˜ ìŠ¤í”„ë§ p.373









