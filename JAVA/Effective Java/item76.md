> 본 자료는 [Effective Java 3/E]()를 바탕으로 작성되었습니다.

# 아이템 76. 가능한 한 실패 원자적으로 만들라

<br>

- [아이템 76. 가능한 한 실패 원자적으로 만들라](#아이템-76-가능한-한-실패-원자적으로-만들라)
  - [실패 원자적이란?](#실패-원자적이란)
  - [메서드를 실패 원자적으로 만드는 방법](#메서드를-실패-원자적으로-만드는-방법)
  - [실패 원자성을 지키는 것은 어렵다](#실패-원자성을-지키는-것은-어렵다)

<br>

## 실패 원자적이란?
> 원자적(atomic): 어떤 것이 더 이상 쪼개질 수 없는 성질 (더 이상 나누어질 수 없는 하나의 행위)

* 실패 원자적: 호출된 메서드가 실패하더라도 해당 객체는 메서드 호출 전 상태를 유지해야 한다.
  * 비유: DB 트랜잭션 중 에러가 발생하면 롤백되어야 한다.

<br>

## 메서드를 실패 원자적으로 만드는 방법

**1. 불변 객체로 만들면 된다.**
* 불변 객체는 태생적으로 실패 원자적이다.
* 메서드가 실패하면 새로운 객체가 만들어지지는 않을 수 있으나, **기존 객체가 불안정한 상태에 빠지는 일은 결코 없다.**

<br>

**2. 작업 수행에 앞서 매개변수의 유효성을 검사하면 된다.**
* 객체의 내부 상태를 변경하기 전에 잠재적 예외의 가능성 대부분을 걸러낼 수 있는 방법이다.
* ex. TreeMap은 어떤 기준으로 원소들을 정렬한다. 만약 원소를 추가하려면 그 원소는 비교가능 타입이어야 하는데, 비교하기 전에 유효성 검사를 해서 만약 안된다면 `ClassCaseException`을 던지게 할 수 있다.

```java
public Object pop() {
    if (size == 0) { // 매개변수 유효성 검사
        throw new EmptyStackException();
    }
    Object result = elements[--size];
    elements[size] = null; // 다 쓴 참조 해제
    return result;
}
```

<br>

**3. 객체의 임시 복사본에서 작업을 수행한 다음, 작업이 성공적으로 완료되면 원래 객체와 교체하는 방법**
* 데이터를 임시 자료구조에 저장해 작업하는 게 더 빠를 때 적용하기 좋은 방법이다.

<br>

## 실패 원자성을 지키는 것은 어렵다
* 실패 원자성은 일반적으로 권장되는 덕목이지만 항상 달성 할 수 있는 것은 아니다.
  * 실패 원자성을 달성하기 위한 비용이나 복잡도가 아주 큰 연산인 경우는 사용할 수 없기도 하다.
* 물론 실패 원자성을 지키는 것이 이상적이나, 아쉽게도 지금의 API 문서 상당 부분이 잘 지키지 않고 있다.
